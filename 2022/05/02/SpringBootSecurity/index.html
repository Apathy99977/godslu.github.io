<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><title>SpringBootSecurity | Gods Blog</title><meta name="keywords" content="安全框架"><meta name="author" content="Gods"><meta name="copyright" content="Gods"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="SpringBoot安全框架：HttpBasic认证模式：这是种防君子不防小人的认证，也是最简单的一个认证模式 编写配置类： 123456789101112131415161718@Configurationpublic class SecurityConfig extends WebSecurityConfigurerAdapter &amp;#123;    &#x2F;&#x2F;进行重写    @Override">
<meta property="og:type" content="article">
<meta property="og:title" content="SpringBootSecurity">
<meta property="og:url" content="https://apathy99977.github.io/2022/05/02/SpringBootSecurity/index.html">
<meta property="og:site_name" content="Gods Blog">
<meta property="og:description" content="SpringBoot安全框架：HttpBasic认证模式：这是种防君子不防小人的认证，也是最简单的一个认证模式 编写配置类： 123456789101112131415161718@Configurationpublic class SecurityConfig extends WebSecurityConfigurerAdapter &amp;#123;    &#x2F;&#x2F;进行重写    @Override">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://s1.ax1x.com/2022/06/27/jVPNPs.jpg">
<meta property="article:published_time" content="2022-05-02T11:06:32.000Z">
<meta property="article:modified_time" content="2022-07-04T00:38:20.026Z">
<meta property="article:author" content="Gods">
<meta property="article:tag" content="安全框架">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://s1.ax1x.com/2022/06/27/jVPNPs.jpg"><link rel="shortcut icon" href="/./img/tx.jpg"><link rel="canonical" href="https://apathy99977.github.io/2022/05/02/SpringBootSecurity/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":false,"languages":{"hits_empty":"找不到您查询的内容：${query}"}},
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: true,
    post: true
  },
  runtime: '天',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: {"limitCount":50,"languages":{"author":"作者: Gods","link":"链接: ","source":"来源: Gods Blog","info":"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。"}},
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery@2/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery@2/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'SpringBootSecurity',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2022-07-04 08:38:20'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><link rel="stylesheet" href="/css/mouse.css"><link rel="stylesheet" href="APlayer.min.css"><div id="aplayer"></div><script src="https://cdn.jsdelivr.net/gh/radium-bit/res@master/live2d/autoload.js" async></script><script src="https://cdn.jsdelivr.net/npm/meting@2/dist/Meting.min.js" async></script><meta name="generator" content="Hexo 6.2.0"></head><body><div id="loading-box"><div class="loading-left-bg"></div><div class="loading-right-bg"></div><div class="spinner-box"><div class="configure-border-1"><div class="configure-core"></div></div><div class="configure-border-2"><div class="configure-core"></div></div><div class="loading-word">加载中...</div></div></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="https://s1.ax1x.com/2022/06/23/j9vtUg.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">18</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">30</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">28</div></a></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-folder-open"></i><span> 归档</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时轴</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标题</span></a></li><li><a class="site-page child" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></li></ul></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> 清单</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/artitalk/"><i class="fa-fw fa-solid fa-book"></i><span> 说说</span></a></li><li><a class="site-page child" href="/music/"><i class="fa-fw fa-solid fa-music"></i><span> 音乐</span></a></li><li><a class="site-page child" href="/album/"><i class="fa-fw fa-solid fa-image"></i><span> 相册</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fa-solid fa-video"></i><span> 电影</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/comment/"><i class="fa-fw fa-solid fa-paper-plane"></i><span> 留言板</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于笔者</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://s1.ax1x.com/2022/06/27/jVPNPs.jpg')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">Gods Blog</a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-folder-open"></i><span> 归档</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时轴</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标题</span></a></li><li><a class="site-page child" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></li></ul></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> 清单</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/artitalk/"><i class="fa-fw fa-solid fa-book"></i><span> 说说</span></a></li><li><a class="site-page child" href="/music/"><i class="fa-fw fa-solid fa-music"></i><span> 音乐</span></a></li><li><a class="site-page child" href="/album/"><i class="fa-fw fa-solid fa-image"></i><span> 相册</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fa-solid fa-video"></i><span> 电影</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/comment/"><i class="fa-fw fa-solid fa-paper-plane"></i><span> 留言板</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于笔者</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">SpringBootSecurity</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2022-05-02T11:06:32.000Z" title="发表于 2022-05-02 19:06:32">2022-05-02</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2022-07-04T00:38:20.026Z" title="更新于 2022-07-04 08:38:20">2022-07-04</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/SpringBoot-Security/">SpringBoot-Security</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">24k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>96分钟</span></span><span class="post-meta-separator">|</span><span id="" data-flag-title="SpringBootSecurity"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span class="waline-pageview-count" data-path="/2022/05/02/SpringBootSecurity/"></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="SpringBoot安全框架："><a href="#SpringBoot安全框架：" class="headerlink" title="SpringBoot安全框架："></a>SpringBoot安全框架：</h1><h2 id="HttpBasic认证模式："><a href="#HttpBasic认证模式：" class="headerlink" title="HttpBasic认证模式："></a>HttpBasic认证模式：</h2><p>这是种防君子不防小人的认证，也是最简单的一个认证模式</p>
<p>编写配置类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SecurityConfig</span> <span class="keyword">extends</span> <span class="title class_">WebSecurityConfigurerAdapter</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//进行重写</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">//开启httpBasic认证</span></span><br><span class="line">        http.httpBasic()</span><br><span class="line">                .and()</span><br><span class="line">                <span class="comment">//所有的请求</span></span><br><span class="line">                .authorizeHttpRequests()</span><br><span class="line">                <span class="comment">//匹配规则</span></span><br><span class="line">                .anyRequest()</span><br><span class="line">                <span class="comment">//所有请求都需要登录认证才可以访问</span></span><br><span class="line">                .authenticated();</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p><strong>编写好配置文件后，启动会给出一个密码：</strong></p>
<p>我们使用该密码进行登录</p>
<p>Using generated security password: 8e0f5586-f414-454b-bd96-ffc82e919a6a</p>
<p><strong>我们自己指定用户名，密码修改配置文件application：</strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8080</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">security:</span></span><br><span class="line">    <span class="comment">#配置httpBasic认证的用户名，密码</span></span><br><span class="line">    <span class="attr">user:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">admin</span></span><br><span class="line">      <span class="attr">password:</span> <span class="string">admin123</span></span><br></pre></td></tr></table></figure>



<p>启动后就不好给我们密码了，但这个密码是可以获取到的，如图：</p>
<p><img src="https://s2.loli.net/2022/03/09/Zvx8aDjWt9eLOY1.png" alt="image-20220302192907115"></p>
<p><strong>我们可以使用工具Postman获取到账户密码：</strong></p>
<p>​								登录：</p>
<p><img src="https://s2.loli.net/2022/03/09/Peuw2ZW7bDNgGcx.png" alt="image-20220303084206675"></p>
<p><strong>可以看到有给Authorization  这个是我们的账号密码使用ase64加密后的结果我们可以复制加密后的密码去解码就可以获取到账号密码了：</strong></p>
<p><img src="https://s2.loli.net/2022/03/09/zHSoTNCL1tjQf4U.png" alt="image-20220303084235403"></p>
<p><strong>解码结果：</strong></p>
<p><img src="https://s2.loli.net/2022/03/09/STXbo9kga8Ri5FH.png" alt="image-20220303091317694"></p>
<h2 id="passwrodEncoder加密"><a href="#passwrodEncoder加密" class="headerlink" title="passwrodEncoder加密"></a>passwrodEncoder加密</h2><p>passwrodEncoder加密是不可逆的</p>
<p><strong>passwrodEncoder接口：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">PasswordEncoder</span> &#123;</span><br><span class="line">    String <span class="title function_">encode</span><span class="params">(CharSequence rawPassword)</span>;   <span class="comment">//用于加密密码</span></span><br><span class="line"></span><br><span class="line">    <span class="type">boolean</span> <span class="title function_">matches</span><span class="params">(CharSequence rawPassword, String encodedPassword)</span>;  <span class="comment">//验证输入的密码是否与加密的密码一致</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">default</span> <span class="type">boolean</span> <span class="title function_">upgradeEncoding</span><span class="params">(String encodedPassword)</span> &#123;   <span class="comment">//密码是否需要被更新，有需要可以重新该方法</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<p><strong>推荐使用的实现类BCryptPasswordEncoder：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">contextLoads</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="type">BCryptPasswordEncoder</span> <span class="variable">bCryptPasswordEncoder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BCryptPasswordEncoder</span>();</span><br><span class="line">    <span class="comment">//密码加密</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">encode</span> <span class="operator">=</span> bCryptPasswordEncoder.encode(<span class="string">&quot;123hzr&quot;</span>);</span><br><span class="line">    System.out.println(<span class="string">&quot;一次加密:&quot;</span>+encode);</span><br><span class="line">    <span class="comment">//密码校验对比</span></span><br><span class="line">    <span class="type">boolean</span> <span class="variable">matches</span> <span class="operator">=</span> bCryptPasswordEncoder.matches(<span class="string">&quot;123&quot;</span>, encode);</span><br><span class="line">    System.out.println(<span class="string">&quot;密码是否正确&quot;</span>+matches);</span><br><span class="line">    <span class="comment">//密码校验对比</span></span><br><span class="line">    <span class="type">boolean</span> <span class="variable">matches1</span> <span class="operator">=</span> bCryptPasswordEncoder.matches(<span class="string">&quot;123hzr&quot;</span>, encode);</span><br><span class="line">    System.out.println(<span class="string">&quot;密码是否正确&quot;</span>+matches1);</span><br><span class="line">    <span class="comment">//同样密码加密，结果和第一加密码不一样，所以说passwrodEncoder加密是不可逆的</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">encode2</span> <span class="operator">=</span> bCryptPasswordEncoder.encode(<span class="string">&quot;123hzr&quot;</span>);</span><br><span class="line">    System.out.println(<span class="string">&quot;二次加密:&quot;</span>+encode2);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>结果</strong>：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">一次加密:$2a$10$6zuzvMqFVq89TerHtThXder6n2VqOMyJF6hpAn8ZBYjA7FaGOPzOy</span><br><span class="line">密码是否正确false</span><br><span class="line">密码是否正确true</span><br><span class="line">二次加密:$2a$10$rAznej1Fv0VGqXkXo7tKiu4c0nBwEYzVykbPfhGE9YSi25xpmTL7G</span><br></pre></td></tr></table></figure>



<p><strong>加密值解释：</strong></p>
<p>$2a  &#x2F;&#x2F;表示 BCrypt 算法版本</p>
<p>$10    &#x2F;&#x2F;表示算法强度</p>
<p>$rAznej1Fv0VGqXkXo7tK   &#x2F;&#x2F;随机生成的盐值</p>
<p>iu4c0nBwEYzVykbPfhGE9YSi25xpmTL7G  &#x2F;&#x2F;hash值</p>
<h2 id="formLogin登录认证"><a href="#formLogin登录认证" class="headerlink" title="formLogin登录认证"></a>formLogin登录认证</h2><h3 id="同样先编写配置类："><a href="#同样先编写配置类：" class="headerlink" title="同样先编写配置类："></a>同样先编写配置类：</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SecurityConfig</span> <span class="keyword">extends</span> <span class="title class_">WebSecurityConfigurerAdapter</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 登录认证方法</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> http</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    </span><br><span class="line">        <span class="comment">//开启formLogin登录认证</span></span><br><span class="line">        <span class="comment">//关闭防御csrf攻击</span></span><br><span class="line">        http.csrf().disable()</span><br><span class="line">                .formLogin()</span><br><span class="line">                .loginPage(<span class="string">&quot;/logins&quot;</span>)    <span class="comment">//用于选择登录页面，没认证时跳转的页面</span></span><br><span class="line">                .loginProcessingUrl(<span class="string">&quot;/login&quot;</span>)   <span class="comment">//选择需要认证的请求，也就是登录表单的提交地址</span></span><br><span class="line">                .usernameParameter(<span class="string">&quot;user&quot;</span>)   <span class="comment">//选择登录请求的哪个参数是用户名</span></span><br><span class="line">                .passwordParameter(<span class="string">&quot;password&quot;</span>)   <span class="comment">//选择登录请求的哪个参数是密码</span></span><br><span class="line">                .defaultSuccessUrl(<span class="string">&quot;/&quot;</span>)   <span class="comment">//登录成功跳转的路径</span></span><br><span class="line">                .failureForwardUrl(<span class="string">&quot;/logins&quot;</span>)  <span class="comment">//登录失败跳转的路径</span></span><br><span class="line">             .and()</span><br><span class="line">                .authorizeRequests() <span class="comment">//自定义过滤拦截请求</span></span><br><span class="line">                .antMatchers(<span class="string">&quot;/logins&quot;</span>,<span class="string">&quot;/login&quot;</span>) <span class="comment">//资源路径</span></span><br><span class="line">                .permitAll()  <span class="comment">//当前资源路径不需要认证就可以访问</span></span><br><span class="line">                .antMatchers(<span class="string">&quot;/business1&quot;</span>,<span class="string">&quot;/business2&quot;</span>,<span class="string">&quot;/&quot;</span>)<span class="comment">//资源路径</span></span><br><span class="line">                .hasAnyAuthority(<span class="string">&quot;ROLE_user&quot;</span>,<span class="string">&quot;ROLE_admin&quot;</span>)<span class="comment">//设置可以访问的角色,user角色和admin角色都可以访问</span></span><br><span class="line"></span><br><span class="line">                    <span class="comment">//访问角色控制方式1  与授权方法1一起使用</span></span><br><span class="line">                .antMatchers(<span class="string">&quot;/log&quot;</span>,<span class="string">&quot;/user&quot;</span>)<span class="comment">//资源路径</span></span><br><span class="line">                .hasRole(<span class="string">&quot;admin&quot;</span>)<span class="comment">//设置可以访问的角色，和hasAnyAuthority作用相同，但hasAnyAuthority可以设置多个，并且需要加前缀ROLE_</span></span><br><span class="line"></span><br><span class="line">                    <span class="comment">//访问角色控制方式2  与授权方法2一起使用  这里由于它不是admin角色了，所有访问业务1业务2访问不了但可以修改一下</span></span><br><span class="line"><span class="comment">//                .antMatchers(&quot;/user&quot;).hasAnyAuthority(&quot;sys:user&quot;)  // /user资源路径 必须拥有sys:user角色才可访问</span></span><br><span class="line"><span class="comment">//                .antMatchers(&quot;/log&quot;).hasAnyAuthority(&quot;sys:log&quot;) // /log资源路径 必须拥有sys:log角色才可访问</span></span><br><span class="line"></span><br><span class="line">                <span class="comment">//选择的匹配规则</span></span><br><span class="line">                .anyRequest()</span><br><span class="line">                <span class="comment">//所有请求都需要登录认证才可以访问</span></span><br><span class="line">                .authenticated();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//.authorizeHttpRequests()   这样方法表示选中的请求</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 授权方法</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> auth</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(AuthenticationManagerBuilder auth)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">                auth  <span class="comment">//授权</span></span><br><span class="line">                .inMemoryAuthentication()  <span class="comment">//将这种用户添加到内存中登录认证，   还有其他类型的授权登录认证方法，比如数据库的登录认证</span></span><br><span class="line">                .withUser(<span class="string">&quot;user&quot;</span>)  <span class="comment">//用户名</span></span><br><span class="line">                .password(passwordEncoder().encode(<span class="string">&quot;123456&quot;</span>))  <span class="comment">//密码</span></span><br><span class="line">                .roles(<span class="string">&quot;user&quot;</span>)  <span class="comment">//设置使用该用户名登录赋予的角色，</span></span><br><span class="line">            .and()</span><br><span class="line">                 .withUser(<span class="string">&quot;admin&quot;</span>) <span class="comment">//用户名</span></span><br><span class="line">                 .password(passwordEncoder().encode(<span class="string">&quot;123456&quot;</span>))</span><br><span class="line">                   <span class="comment">//第一种授权方式</span></span><br><span class="line">                 .roles(<span class="string">&quot;admin&quot;</span>)  <span class="comment">//设置使用该账号登录赋予的角色</span></span><br><span class="line">                   <span class="comment">//第二种授权方式</span></span><br><span class="line">                 <span class="comment">//.authorities(&quot;sys:log&quot;,&quot;sys:user&quot;) //为当前用户赋予角色</span></span><br><span class="line">            .and()</span><br><span class="line">                  .passwordEncoder(passwordEncoder());  <span class="comment">//配置BCrypt加密，这个会自动调用matches（）这个方法来为我们输入的密码进行对比</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	*加密方式</span></span><br><span class="line"><span class="comment">	*/</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> PasswordEncoder <span class="title function_">passwordEncoder</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">BCryptPasswordEncoder</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 静态资源路径开放</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> web</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(WebSecurity web)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">//将项目中的静态资源路径开放出来，在这开放是不需要经过过滤器拦截的</span></span><br><span class="line">        web.ignoring().antMatchers(<span class="string">&quot;/css/**&quot;</span>,<span class="string">&quot;/fonts/**&quot;</span>,<span class="string">&quot;/img/**&quot;</span>,<span class="string">&quot;/js/**&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>





<h3 id="controller类："><a href="#controller类：" class="headerlink" title="controller类："></a>controller类：</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">indexController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(&#123;&quot;/&quot;&#125;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">login</span><span class="params">()</span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;index&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/logins&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">index</span><span class="params">()</span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;login&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/user&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">user</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;user&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/log&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">log</span><span class="params">()</span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;log&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/business1&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">business1</span><span class="params">()</span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;business1&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/business2&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">business2</span><span class="params">()</span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;business2&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>







<h2 id="自定义登录验证处理："><a href="#自定义登录验证处理：" class="headerlink" title="自定义登录验证处理："></a><strong>自定义登录验证处理：</strong></h2><p>这里我们需要了解一下</p>
<p><img src="https://s2.loli.net/2022/03/09/DqCRLYV6WyMAa9Q.png" alt="image-20220304105306887"></p>
<p>这两类，第一个是登录成功后的处理方式，第二给是登录失败的处理方式，我们需要重新它</p>
<p><strong>AuthenticationFailureHandler  登录失败重写：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 登录失败后进行的操作</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyAuthenticationFailureHandler</span></span><br><span class="line">	<span class="comment">//SimpleUrlAuthenticationFailureHandle 是AuthenticationFailureHandler的一个实现类</span></span><br><span class="line">    <span class="keyword">extends</span> <span class="title class_">SimpleUrlAuthenticationFailureHandler</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//注意这个一定要使用el表达式，否则这个方法都不会进  ；这个是配置文件中自定义的参数，值为JSON</span></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;spring.security.loginType&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String loginType;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">ObjectMapper</span> <span class="variable">objectMapper</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectMapper</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 登录失败后进行操作</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> request 请求</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> response 响应</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> exception  异常</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> IOException</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> ServletException</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onAuthenticationFailure</span><span class="params">(HttpServletRequest request, HttpServletResponse response, AuthenticationException exception)</span> <span class="keyword">throws</span> IOException, ServletException &#123;</span><br><span class="line">        <span class="comment">//判断要返回的类型</span></span><br><span class="line">        <span class="keyword">if</span> (loginType.equalsIgnoreCase(<span class="string">&quot;JSON&quot;</span>))&#123;</span><br><span class="line">            <span class="comment">//告诉浏览器，以json返回</span></span><br><span class="line">            response.setContentType(<span class="string">&quot;application/json;charset=UTF-8&quot;</span>);</span><br><span class="line">            <span class="comment">//要返回的数据  这里的JsonResult只是单纯的一个返回json信息格式的类</span></span><br><span class="line">            response.getWriter().write(objectMapper.writeValueAsString(<span class="keyword">new</span> <span class="title class_">JsonResult</span>&lt;&gt;().InputError()));</span><br><span class="line">        &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">//登录失败后进行的页面跳转，父类已经为我们实现了</span></span><br><span class="line">            response.setContentType(<span class="string">&quot;application/html;charset=UTF-8&quot;</span>);</span><br><span class="line">            <span class="built_in">super</span>.onAuthenticationFailure(request, response, exception);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<p> <strong>AuthenticationSuccessHandler 登录成功重新:</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 配置登录成功后需要的操作</span></span><br><span class="line"><span class="comment"> * 实现AuthenticationSuccessHandler登录成功进行的操作</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyAuthenticationSuccessHandler</span></span><br><span class="line">    <span class="comment">//SavedRequestAwareAuthenticationSuccessHandler 继承该类，该类实现了AuthenticationSuccessHandler登录成功进行的操作</span></span><br><span class="line">    <span class="comment">//这个类中有帮我们实现一些有用的方法，比如说记住用户上一次的操作，登录后跳转的页面就是用户上一次未能进入的页面，而不是首页</span></span><br><span class="line">    <span class="keyword">extends</span> <span class="title class_">SavedRequestAwareAuthenticationSuccessHandler</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//注意这个一定要使用el表达式，否则这个方法都不会进  ；这个是配置文件中自定义的参数，值为JSON</span></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;spring.security.loginType&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String loginType;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">ObjectMapper</span> <span class="variable">objectMapper</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectMapper</span>();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 这个方法是登录成功后执行的</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> request  请求</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> response  响应</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> authentication</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> ServletException</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> IOException</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onAuthenticationSuccess</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Authentication authentication)</span> <span class="keyword">throws</span> ServletException, IOException &#123;</span><br><span class="line">        <span class="comment">//判断要返回的类型</span></span><br><span class="line">        <span class="keyword">if</span> (loginType.equalsIgnoreCase(<span class="string">&quot;JSON&quot;</span>))&#123;</span><br><span class="line">            <span class="comment">//告诉浏览器，以json返回</span></span><br><span class="line">            response.setContentType(<span class="string">&quot;application/json;charset=UTF-8&quot;</span>);</span><br><span class="line">            <span class="comment">//要返回的数据</span></span><br><span class="line">            response.getWriter().write(objectMapper.writeValueAsString(<span class="keyword">new</span> <span class="title class_">JsonResult</span>().success()));</span><br><span class="line">        &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">//会帮助我们跳转到上一次请求的页面 ,这个方法也就是我们重新的这个方法</span></span><br><span class="line">            response.setContentType(<span class="string">&quot;application/html;charset=UTF-8&quot;</span>);</span><br><span class="line">            <span class="built_in">super</span>.onAuthenticationSuccess(request,response,authentication);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<p><strong>Security配置类：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SecurityConfig</span> <span class="keyword">extends</span> <span class="title class_">WebSecurityConfigurerAdapter</span> &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//将我们自定义的这两个类使用IOC容器装配</span></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> MyAuthenticationSuccessHandler myAuthenticationSuccessHandler;  <span class="comment">//登录成功处理</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> MyAuthenticationFailureHandler myAuthenticationFailureHandler;  <span class="comment">//登录失败处理</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 登录认证方法</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> http</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//开启formLogin登录认证</span></span><br><span class="line">        <span class="comment">//关闭防御csrf攻击</span></span><br><span class="line">        http.csrf().disable()</span><br><span class="line">                .formLogin()<span class="comment">//开启formLogin登录认证</span></span><br><span class="line">                .loginPage(<span class="string">&quot;/logins&quot;</span>)    <span class="comment">//用于选择登录页面，没认证时跳转的页面</span></span><br><span class="line">                .loginProcessingUrl(<span class="string">&quot;/login&quot;</span>)   <span class="comment">//选择需要认证的请求，也就是登录表单的提交地址</span></span><br><span class="line">                .usernameParameter(<span class="string">&quot;user&quot;</span>)   <span class="comment">//选择登录请求的哪个参数是用户名</span></span><br><span class="line">                .passwordParameter(<span class="string">&quot;password&quot;</span>)   <span class="comment">//选择登录请求的哪个参数是密码</span></span><br><span class="line">                <span class="comment">//使用自定义的登录失败成功处理方法</span></span><br><span class="line">                .successHandler(myAuthenticationSuccessHandler)  <span class="comment">//登录成功</span></span><br><span class="line">                .failureHandler(myAuthenticationFailureHandler)  <span class="comment">//登录失败</span></span><br><span class="line"></span><br><span class="line">                <span class="comment">//这两会与我们自定义的冲突想要使用自定义的就不能使用这个</span></span><br><span class="line"><span class="comment">//                .defaultSuccessUrl(&quot;/&quot;)   //登录成功跳转的路径</span></span><br><span class="line"><span class="comment">//                .failureForwardUrl(&quot;/logins&quot;)  //登录失败跳转的路径</span></span><br><span class="line">             .and()</span><br><span class="line">                .authorizeRequests() <span class="comment">//自定义过滤拦截请求</span></span><br><span class="line">                .antMatchers(<span class="string">&quot;/logins&quot;</span>,<span class="string">&quot;/login&quot;</span>) <span class="comment">//资源路径</span></span><br><span class="line">                .permitAll()  <span class="comment">//当前资源路径不需要认证就可以访问</span></span><br><span class="line">                .antMatchers(<span class="string">&quot;/business1&quot;</span>,<span class="string">&quot;/business2&quot;</span>,<span class="string">&quot;/&quot;</span>)<span class="comment">//资源路径</span></span><br><span class="line">                .hasAnyAuthority(<span class="string">&quot;ROLE_user&quot;</span>,<span class="string">&quot;ROLE_admin&quot;</span>)<span class="comment">//设置可以访问的角色,user角色和admin角色都可以访问</span></span><br><span class="line"></span><br><span class="line">                    <span class="comment">//访问角色控制方式1  与授权方法1一起使用</span></span><br><span class="line">                .antMatchers(<span class="string">&quot;/log&quot;</span>,<span class="string">&quot;/user&quot;</span>)<span class="comment">//资源路径</span></span><br><span class="line">                .hasRole(<span class="string">&quot;admin&quot;</span>)<span class="comment">//设置可以访问的角色，和hasAnyAuthority作用相同，但hasAnyAuthority可以设置多个，并且需要加前缀ROLE_</span></span><br><span class="line"></span><br><span class="line">                    <span class="comment">//访问角色控制方式2  与授权方法2一起使用  这里由于它不是admin角色了，所有访问业务1业务2访问不了但可以修改一下</span></span><br><span class="line"><span class="comment">//                .antMatchers(&quot;/user&quot;).hasAnyAuthority(&quot;sys:user&quot;)  // /user资源路径 必须拥有sys:user角色才可访问</span></span><br><span class="line"><span class="comment">//                .antMatchers(&quot;/log&quot;).hasAnyAuthority(&quot;sys:log&quot;) // /log资源路径 必须拥有sys:log角色才可访问</span></span><br><span class="line"></span><br><span class="line">                <span class="comment">//选择的匹配规则</span></span><br><span class="line">                .anyRequest()</span><br><span class="line">                <span class="comment">//所有请求都需要登录认证才可以访问</span></span><br><span class="line">                .authenticated();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//.authorizeHttpRequests()   这样方法表示选中的请求</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 授权方法</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> auth</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(AuthenticationManagerBuilder auth)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">                auth  <span class="comment">//授权</span></span><br><span class="line">                .inMemoryAuthentication()  <span class="comment">//将这种用户添加到内存中登录认证，   还有其他类型的授权登录认证方法，比如数据库的登录认证</span></span><br><span class="line">                .withUser(<span class="string">&quot;user&quot;</span>)  <span class="comment">//用户名</span></span><br><span class="line">                .password(passwordEncoder().encode(<span class="string">&quot;123456&quot;</span>))  <span class="comment">//密码</span></span><br><span class="line">                .roles(<span class="string">&quot;user&quot;</span>)  <span class="comment">//设置使用该用户名登录赋予的角色，</span></span><br><span class="line">            .and()</span><br><span class="line">                 .withUser(<span class="string">&quot;admin&quot;</span>) <span class="comment">//用户名</span></span><br><span class="line">                 .password(passwordEncoder().encode(<span class="string">&quot;123456&quot;</span>))</span><br><span class="line">                   <span class="comment">//第一种授权方式</span></span><br><span class="line">                 .roles(<span class="string">&quot;admin&quot;</span>)  <span class="comment">//设置使用该账号登录赋予的角色</span></span><br><span class="line">                   <span class="comment">//第二种授权方式</span></span><br><span class="line">                 <span class="comment">//.authorities(&quot;sys:log&quot;,&quot;sys:user&quot;) //为当前用户赋予角色</span></span><br><span class="line">            .and()</span><br><span class="line">                  .passwordEncoder(passwordEncoder());  <span class="comment">//配置BCrypt加密，这个会自动调用matches（）这个方法来为我们输入的密码进行对比</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> PasswordEncoder <span class="title function_">passwordEncoder</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">BCryptPasswordEncoder</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 静态资源路径开放</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> web</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(WebSecurity web)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">//将项目中的静态资源路径开放出来，在这开放是不需要经过过滤器拦截的</span></span><br><span class="line">        web.ignoring().antMatchers(<span class="string">&quot;/css/**&quot;</span>,<span class="string">&quot;/fonts/**&quot;</span>,<span class="string">&quot;/img/**&quot;</span>,<span class="string">&quot;/js/**&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>







<p><strong>由于这里返回的是Json数据，注意，那么login就需要使用Ajax的方式请求数据：</strong></p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;https://code.jquery.com/jquery-3.0.0.min.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">h1</span>&gt;</span>登录<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">&quot;/login&quot;</span> <span class="attr">method</span>=<span class="string">&quot;post&quot;</span>&gt;</span></span><br><span class="line">    账号：<span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">id</span>=<span class="string">&quot;username&quot;</span> <span class="attr">name</span>=<span class="string">&quot;user&quot;</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">    密码：<span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;password&quot;</span> <span class="attr">id</span>=<span class="string">&quot;password&quot;</span> <span class="attr">name</span>=<span class="string">&quot;password&quot;</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;button&quot;</span> <span class="attr">onclick</span>=<span class="string">&quot;login()&quot;</span> <span class="attr">value</span>=<span class="string">&quot;登录&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">function</span> <span class="title function_">login</span>(<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">let</span> username=$(<span class="string">&quot;#username&quot;</span>).<span class="title function_">val</span>();</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">let</span> password=$(<span class="string">&quot;#password&quot;</span>).<span class="title function_">val</span>();</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">        $.<span class="title function_">ajax</span>(&#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="attr">type</span>: <span class="string">&quot;POST&quot;</span>,</span></span><br><span class="line"><span class="language-javascript">            <span class="attr">url</span>: <span class="string">&quot;/login&quot;</span>,</span></span><br><span class="line"><span class="language-javascript">            <span class="attr">data</span>: &#123;</span></span><br><span class="line"><span class="language-javascript">                <span class="string">&quot;user&quot;</span>: username,</span></span><br><span class="line"><span class="language-javascript">                <span class="string">&quot;password&quot;</span>: password</span></span><br><span class="line"><span class="language-javascript">            &#125;,</span></span><br><span class="line"><span class="language-javascript">            <span class="attr">success</span>: <span class="keyword">function</span> (<span class="params">json</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">              <span class="keyword">if</span> (json.<span class="property">state</span> == <span class="number">200</span>)&#123;</span></span><br><span class="line"><span class="language-javascript">                  <span class="variable language_">console</span>.<span class="title function_">log</span>(json)</span></span><br><span class="line"><span class="language-javascript">                  location.<span class="property">href</span>=<span class="string">&quot;/&quot;</span>;</span></span><br><span class="line"><span class="language-javascript">              &#125;<span class="keyword">else</span> &#123;</span></span><br><span class="line"><span class="language-javascript">                  <span class="title function_">alert</span>(json.<span class="property">message</span>)</span></span><br><span class="line"><span class="language-javascript">                  <span class="variable language_">console</span>.<span class="title function_">log</span>(json)</span></span><br><span class="line"><span class="language-javascript">                  location.<span class="property">href</span>=<span class="string">&quot;/logins&quot;</span>;</span></span><br><span class="line"><span class="language-javascript">              &#125;</span></span><br><span class="line"><span class="language-javascript">            &#125;,</span></span><br><span class="line"><span class="language-javascript">            <span class="attr">error</span>: <span class="keyword">function</span> (<span class="params">e</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">                </span></span><br><span class="line"><span class="language-javascript">            &#125;</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">        &#125;)</span></span><br><span class="line"><span class="language-javascript">    &#125;</span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br></pre></td></tr></table></figure>







<h2 id="session会话的安全管理："><a href="#session会话的安全管理：" class="headerlink" title="session会话的安全管理："></a>session会话的安全管理：</h2><p><img src="https://s2.loli.net/2022/03/09/yDC5PVItQqJhvg2.png" alt="image-20220304121119473"></p>
<p><img src="https://s2.loli.net/2022/03/09/HZw4NyRuXetcvqo.png" alt="image-20220304121220680"></p>
<p>添加以上配置示例：</p>
<p><img src="https://s2.loli.net/2022/03/09/VdxHK6JY45FvpBl.png" alt="image-20220304121253830"></p>
<p><strong>session的安全保护：</strong></p>
<p><img src="https://s2.loli.net/2022/03/09/MEb92jfIm6XRuiA.png" alt="image-20220304121414386"></p>
<p><strong>cookie的安全：</strong></p>
<p><img src="https://s2.loli.net/2022/03/09/c874Wyzg2Rf93JD.png" alt="image-20220304121440993"></p>
<h2 id="同账号多登录踢下线："><a href="#同账号多登录踢下线：" class="headerlink" title="同账号多登录踢下线："></a>同账号多登录踢下线：</h2><p><strong>踢下线处理类：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 配置当session被踢下线之后的操作，如：跳转页面</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CustomExpiredSessionStrategy</span></span><br><span class="line">    <span class="comment">//需要实现该接口</span></span><br><span class="line">    <span class="keyword">implements</span> <span class="title class_">SessionInformationExpiredStrategy</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//页面跳转的处理类</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">RedirectStrategy</span> <span class="variable">redirectStrategy</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DefaultRedirectStrategy</span>();</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">    <span class="comment">//用于将对象转换为json格式</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">ObjectMapper</span> <span class="variable">objectMapper</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectMapper</span>();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 当发现session踢下线就会调用该方法处理，前提需要再配置类中使用该类处理</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> event  这个类中可以获取到requesty 与 respoense</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> IOException</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> ServletException</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onExpiredSessionDetected</span><span class="params">(SessionInformationExpiredEvent event)</span> <span class="keyword">throws</span> IOException, ServletException &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//两种方式，前后端分离，JSON格式，与直接跳转页面的的方式</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            <span class="comment">//方式二，json格式</span></span><br><span class="line">            <span class="comment">//这里使用map也行，对象也行，就是返回的信息</span></span><br><span class="line">            <span class="type">Map</span> <span class="variable">map</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">            map.put(<span class="string">&quot;stat&quot;</span>,<span class="string">&quot;200&quot;</span>);</span><br><span class="line">            map.put(<span class="string">&quot;message&quot;</span>,<span class="string">&quot;请重新进行登录&quot;</span>+event.getSessionInformation().getLastRequest());  <span class="comment">//后面的登录时间</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">s</span> <span class="operator">=</span> objectMapper.writeValueAsString(map);</span><br><span class="line">            event.getResponse().setContentType(<span class="string">&quot;application/json;charset=UTF-8&quot;</span>);</span><br><span class="line">            event.getResponse().getWriter().write(s);</span><br><span class="line"></span><br><span class="line"><span class="comment">//            //方式一，直接跳转  这个方法是重定向到指定的页面</span></span><br><span class="line"><span class="comment">//            redirectStrategy.sendRedirect(event.getRequest(),event.getResponse(),&quot;/logins&quot;);</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<p><strong>在securty配置类中配置：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SecurityConfig</span> <span class="keyword">extends</span> <span class="title class_">WebSecurityConfigurerAdapter</span> &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//将我们自定义的这两个类使用IOC容器装配</span></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> MyAuthenticationSuccessHandler myAuthenticationSuccessHandler;  <span class="comment">//登录成功处理</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> MyAuthenticationFailureHandler myAuthenticationFailureHandler;  <span class="comment">//登录失败处理</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">//开启formLogin登录认证</span></span><br><span class="line">        <span class="comment">//关闭防御csrf攻击</span></span><br><span class="line">        http.csrf().disable()</span><br><span class="line">                .formLogin()<span class="comment">//开启formLogin登录认证</span></span><br><span class="line">                .loginPage(<span class="string">&quot;/logins&quot;</span>)    <span class="comment">//用于选择登录页面，没认证时跳转的页面</span></span><br><span class="line">                .loginProcessingUrl(<span class="string">&quot;/login&quot;</span>)   <span class="comment">//选择需要认证的请求，也就是登录表单的提交地址</span></span><br><span class="line">                .usernameParameter(<span class="string">&quot;user&quot;</span>)   <span class="comment">//选择登录请求的哪个参数是用户名</span></span><br><span class="line">                .passwordParameter(<span class="string">&quot;password&quot;</span>)   <span class="comment">//选择登录请求的哪个参数是密码</span></span><br><span class="line">                <span class="comment">//使用自定义的登录失败成功处理方法</span></span><br><span class="line">                .successHandler(myAuthenticationSuccessHandler)  <span class="comment">//登录成功</span></span><br><span class="line">                .failureHandler(myAuthenticationFailureHandler)  <span class="comment">//登录失败</span></span><br><span class="line"></span><br><span class="line">                <span class="comment">//这两会与我们自定义的冲突想要使用自定义的就不能使用这个</span></span><br><span class="line"><span class="comment">//                .defaultSuccessUrl(&quot;/&quot;)   //登录成功跳转的路径</span></span><br><span class="line"><span class="comment">//                .failureForwardUrl(&quot;/logins&quot;)  //登录失败跳转的路径</span></span><br><span class="line">             .and()</span><br><span class="line">                .authorizeRequests() <span class="comment">//自定义过滤拦截请求</span></span><br><span class="line">                .antMatchers(<span class="string">&quot;/logins&quot;</span>,<span class="string">&quot;/login&quot;</span>) <span class="comment">//资源路径</span></span><br><span class="line">                .permitAll()  <span class="comment">//当前资源路径不需要认证就可以访问</span></span><br><span class="line">                .antMatchers(<span class="string">&quot;/business1&quot;</span>,<span class="string">&quot;/business2&quot;</span>,<span class="string">&quot;/&quot;</span>)<span class="comment">//资源路径</span></span><br><span class="line">                .hasAnyAuthority(<span class="string">&quot;ROLE_user&quot;</span>,<span class="string">&quot;ROLE_admin&quot;</span>)<span class="comment">//设置可以访问的角色,user角色和admin角色都可以访问</span></span><br><span class="line"></span><br><span class="line">                    <span class="comment">//访问角色控制方式1  与授权方法1一起使用</span></span><br><span class="line">                .antMatchers(<span class="string">&quot;/log&quot;</span>,<span class="string">&quot;/user&quot;</span>)<span class="comment">//资源路径</span></span><br><span class="line">                .hasRole(<span class="string">&quot;admin&quot;</span>)<span class="comment">//设置可以访问的角色，和hasAnyAuthority作用相同，但hasAnyAuthority可以设置多个，并且需要加前缀ROLE_</span></span><br><span class="line"></span><br><span class="line">                    <span class="comment">//访问角色控制方式2  与授权方法2一起使用  这里由于它不是admin角色了，所有访问业务1业务2访问不了但可以修改一下</span></span><br><span class="line"><span class="comment">//                .antMatchers(&quot;/user&quot;).hasAnyAuthority(&quot;sys:user&quot;)  // /user资源路径 必须拥有sys:user角色才可访问</span></span><br><span class="line"><span class="comment">//                .antMatchers(&quot;/log&quot;).hasAnyAuthority(&quot;sys:log&quot;) // /log资源路径 必须拥有sys:log角色才可访问</span></span><br><span class="line">                <span class="comment">//选择的匹配规则</span></span><br><span class="line">                .anyRequest()</span><br><span class="line">                <span class="comment">//所有请求都需要登录认证才可以访问</span></span><br><span class="line">                .authenticated()</span><br><span class="line">                </span><br><span class="line">                .and()</span><br><span class="line">                .sessionManagement()<span class="comment">//启用session管理</span></span><br><span class="line">                .maximumSessions(<span class="number">1</span>)<span class="comment">//允许一个账号你个人同时登录，也就是一个session可以几个人同时使用</span></span><br><span class="line">                .maxSessionsPreventsLogin(<span class="literal">false</span>)<span class="comment">//false：当登录时，其它登录的登录的地方会被踢下线;true ：当有用户在登录时不允许登录</span></span><br><span class="line">                .expiredSessionStrategy(<span class="keyword">new</span> <span class="title class_">CustomExpiredSessionStrategy</span>());  <span class="comment">//session超时，被踢下线的自定义操作</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">//.authorizeHttpRequests()   这样方法表示选中的请求</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 授权方法</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> auth</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(AuthenticationManagerBuilder auth)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">                auth  <span class="comment">//授权</span></span><br><span class="line">                .inMemoryAuthentication()  <span class="comment">//将这种用户添加到内存中登录认证，   还有其他类型的授权登录认证方法，比如数据库的登录认证</span></span><br><span class="line">                .withUser(<span class="string">&quot;user&quot;</span>)  <span class="comment">//用户名</span></span><br><span class="line">                .password(passwordEncoder().encode(<span class="string">&quot;123456&quot;</span>))  <span class="comment">//密码</span></span><br><span class="line">                .roles(<span class="string">&quot;user&quot;</span>)  <span class="comment">//设置使用该用户名登录赋予的角色，</span></span><br><span class="line">            .and()</span><br><span class="line">                 .withUser(<span class="string">&quot;admin&quot;</span>) <span class="comment">//用户名</span></span><br><span class="line">                 .password(passwordEncoder().encode(<span class="string">&quot;123456&quot;</span>))</span><br><span class="line">                   <span class="comment">//第一种授权方式</span></span><br><span class="line">                 .roles(<span class="string">&quot;admin&quot;</span>)  <span class="comment">//设置使用该账号登录赋予的角色</span></span><br><span class="line">                   <span class="comment">//第二种授权方式</span></span><br><span class="line">                 <span class="comment">//.authorities(&quot;sys:log&quot;,&quot;sys:user&quot;) //为当前用户赋予角色</span></span><br><span class="line">            .and()</span><br><span class="line">                  .passwordEncoder(passwordEncoder());  <span class="comment">//配置BCrypt加密，这个会自动调用matches（）这个方法来为我们输入的密码进行对比</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> PasswordEncoder <span class="title function_">passwordEncoder</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">BCryptPasswordEncoder</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 静态资源路径开放</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> web</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(WebSecurity web)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">//将项目中的静态资源路径开放出来，在这开放是不需要经过过滤器拦截的</span></span><br><span class="line">        web.ignoring().antMatchers(<span class="string">&quot;/css/**&quot;</span>,<span class="string">&quot;/fonts/**&quot;</span>,<span class="string">&quot;/img/**&quot;</span>,<span class="string">&quot;/js/**&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<h2 id="RBAC权限管理控制模型"><a href="#RBAC权限管理控制模型" class="headerlink" title="RBAC权限管理控制模型"></a><strong>RBAC权限管理控制模型</strong></h2><p><img src="https://s2.loli.net/2022/03/09/tsqKGbhigTXQwOS.png" alt="image-20220307195430369"></p>
<p><img src="https://s2.loli.net/2022/03/09/eFplaSkOnAr2TCc.png" alt="image-20220307195418619"></p>
<h2 id="动态加载用户角色权限数据："><a href="#动态加载用户角色权限数据：" class="headerlink" title="动态加载用户角色权限数据："></a>动态加载用户角色权限数据：</h2><p>首先我们需要实现两个类，一个是UserDetails，还有个是UserDetailsService</p>
<p>UserDetails ：这个接口为的是存放用户详细信息，</p>
<p>UserDetailsService：为加载用户的信息填写到UserDetails 中并返回给Security使用</p>
<h3 id="UserDetails："><a href="#UserDetails：" class="headerlink" title="UserDetails："></a><strong>UserDetails：</strong></h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 用于获取用户详细信息，</span></span><br><span class="line"><span class="comment"> * 需要使用UserDetailsService为当前类绑定信息；</span></span><br><span class="line"><span class="comment"> * 还需要手动创建set方法赋值，已经创建对应的属性存值</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyUserDetails</span> <span class="keyword">implements</span> <span class="title class_">UserDetails</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Collection&lt;? <span class="keyword">extends</span> <span class="title class_">GrantedAuthority</span>&gt; authorities;  <span class="comment">//用户的权限集合</span></span><br><span class="line">    <span class="keyword">private</span> String password; <span class="comment">//密码</span></span><br><span class="line">    <span class="keyword">private</span> String username; <span class="comment">//用户名</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setAuthorities</span><span class="params">(Collection&lt;? extends GrantedAuthority&gt; authorities)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.authorities = authorities;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setPassword</span><span class="params">(String password)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.password = password;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setUsername</span><span class="params">(String username)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.username = username;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setAccountNonExpired</span><span class="params">(<span class="type">boolean</span> accountNonExpired)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.accountNonExpired = accountNonExpired;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setAccountNonLocked</span><span class="params">(<span class="type">boolean</span> accountNonLocked)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.accountNonLocked = accountNonLocked;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setCredentialsNonExpired</span><span class="params">(<span class="type">boolean</span> credentialsNonExpired)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.credentialsNonExpired = credentialsNonExpired;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setEnabled</span><span class="params">(<span class="type">boolean</span> enabled)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.enabled = enabled;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> accountNonExpired; <span class="comment">//账号是否没过期</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> accountNonLocked; <span class="comment">//账号是否没被锁定</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> credentialsNonExpired;  <span class="comment">//用户凭证是否没过期    or 密码是否过期</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> enabled;  <span class="comment">//账户是否可用</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取用户的权限集合</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Collection&lt;? <span class="keyword">extends</span> <span class="title class_">GrantedAuthority</span>&gt; getAuthorities() &#123;</span><br><span class="line">        <span class="keyword">return</span> authorities;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取密码</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getPassword</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> password;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取用户名</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getUsername</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> username;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 账号是否没过期</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span>  这里由于我数据库没加这个字段就默认为true了</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isAccountNonExpired</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 账号是否没被锁定</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span>  这里由于我数据库没加这个字段就默认为true了</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isAccountNonLocked</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 密码是否没过期</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span>  这里由于我数据库没加这个字段就默认为true了</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isCredentialsNonExpired</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 账户是否可用</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isEnabled</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> enabled;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">     <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">equals</span><span class="params">(Object o)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span> == o) <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        <span class="keyword">if</span> (o == <span class="literal">null</span> || getClass() != o.getClass()) <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        <span class="type">MyUserDetails</span> <span class="variable">that</span> <span class="operator">=</span> (MyUserDetails) o;</span><br><span class="line">        <span class="type">return</span> <span class="variable">accountNonExpired</span> <span class="operator">=</span>= that.accountNonExpired &amp;&amp; accountNonLocked == that.accountNonLocked &amp;&amp; credentialsNonExpired 			== that.credentialsNonExpired &amp;&amp; enabled == that.enabled &amp;&amp; Objects.equals(authorities, that.authorities) &amp;&amp; 				   Objects.equals(password, that.password) &amp;&amp; Objects.equals(username, that.username);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">hashCode</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> Objects.hash(authorities, password, username, accountNonExpired, accountNonLocked, credentialsNonExpired, 				enabled);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<h3 id="UserDetailsService："><a href="#UserDetailsService：" class="headerlink" title="UserDetailsService："></a>UserDetailsService：</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 用于加载UserDetails中的详细信息</span></span><br><span class="line"><span class="comment"> * 为替换掉security配置类中的静态授权</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyUserDetailsService</span> <span class="keyword">implements</span> <span class="title class_">UserDetailsService</span> &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//这里三个查询其实可以放一起的，毕竟都是查询用户权限的</span></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> UserMapper userMapper;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RoleMapper roleMapper;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> MenuMapper menuMapper;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     *  使用传入的唯一标识（username） 查询用户信息，并组装成为UserDetails类返回，返回后security就会拿到哪些数据并进行验证</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     *  动态添加security认证，鉴权，授权相关的基础信息</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> username  用户输入的账户，也就是security配置类中的 .usernameParameter(&quot;user&quot;)</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> UsernameNotFoundException</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> UserDetails <span class="title function_">loadUserByUsername</span><span class="params">(String username)</span> <span class="keyword">throws</span> UsernameNotFoundException &#123;</span><br><span class="line">        <span class="type">MyUserDetails</span> <span class="variable">myUserDetails</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MyUserDetails</span>();</span><br><span class="line">      <span class="comment">//获取用户基本信息</span></span><br><span class="line">        <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> userMapper.UserFiend(username);</span><br><span class="line">        <span class="keyword">if</span> (user == <span class="literal">null</span>)&#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">UsernameNotFoundException</span>(<span class="string">&quot;用户不存在&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        myUserDetails.setPassword(user.getPassword());</span><br><span class="line">        myUserDetails.setUsername(user.getUsername());</span><br><span class="line">        myUserDetails.setEnabled(user.isEnabled());</span><br><span class="line"></span><br><span class="line">      <span class="comment">//查询用户角色,赋予用户角色，我们需要在角色前加上 ROLE_</span></span><br><span class="line">        List&lt;String&gt; list = roleMapper.listByUserId(user.getId());</span><br><span class="line">        <span class="type">Role</span> <span class="variable">role</span> <span class="operator">=</span> roleMapper.fiendByUserId(user.getId());</span><br><span class="line">        <span class="comment">//在每个元素前加上ROLE_，获取角色</span></span><br><span class="line">        list=list.stream().map(rc-&gt; <span class="string">&quot;ROLE_&quot;</span> +rc).collect(Collectors.toList());</span><br><span class="line"></span><br><span class="line">        <span class="comment">//根据角色获取解释对应的权限，这个是只获取要权限的页面</span></span><br><span class="line">        List&lt;String&gt; list1 = menuMapper.listByRoleId(role.getId());</span><br><span class="line">        <span class="comment">//将角色与要权限的页面绑定</span></span><br><span class="line">        list1.addAll(list);</span><br><span class="line"></span><br><span class="line">       <span class="comment">//这一步就如同为角色赋予权限</span></span><br><span class="line">        myUserDetails.setAuthorities(</span><br><span class="line">                <span class="comment">//由于List不能直接赋值给Authorities 所有使用AuthorityUtils.commaSeparatedStringToAuthorityList()来解决</span></span><br><span class="line">                AuthorityUtils.commaSeparatedStringToAuthorityList(</span><br><span class="line">                        String.join(<span class="string">&quot;,&quot;</span>,list1)  <span class="comment">//将授权页面与角色用逗号分开</span></span><br><span class="line">                )</span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line">        <span class="comment">//返回当前用户的登录授权信息，交给iSecurity</span></span><br><span class="line">        <span class="keyword">return</span> myUserDetails;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="修改Security配置类："><a href="#修改Security配置类：" class="headerlink" title="修改Security配置类："></a>修改Security配置类：</h3><p>注意：这里由于一些我也不知道的问题，这里的同账户登录多人不会被踢下线</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SecurityConfig</span> <span class="keyword">extends</span> <span class="title class_">WebSecurityConfigurerAdapter</span> &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//将我们自定义的这两个类使用IOC容器装配</span></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> MyAuthenticationSuccessHandler myAuthenticationSuccessHandler;  <span class="comment">//登录成功处理</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> MyAuthenticationFailureHandler myAuthenticationFailureHandler;  <span class="comment">//登录失败处理</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//导入自定义动态授权</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> MyUserDetailsService myUserDetailsService;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 登录认证方法</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> http</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">//开启httpBasic认证</span></span><br><span class="line"><span class="comment">//        http.httpBasic()</span></span><br><span class="line"><span class="comment">//                .and()</span></span><br><span class="line"><span class="comment">//                //所有的请求</span></span><br><span class="line"><span class="comment">//                .authorizeHttpRequests()</span></span><br><span class="line"><span class="comment">//                //匹配规则</span></span><br><span class="line"><span class="comment">//                .anyRequest()</span></span><br><span class="line"><span class="comment">//                //所有请求都需要登录认证才可以访问</span></span><br><span class="line"><span class="comment">//                .authenticated();</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//_______________________________________________________________________________________________________-</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//开启formLogin登录认证</span></span><br><span class="line">        <span class="comment">//关闭防御csrf攻击</span></span><br><span class="line">        http.csrf().disable()</span><br><span class="line">                .formLogin()<span class="comment">//开启formLogin登录认证</span></span><br><span class="line">                .loginPage(<span class="string">&quot;/logins&quot;</span>)    <span class="comment">//用于选择登录页面，没认证时跳转的页面</span></span><br><span class="line">                .loginProcessingUrl(<span class="string">&quot;/login&quot;</span>)   <span class="comment">//选择需要认证的请求，也就是登录表单的提交地址</span></span><br><span class="line">                .usernameParameter(<span class="string">&quot;user&quot;</span>)   <span class="comment">//选择登录请求的哪个参数是用户名</span></span><br><span class="line">                .passwordParameter(<span class="string">&quot;password&quot;</span>)   <span class="comment">//选择登录请求的哪个参数是密码</span></span><br><span class="line">                <span class="comment">//使用自定义的登录失败成功处理方法</span></span><br><span class="line">                .successHandler(myAuthenticationSuccessHandler)  <span class="comment">//登录成功</span></span><br><span class="line">                .failureHandler(myAuthenticationFailureHandler)  <span class="comment">//登录失败</span></span><br><span class="line"></span><br><span class="line">                <span class="comment">//这两会与我们自定义的冲突想要使用自定义的就不能使用这个</span></span><br><span class="line"><span class="comment">//                .defaultSuccessUrl(&quot;/&quot;)   //登录成功跳转的路径</span></span><br><span class="line"><span class="comment">//                .failureForwardUrl(&quot;/logins&quot;)  //登录失败跳转的路径</span></span><br><span class="line">             .and()</span><br><span class="line">                .authorizeRequests() <span class="comment">//自定义过滤拦截请求</span></span><br><span class="line">                .antMatchers(<span class="string">&quot;/logins&quot;</span>,<span class="string">&quot;/login&quot;</span>,<span class="string">&quot;/&quot;</span>) <span class="comment">//资源路径</span></span><br><span class="line">                .permitAll()  <span class="comment">//当前资源路径不需要认证就可以访问</span></span><br><span class="line">                .antMatchers(<span class="string">&quot;/business1&quot;</span>,<span class="string">&quot;/business2&quot;</span>)<span class="comment">//资源路径</span></span><br><span class="line">                .hasAnyAuthority(<span class="string">&quot;ROLE_user&quot;</span>,<span class="string">&quot;ROLE_admin&quot;</span>)<span class="comment">//设置可以访问的角色,user角色和admin角色都可以访问</span></span><br><span class="line"></span><br><span class="line">                    <span class="comment">//访问角色控制方式1  与授权方法1一起使用</span></span><br><span class="line">                .antMatchers(<span class="string">&quot;/log&quot;</span>,<span class="string">&quot;/user&quot;</span>)<span class="comment">//资源路径</span></span><br><span class="line">                .hasRole(<span class="string">&quot;admin&quot;</span>)<span class="comment">//设置可以访问的角色，和hasAnyAuthority作用相同，但hasAnyAuthority可以设置多个，并且需要加前缀ROLE_</span></span><br><span class="line">                </span><br><span class="line">                <span class="comment">//选择的匹配规则</span></span><br><span class="line">                .anyRequest()</span><br><span class="line">                <span class="comment">//所有请求都需要登录认证才可以访问</span></span><br><span class="line">                .authenticated()</span><br><span class="line">                .and()</span><br><span class="line">                .sessionManagement()<span class="comment">//启用session管理</span></span><br><span class="line">                .maximumSessions(<span class="number">1</span>)<span class="comment">//允许一个账号你个人同时登录，也就是一个session可以几个人同时使用</span></span><br><span class="line">                .maxSessionsPreventsLogin(<span class="literal">false</span>)<span class="comment">//false：当登录时，其它登录的登录的地方会被踢下线;true ：当有用户在登录时不允许登录</span></span><br><span class="line">                .expiredSessionStrategy(<span class="keyword">new</span> <span class="title class_">CustomExpiredSessionStrategy</span>());  <span class="comment">//session超时，被踢下线的自定义操作</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">//.authorizeHttpRequests()   这样方法表示选中的请求</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 授权方法</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> auth</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(AuthenticationManagerBuilder auth)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//____________________静态授权________________________</span></span><br><span class="line"><span class="comment">//                auth  //授权</span></span><br><span class="line"><span class="comment">//                .inMemoryAuthentication()  //将这种用户添加到内存中登录认证，   还有其他类型的授权登录认证方法，比如数据库的登录认证</span></span><br><span class="line"><span class="comment">//                .withUser(&quot;user&quot;)  //用户名</span></span><br><span class="line"><span class="comment">//                .password(passwordEncoder().encode(&quot;123456&quot;))  //密码</span></span><br><span class="line"><span class="comment">//                .roles(&quot;user&quot;)  //设置使用该用户名登录赋予的角色，</span></span><br><span class="line"><span class="comment">//            .and()</span></span><br><span class="line"><span class="comment">//                 .withUser(&quot;admin&quot;) //用户名</span></span><br><span class="line"><span class="comment">//                 .password(passwordEncoder().encode(&quot;123456&quot;))</span></span><br><span class="line"><span class="comment">//                   //第一种授权方式</span></span><br><span class="line"><span class="comment">//                 .roles(&quot;admin&quot;)  //设置使用该账号登录赋予的角色</span></span><br><span class="line"><span class="comment">//                   //第二种授权方式</span></span><br><span class="line"><span class="comment">//                 //.authorities(&quot;sys:log&quot;,&quot;sys:user&quot;) //</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">//________________ 动态授权，需要实现UserDetailsService____________________________</span></span><br><span class="line">            auth.userDetailsService(myUserDetailsService)</span><br><span class="line">                  .passwordEncoder(passwordEncoder());  <span class="comment">//配置BCrypt加密，这个会自动调用matches（）这个方法来为我们输入的密码进行对比</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> PasswordEncoder <span class="title function_">passwordEncoder</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">BCryptPasswordEncoder</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 静态资源路径开放</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> web</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(WebSecurity web)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">//将项目中的静态资源路径开放出来，在这开放是不需要经过过滤器拦截的</span></span><br><span class="line">        web.ignoring().antMatchers(<span class="string">&quot;/css/**&quot;</span>,<span class="string">&quot;/fonts/**&quot;</span>,<span class="string">&quot;/img/**&quot;</span>,<span class="string">&quot;/js/**&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>









<h2 id="动态鉴权规则："><a href="#动态鉴权规则：" class="headerlink" title="动态鉴权规则："></a><strong>动态鉴权规则：</strong></h2><p>用于代替静态的鉴权规则</p>
<h5 id="自定义鉴权规则："><a href="#自定义鉴权规则：" class="headerlink" title="自定义鉴权规则："></a>自定义鉴权规则：</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 动态判断用户是否用于访问页面的权限，类名可以随便取</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Component(&quot;MyRBACService&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyRBACService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 用于验证当前用户，是否能访问当前请求的资格与权限</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> request 请求</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> authentication  通过认证的用户主体详细信息</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 有权限返回true ，没权限返回false</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">hasPermission</span><span class="params">(HttpServletRequest request, Authentication authentication)</span>&#123;</span><br><span class="line">        <span class="comment">//获取主体信息UserDetails</span></span><br><span class="line">        <span class="type">Object</span> <span class="variable">principal</span> <span class="operator">=</span> authentication.getPrincipal();</span><br><span class="line">        <span class="comment">//判断principal是否是UserDetails</span></span><br><span class="line">        <span class="keyword">if</span> (principal <span class="keyword">instanceof</span> UserDetails)&#123;</span><br><span class="line">            <span class="type">UserDetails</span> <span class="variable">userDetails</span> <span class="operator">=</span> (UserDetails) principal;</span><br><span class="line">            <span class="comment">//将获取到的这一次请求的资源路径转换为SimpleGrantedAuthority类型，</span></span><br><span class="line">            <span class="comment">// 因为UserDetails中Authorities存放用户权限的类型是SimpleGrantedAuthority类型</span></span><br><span class="line">            <span class="type">SimpleGrantedAuthority</span> <span class="variable">simpleGrantedAuthority</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SimpleGrantedAuthority</span>(request.getRequestURI());</span><br><span class="line">            <span class="comment">//判断当前用户的权限中是发拥有可以访问这个资源路径的权限</span></span><br><span class="line">            <span class="comment">// contains这个方法是用于判断当前集合是否有相同的</span></span><br><span class="line">            <span class="keyword">return</span> userDetails.getAuthorities().contains(simpleGrantedAuthority);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<h5 id="Security配置类："><a href="#Security配置类：" class="headerlink" title="Security配置类："></a>Security配置类：</h5><p>这里使用动态鉴权规则后就不能使用静态授权，因为静态授权只是当前授权了角色，但角色的权限是没有配置的，我们可以看到动态鉴权是直接对当前当前用户角色可以访问的权限进行对比的，静态的只有单纯的角色，但角色是什么权限都没有的</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SecurityConfig</span> <span class="keyword">extends</span> <span class="title class_">WebSecurityConfigurerAdapter</span> &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//将我们自定义的这两个类使用IOC容器装配</span></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> MyAuthenticationSuccessHandler myAuthenticationSuccessHandler;  <span class="comment">//登录成功处理</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> MyAuthenticationFailureHandler myAuthenticationFailureHandler;  <span class="comment">//登录失败处理</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//导入自定义动态授权</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> MyUserDetailsService myUserDetailsService;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 登录认证方法</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> http</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">//开启httpBasic认证</span></span><br><span class="line"><span class="comment">//        http.httpBasic()</span></span><br><span class="line"><span class="comment">//                .and()</span></span><br><span class="line"><span class="comment">//                //所有的请求</span></span><br><span class="line"><span class="comment">//                .authorizeHttpRequests()</span></span><br><span class="line"><span class="comment">//                //匹配规则</span></span><br><span class="line"><span class="comment">//                .anyRequest()</span></span><br><span class="line"><span class="comment">//                //所有请求都需要登录认证才可以访问</span></span><br><span class="line"><span class="comment">//                .authenticated();</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//_______________________________________________________________________________________________________-</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//开启formLogin登录认证</span></span><br><span class="line">        <span class="comment">//关闭防御csrf攻击</span></span><br><span class="line">        http.csrf().disable()</span><br><span class="line">                .formLogin()<span class="comment">//开启formLogin登录认证</span></span><br><span class="line">                .loginPage(<span class="string">&quot;/logins&quot;</span>)    <span class="comment">//用于选择登录页面，没认证时跳转的页面</span></span><br><span class="line">                .loginProcessingUrl(<span class="string">&quot;/login&quot;</span>)   <span class="comment">//选择需要认证的请求，也就是登录表单的提交地址</span></span><br><span class="line">                .usernameParameter(<span class="string">&quot;user&quot;</span>)   <span class="comment">//选择登录请求的哪个参数是用户名</span></span><br><span class="line">                .passwordParameter(<span class="string">&quot;password&quot;</span>)   <span class="comment">//选择登录请求的哪个参数是密码</span></span><br><span class="line">                <span class="comment">//使用自定义的登录失败成功处理方法</span></span><br><span class="line">                .successHandler(myAuthenticationSuccessHandler)  <span class="comment">//登录成功</span></span><br><span class="line">                .failureHandler(myAuthenticationFailureHandler)  <span class="comment">//登录失败</span></span><br><span class="line"></span><br><span class="line">                <span class="comment">//这两会与我们自定义的冲突想要使用自定义的就不能使用这个</span></span><br><span class="line"><span class="comment">//                .defaultSuccessUrl(&quot;/&quot;)   //登录成功跳转的路径</span></span><br><span class="line"><span class="comment">//                .failureForwardUrl(&quot;/logins&quot;)  //登录失败跳转的路径</span></span><br><span class="line">             .and()</span><br><span class="line">                .authorizeRequests() <span class="comment">//自定义过滤拦截请求</span></span><br><span class="line">                .antMatchers(<span class="string">&quot;/logins&quot;</span>,<span class="string">&quot;/login&quot;</span>,<span class="string">&quot;/&quot;</span>) <span class="comment">//资源路径</span></span><br><span class="line">                .permitAll()  <span class="comment">//当前资源路径不需要认证就可以访问</span></span><br><span class="line">                <span class="comment">//____________________静态鉴权____________________________________</span></span><br><span class="line"><span class="comment">//                .antMatchers(&quot;/business1&quot;,&quot;/business2&quot;)//资源路径</span></span><br><span class="line"><span class="comment">//                .hasAnyAuthority(&quot;ROLE_user&quot;,&quot;ROLE_admin&quot;)//设置可以访问的角色,user角色和admin角色都可以访问</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//                    //访问角色控制方式1  与授权方法1一起使用</span></span><br><span class="line"><span class="comment">//                .antMatchers(&quot;/log&quot;,&quot;/user&quot;)//资源路径</span></span><br><span class="line"><span class="comment">//                .hasRole(&quot;admin&quot;)//设置可以访问的角色，和hasAnyAuthority作用相同，但hasAnyAuthority可以设置多个，并且需要加前缀ROLE_</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//                    //访问角色控制方式2  与授权方法2一起使用  这里由于它不是admin角色了，所有访问业务1业务2访问不了但可以修改一下</span></span><br><span class="line"><span class="comment">////                .antMatchers(&quot;/user&quot;).hasAnyAuthority(&quot;sys:user&quot;)  // /user资源路径 必须拥有sys:user角色才可访问</span></span><br><span class="line"><span class="comment">////                .antMatchers(&quot;/log&quot;).hasAnyAuthority(&quot;sys:log&quot;) // /log资源路径 必须拥有sys:log角色才可访问</span></span><br><span class="line"><span class="comment">//                //选择的匹配规则</span></span><br><span class="line"><span class="comment">//                .anyRequest()</span></span><br><span class="line"><span class="comment">//                //所有请求都需要登录认证才可以访问</span></span><br><span class="line"><span class="comment">//                .authenticated()</span></span><br><span class="line"></span><br><span class="line">                <span class="comment">//______________________________动态图鉴权_____________________________________________</span></span><br><span class="line">                    <span class="comment">//所有的请求都有经过MyRBACService的hasPermission方法进行鉴权 返回true可以访问，返回false不允许访问</span></span><br><span class="line">                    <span class="comment">//anyRequest  所有的请求</span></span><br><span class="line">                    <span class="comment">//access   访问权限</span></span><br><span class="line">                    /里面使用SpEL权限表达式</span><br><span class="line">                .anyRequest().access(<span class="string">&quot;@MyRBACService.hasPermission(request,authentication)&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">                .and()</span><br><span class="line">                .sessionManagement()<span class="comment">//启用session管理</span></span><br><span class="line">                .maximumSessions(<span class="number">1</span>)<span class="comment">//允许一个账号你个人同时登录，也就是一个session可以几个人同时使用</span></span><br><span class="line">                .maxSessionsPreventsLogin(<span class="literal">false</span>)<span class="comment">//false：当登录时，其它登录的登录的地方会被踢下线;true ：当有用户在登录时不允许登录</span></span><br><span class="line">                .expiredSessionStrategy(<span class="keyword">new</span> <span class="title class_">CustomExpiredSessionStrategy</span>());  <span class="comment">//session超时，被踢下线的自定义操作</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">//.authorizeHttpRequests()   这样方法表示选中的请求</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 授权方法</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> auth</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(AuthenticationManagerBuilder auth)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//____________________静态授权________________________</span></span><br><span class="line"><span class="comment">//                auth  //授权</span></span><br><span class="line"><span class="comment">//                .inMemoryAuthentication()  //将这种用户添加到内存中登录认证，   还有其他类型的授权登录认证方法，比如数据库的登录认证</span></span><br><span class="line"><span class="comment">//                .withUser(&quot;user&quot;)  //用户名</span></span><br><span class="line"><span class="comment">//                .password(passwordEncoder().encode(&quot;123456&quot;))  //密码</span></span><br><span class="line"><span class="comment">//                .roles(&quot;user&quot;)  //设置使用该用户名登录赋予的角色，</span></span><br><span class="line"><span class="comment">//            .and()</span></span><br><span class="line"><span class="comment">//                 .withUser(&quot;admin&quot;) //用户名</span></span><br><span class="line"><span class="comment">//                 .password(passwordEncoder().encode(&quot;123456&quot;))</span></span><br><span class="line"><span class="comment">//                   //第一种授权方式</span></span><br><span class="line"><span class="comment">//                 .roles(&quot;admin&quot;)  //设置使用该账号登录赋予的角色</span></span><br><span class="line"><span class="comment">//                   //第二种授权方式</span></span><br><span class="line"><span class="comment">//                 //.authorities(&quot;sys:log&quot;,&quot;sys:user&quot;) //</span></span><br><span class="line"><span class="comment">//                    .and().passwordEncoder(passwordEncoder()); //配置BCrypt加密，这个会自动调用matches（）这个方法来为我们输入的密码进行对比</span></span><br><span class="line">        <span class="comment">//________________ 动态授权，需要实现UserDetailsService____________________________</span></span><br><span class="line">            auth.userDetailsService(myUserDetailsService)</span><br><span class="line">                  .passwordEncoder(passwordEncoder());  <span class="comment">//配置BCrypt加密，这个会自动调用matches（）这个方法来为我们输入的密码进行对比</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> PasswordEncoder <span class="title function_">passwordEncoder</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">BCryptPasswordEncoder</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 静态资源路径开放</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> web</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(WebSecurity web)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">//将项目中的静态资源路径开放出来，在这开放是不需要经过过滤器拦截的</span></span><br><span class="line">        web.ignoring().antMatchers(<span class="string">&quot;/css/**&quot;</span>,<span class="string">&quot;/fonts/**&quot;</span>,<span class="string">&quot;/img/**&quot;</span>,<span class="string">&quot;/js/**&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<h5 id="方法增强注解："><a href="#方法增强注解：" class="headerlink" title="方法增强注解："></a>方法增强注解：</h5><p><img src="https://s2.loli.net/2022/03/09/wSlBCNefJyq2sxP.png" alt="image-20220308200231990"></p>
<p><strong>@PreAuthorize(“SPEL”):  方法执行前判断用户调用权限</strong></p>
<p><img src="https://s2.loli.net/2022/03/09/37T2DwRsaM96zSh.png" alt="image-20220308200604674"></p>
<p><strong>@PreFilter(“SPEL”):方法执行前过滤参数</strong></p>
<p><img src="https://s2.loli.net/2022/03/09/QNLUZrw7TIMDj5P.png" alt="image-20220308200655277"></p>
<p><strong>@PostAuthorize(“SPEL”):方法执行后判断</strong></p>
<p><img src="https://s2.loli.net/2022/03/09/IYaygrwcXiAqV7v.png" alt="image-20220308200824019"></p>
<p><strong>@PostFilter（”SPEL“） ： 方法执行完后过滤返回值</strong></p>
<p><img src="https://s2.loli.net/2022/03/09/Hw7KEVztY8FCk52.png" alt="image-20220308200910568"></p>
<p><strong>在Security配置类中开启这个是个注解的使用：</strong></p>
<p><img src="https://s2.loli.net/2022/03/09/iwQUNd5Rg3phnHk.png" alt="image-20220308200954913"></p>
<h2 id="记住我功能："><a href="#记住我功能：" class="headerlink" title="记住我功能："></a>记住我功能：</h2><p>这个配置使用十分的简单</p>
<p><img src="https://s2.loli.net/2022/03/21/I4d1MPALWe8Qumq.png" alt="image-20220309223842857"></p>
<h5 id="Security配置类"><a href="#Security配置类" class="headerlink" title="Security配置类:"></a>Security配置类:</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SecurityConfig</span> <span class="keyword">extends</span> <span class="title class_">WebSecurityConfigurerAdapter</span> &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//将我们自定义的这两个类使用IOC容器装配</span></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> MyAuthenticationSuccessHandler myAuthenticationSuccessHandler;  <span class="comment">//登录成功处理</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> MyAuthenticationFailureHandler myAuthenticationFailureHandler;  <span class="comment">//登录失败处理</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//导入自定义动态授权</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> MyUserDetailsService myUserDetailsService;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 登录认证方法</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> http</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">//开启httpBasic认证</span></span><br><span class="line"><span class="comment">//        http.httpBasic()</span></span><br><span class="line"><span class="comment">//                .and()</span></span><br><span class="line"><span class="comment">//                //所有的请求</span></span><br><span class="line"><span class="comment">//                .authorizeHttpRequests()</span></span><br><span class="line"><span class="comment">//                //匹配规则</span></span><br><span class="line"><span class="comment">//                .anyRequest()</span></span><br><span class="line"><span class="comment">//                //所有请求都需要登录认证才可以访问</span></span><br><span class="line"><span class="comment">//                .authenticated();</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//_______________________________________________________________________________________________________-</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//开启formLogin登录认证</span></span><br><span class="line">        http.rememberMe()<span class="comment">//开启记住我功能  ，前端也需要有记住我字段</span></span><br><span class="line">                .rememberMeCookieName(<span class="string">&quot;rememberMe-Cookie&quot;</span>)  <span class="comment">//存在浏览器中cookie的名称</span></span><br><span class="line">                .rememberMeParameter(<span class="string">&quot;remember-me&quot;</span>)  <span class="comment">//表单中 自动登录 勾选框的参数名</span></span><br><span class="line">                .tokenValiditySeconds(<span class="number">2</span>*<span class="number">24</span>*<span class="number">60</span>*<span class="number">60</span>) <span class="comment">//保存Cookie的有效期，默认2周</span></span><br><span class="line"></span><br><span class="line">                .and()</span><br><span class="line"></span><br><span class="line">                .csrf().disable()  <span class="comment">//关闭防御csrf攻击</span></span><br><span class="line">                .formLogin()<span class="comment">//开启formLogin登录认证</span></span><br><span class="line">                .loginPage(<span class="string">&quot;/logins&quot;</span>)    <span class="comment">//用于选择登录页面，没认证时跳转的页面</span></span><br><span class="line">                .loginProcessingUrl(<span class="string">&quot;/login&quot;</span>)   <span class="comment">//选择需要认证的请求，也就是登录表单的提交地址</span></span><br><span class="line">                .usernameParameter(<span class="string">&quot;user&quot;</span>)   <span class="comment">//选择登录请求的哪个参数是用户名</span></span><br><span class="line">                .passwordParameter(<span class="string">&quot;password&quot;</span>)   <span class="comment">//选择登录请求的哪个参数是密码</span></span><br><span class="line">                <span class="comment">//使用自定义的登录失败成功处理方法</span></span><br><span class="line">                .successHandler(myAuthenticationSuccessHandler)  <span class="comment">//登录成功</span></span><br><span class="line">                .failureHandler(myAuthenticationFailureHandler)  <span class="comment">//登录失败</span></span><br><span class="line"></span><br><span class="line">                <span class="comment">//这两会与我们自定义的冲突想要使用自定义的就不能使用这个</span></span><br><span class="line"><span class="comment">//                .defaultSuccessUrl(&quot;/&quot;)   //登录成功跳转的路径</span></span><br><span class="line"><span class="comment">//                .failureForwardUrl(&quot;/logins&quot;)  //登录失败跳转的路径</span></span><br><span class="line">             .and()</span><br><span class="line">                .authorizeRequests() <span class="comment">//自定义过滤拦截请求</span></span><br><span class="line">                .antMatchers(<span class="string">&quot;/logins&quot;</span>,<span class="string">&quot;/login&quot;</span>,<span class="string">&quot;/&quot;</span>) <span class="comment">//资源路径</span></span><br><span class="line">                .permitAll()  <span class="comment">//当前资源路径不需要认证就可以访问</span></span><br><span class="line"></span><br><span class="line">                <span class="comment">//______________________________动态图鉴权_____________________________________________</span></span><br><span class="line">                    <span class="comment">//所有的请求都有经过MyRBACService的hasPermission方法进行鉴权 返回true可以访问，返回false不允许访问</span></span><br><span class="line">                .anyRequest().access(<span class="string">&quot;@MyRBACService.hasPermission(request,authentication)&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">                .and()</span><br><span class="line">                .sessionManagement()<span class="comment">//启用session管理</span></span><br><span class="line">                .maximumSessions(<span class="number">1</span>)<span class="comment">//允许一个账号你个人同时登录，也就是一个session可以几个人同时使用</span></span><br><span class="line">                .maxSessionsPreventsLogin(<span class="literal">false</span>)<span class="comment">//false：当登录时，其它登录的登录的地方会被踢下线;true ：当有用户在登录时不允许登录</span></span><br><span class="line">                .expiredSessionStrategy(<span class="keyword">new</span> <span class="title class_">CustomExpiredSessionStrategy</span>());  <span class="comment">//session超时，被踢下线的自定义操作</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">//.authorizeHttpRequests()   这样方法表示选中的请求</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 授权方法</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> auth</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(AuthenticationManagerBuilder auth)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">//________________ 动态授权，需要实现UserDetailsService____________________________</span></span><br><span class="line">            auth.userDetailsService(myUserDetailsService)</span><br><span class="line">                  .passwordEncoder(passwordEncoder());  <span class="comment">//配置BCrypt加密，这个会自动调用matches（）这个方法来为我们输入的密码进行对比</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> PasswordEncoder <span class="title function_">passwordEncoder</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">BCryptPasswordEncoder</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 静态资源路径开放</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> web</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(WebSecurity web)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">//将项目中的静态资源路径开放出来，在这开放是不需要经过过滤器拦截的</span></span><br><span class="line">        web.ignoring().antMatchers(<span class="string">&quot;/css/**&quot;</span>,<span class="string">&quot;/fonts/**&quot;</span>,<span class="string">&quot;/img/**&quot;</span>,<span class="string">&quot;/js/**&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>







<h5 id="前端："><a href="#前端：" class="headerlink" title="前端："></a>前端：</h5><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;https://code.jquery.com/jquery-3.0.0.min.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">h1</span>&gt;</span>登录<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">&quot;/login&quot;</span> <span class="attr">method</span>=<span class="string">&quot;post&quot;</span>&gt;</span></span><br><span class="line">    账号：<span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">id</span>=<span class="string">&quot;username&quot;</span> <span class="attr">name</span>=<span class="string">&quot;user&quot;</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">    密码：<span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;password&quot;</span> <span class="attr">id</span>=<span class="string">&quot;password&quot;</span> <span class="attr">name</span>=<span class="string">&quot;password&quot;</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;button&quot;</span> <span class="attr">onclick</span>=<span class="string">&quot;login()&quot;</span> <span class="attr">value</span>=<span class="string">&quot;登录&quot;</span>&gt;</span></span><br><span class="line">     记住我<span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;checkbox&quot;</span> <span class="attr">name</span>=<span class="string">&quot;remember-me&quot;</span> <span class="attr">id</span>=<span class="string">&quot;remember-me&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">function</span> <span class="title function_">login</span>(<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">let</span> username=$(<span class="string">&quot;#username&quot;</span>).<span class="title function_">val</span>();</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">let</span> password=$(<span class="string">&quot;#password&quot;</span>).<span class="title function_">val</span>();</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">let</span> remember=$(<span class="string">&quot;#remember-me&quot;</span>).<span class="title function_">prop</span>(<span class="string">&quot;checked&quot;</span>);</span></span><br><span class="line"><span class="language-javascript">        <span class="title function_">alert</span>(remember)</span></span><br><span class="line"><span class="language-javascript">        $.<span class="title function_">ajax</span>(&#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="attr">type</span>: <span class="string">&quot;POST&quot;</span>,</span></span><br><span class="line"><span class="language-javascript">            <span class="attr">url</span>: <span class="string">&quot;/login&quot;</span>,</span></span><br><span class="line"><span class="language-javascript">            <span class="attr">data</span>: &#123;</span></span><br><span class="line"><span class="language-javascript">                <span class="string">&quot;user&quot;</span>: username,</span></span><br><span class="line"><span class="language-javascript">                <span class="string">&quot;password&quot;</span>: password,</span></span><br><span class="line"><span class="language-javascript">                <span class="string">&quot;remember-me&quot;</span>:remember</span></span><br><span class="line"><span class="language-javascript">            &#125;,</span></span><br><span class="line"><span class="language-javascript">            <span class="attr">success</span>: <span class="keyword">function</span> (<span class="params">json</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">              <span class="keyword">if</span> (json.<span class="property">state</span> == <span class="number">200</span>)&#123;</span></span><br><span class="line"><span class="language-javascript">                  <span class="variable language_">console</span>.<span class="title function_">log</span>(json)</span></span><br><span class="line"><span class="language-javascript">                  location.<span class="property">href</span>=<span class="string">&quot;/&quot;</span>;</span></span><br><span class="line"><span class="language-javascript">              &#125;<span class="keyword">else</span> &#123;</span></span><br><span class="line"><span class="language-javascript">                  <span class="title function_">alert</span>(json.<span class="property">message</span>)</span></span><br><span class="line"><span class="language-javascript">                  <span class="variable language_">console</span>.<span class="title function_">log</span>(json)</span></span><br><span class="line"><span class="language-javascript">                  location.<span class="property">href</span>=<span class="string">&quot;/logins&quot;</span>;</span></span><br><span class="line"><span class="language-javascript">              &#125;</span></span><br><span class="line"><span class="language-javascript">            &#125;,</span></span><br><span class="line"><span class="language-javascript">            <span class="attr">error</span>: <span class="keyword">function</span> (<span class="params">e</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">                </span></span><br><span class="line"><span class="language-javascript">            &#125;</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">        &#125;)</span></span><br><span class="line"><span class="language-javascript">    &#125;</span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br></pre></td></tr></table></figure>





<p>勾选记住我登录后会出现remember -me这个cookie</p>
<p><img src="https://s2.loli.net/2022/03/21/TPBXH6aGkDcMyuN.png" alt="image-20220309224317467"></p>
<p>其实它是有两层加密，最外层它是使用Base64加密的：</p>
<p>​						解码</p>
<p><img src="https://s2.loli.net/2022/03/21/tgj25RVxHfU8cXq.png" alt="image-20220309224554252"></p>
<p>密码还使用MD5加密:</p>
<p>TokenBasedRememberMeServices类源码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> String <span class="title function_">makeTokenSignature</span><span class="params">(<span class="type">long</span> tokenExpiryTime, String username, String password)</span> &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">data</span> <span class="operator">=</span> username + <span class="string">&quot;:&quot;</span> + tokenExpiryTime + <span class="string">&quot;:&quot;</span> + password + <span class="string">&quot;:&quot;</span> + <span class="built_in">this</span>.getKey();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="type">MessageDigest</span> <span class="variable">digest</span> <span class="operator">=</span> MessageDigest.getInstance(<span class="string">&quot;MD5&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">String</span>(Hex.encode(digest.digest(data.getBytes())));</span><br><span class="line">    &#125; <span class="keyword">catch</span> (NoSuchAlgorithmException var7) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(<span class="string">&quot;No MD5 algorithm available!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这图进行解释</p>
<p><img src="https://s2.loli.net/2022/03/21/P15bc6jrSX9aMuU.png" alt="image-20220309224722249"></p>
<h5 id="个性化配置"><a href="#个性化配置" class="headerlink" title="个性化配置"></a>个性化配置</h5><p><img src="https://s2.loli.net/2022/03/21/GaHOPL49KkQlRyg.png" alt="image-20220309224647471"></p>
<h2 id="记住我功能将验证数据保存到数据库："><a href="#记住我功能将验证数据保存到数据库：" class="headerlink" title="记住我功能将验证数据保存到数据库："></a>记住我功能将验证数据保存到数据库：</h2><p>我们没使用数据库存储令牌校验，当我们关闭程序时，记住我功能则会失效，客户端有session也没有用，在内存中令牌校验的数据被清空了，</p>
<p>为了防止重启程序而导致记住我失效，我们将信息存储到数据库中，</p>
<p>注意：这个存储的不是你的session，你在浏览器删除session那么同样需要重新输入密码，存储到数据库中的是类似令牌校验的信息</p>
<p><strong>先创建数据库：</strong></p>
<p>这个表是固定的，不能修改，在提供的类中，有个方法也可以创建，我们这就手动创建了</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">CREATE TABLE `persistent_logins`(</span><br><span class="line">`username` varchar (64) NOT NULL,</span><br><span class="line">`series` varchar (64) NOT NULL,</span><br><span class="line">`token` varchar(64) NOT NULL,</span><br><span class="line">`last_used` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,</span><br><span class="line">PRIMARY KEY (series)</span><br><span class="line">)ENGINE=InnoDB DEFAULT CHARSET=utf8;</span><br></pre></td></tr></table></figure>





<p>在Security配置类中注入一个数据源：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> DataSource dataSource;</span><br></pre></td></tr></table></figure>



<p>再编辑一个bean 指定存储到数据库的操作</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * JdbcTokenRepositoryImpl 这个类是将数据保存到数据操作的类，里面有很多sql语句的，可以自己去看看</span></span><br><span class="line"><span class="comment"> * 这个类中已经固定要存到数据库中的哪个表，我们只需要指定数据源即可</span></span><br><span class="line"><span class="comment"> * initDao() 这个方法有在数据库中创建需要的表，我还没尝试过，我的表是自己手动创建的</span></span><br><span class="line"><span class="comment"> * 设置记住我存储到的数据源是哪个</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="keyword">public</span> PersistentTokenRepository <span class="title function_">tokenRepository</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="type">JdbcTokenRepositoryImpl</span> <span class="variable">jdbcTokenRepository</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JdbcTokenRepositoryImpl</span>();</span><br><span class="line">    jdbcTokenRepository.setDataSource(dataSource);</span><br><span class="line">    <span class="keyword">return</span> jdbcTokenRepository;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>然在告诉security指定使用这个bean</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">.rememberMeCookieName(<span class="string">&quot;rememberMe-Cookie&quot;</span>)  <span class="comment">//存在浏览器中cookie的名称</span></span><br><span class="line">.rememberMeParameter(<span class="string">&quot;remember-me&quot;</span>)  <span class="comment">//表单中 自动登录 勾选框的参数名</span></span><br><span class="line">.tokenValiditySeconds(<span class="number">2</span>*<span class="number">24</span>*<span class="number">60</span>*<span class="number">60</span>) <span class="comment">//保存Cookie的有效期，默认2周</span></span><br><span class="line">.tokenRepository(tokenRepository())  <span class="comment">//指定rememberMe存储到数据库规则方法</span></span><br></pre></td></tr></table></figure>





<p>完整配置：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SecurityConfig</span> <span class="keyword">extends</span> <span class="title class_">WebSecurityConfigurerAdapter</span> &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//将我们自定义的这两个类使用IOC容器装配</span></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> MyAuthenticationSuccessHandler myAuthenticationSuccessHandler;  <span class="comment">//登录成功处理</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> MyAuthenticationFailureHandler myAuthenticationFailureHandler;  <span class="comment">//登录失败处理</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//导入自定义动态授权</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> MyUserDetailsService myUserDetailsService;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> DataSource dataSource;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 登录认证方法</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> http</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">//开启formLogin登录认证</span></span><br><span class="line">        http.rememberMe()<span class="comment">//开启记住我功能  ，前端也需要有记住我字段</span></span><br><span class="line">                .rememberMeCookieName(<span class="string">&quot;rememberMe-Cookie&quot;</span>)  <span class="comment">//存在浏览器中cookie的名称</span></span><br><span class="line">                .rememberMeParameter(<span class="string">&quot;remember-me&quot;</span>)  <span class="comment">//表单中 自动登录 勾选框的参数名</span></span><br><span class="line">                .tokenValiditySeconds(<span class="number">2</span>*<span class="number">24</span>*<span class="number">60</span>*<span class="number">60</span>) <span class="comment">//保存Cookie的有效期，默认2周</span></span><br><span class="line">                .tokenRepository(tokenRepository())  <span class="comment">//指定rememberMe存储到数据库规则方法</span></span><br><span class="line"></span><br><span class="line">                .and()</span><br><span class="line"></span><br><span class="line">                .csrf().disable()  <span class="comment">//关闭防御csrf攻击</span></span><br><span class="line">                .formLogin()<span class="comment">//开启formLogin登录认证</span></span><br><span class="line">                .loginPage(<span class="string">&quot;/logins&quot;</span>)    <span class="comment">//用于选择登录页面，没认证时跳转的页面</span></span><br><span class="line">                .loginProcessingUrl(<span class="string">&quot;/login&quot;</span>)   <span class="comment">//选择需要认证的请求，也就是登录表单的提交地址</span></span><br><span class="line">                .usernameParameter(<span class="string">&quot;user&quot;</span>)   <span class="comment">//选择登录请求的哪个参数是用户名</span></span><br><span class="line">                .passwordParameter(<span class="string">&quot;password&quot;</span>)   <span class="comment">//选择登录请求的哪个参数是密码</span></span><br><span class="line">                <span class="comment">//使用自定义的登录失败成功处理方法</span></span><br><span class="line">                .successHandler(myAuthenticationSuccessHandler)  <span class="comment">//登录成功</span></span><br><span class="line">                .failureHandler(myAuthenticationFailureHandler)  <span class="comment">//登录失败</span></span><br><span class="line"></span><br><span class="line">                <span class="comment">//这两会与我们自定义的冲突想要使用自定义的就不能使用这个</span></span><br><span class="line"><span class="comment">//                .defaultSuccessUrl(&quot;/&quot;)   //登录成功跳转的路径</span></span><br><span class="line"><span class="comment">//                .failureForwardUrl(&quot;/logins&quot;)  //登录失败跳转的路径</span></span><br><span class="line">             .and()</span><br><span class="line">                .authorizeRequests() <span class="comment">//自定义过滤拦截请求</span></span><br><span class="line">                .antMatchers(<span class="string">&quot;/logins&quot;</span>,<span class="string">&quot;/login&quot;</span>,<span class="string">&quot;/&quot;</span>) <span class="comment">//资源路径</span></span><br><span class="line">                .permitAll()  <span class="comment">//当前资源路径不需要认证就可以访问</span></span><br><span class="line"></span><br><span class="line">                <span class="comment">//______________________________动态图鉴权_____________________________________________</span></span><br><span class="line">                    <span class="comment">//所有的请求都有经过MyRBACService的hasPermission方法进行鉴权 返回true可以访问，返回false不允许访问</span></span><br><span class="line">                .anyRequest().access(<span class="string">&quot;@MyRBACService.hasPermission(request,authentication)&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">                .and()</span><br><span class="line">                .sessionManagement()<span class="comment">//启用session管理</span></span><br><span class="line">                .maximumSessions(<span class="number">1</span>)<span class="comment">//允许一个账号你个人同时登录，也就是一个session可以几个人同时使用</span></span><br><span class="line">                .maxSessionsPreventsLogin(<span class="literal">false</span>)<span class="comment">//false：当登录时，其它登录的登录的地方会被踢下线;true ：当有用户在登录时不允许登录</span></span><br><span class="line">                .expiredSessionStrategy(<span class="keyword">new</span> <span class="title class_">CustomExpiredSessionStrategy</span>());  <span class="comment">//session超时，被踢下线的自定义操作</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">//.authorizeHttpRequests()   这样方法表示选中的请求</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 授权方法</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> auth</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(AuthenticationManagerBuilder auth)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//________________ 动态授权，需要实现UserDetailsService____________________________</span></span><br><span class="line">            auth.userDetailsService(myUserDetailsService)</span><br><span class="line">                  .passwordEncoder(passwordEncoder());  <span class="comment">//配置BCrypt加密，这个会自动调用matches（）这个方法来为我们输入的密码进行对比</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> PasswordEncoder <span class="title function_">passwordEncoder</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">BCryptPasswordEncoder</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 静态资源路径开放</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> web</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(WebSecurity web)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">//将项目中的静态资源路径开放出来，在这开放是不需要经过过滤器拦截的</span></span><br><span class="line">        web.ignoring().antMatchers(<span class="string">&quot;/css/**&quot;</span>,<span class="string">&quot;/fonts/**&quot;</span>,<span class="string">&quot;/img/**&quot;</span>,<span class="string">&quot;/js/**&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * JdbcTokenRepositoryImpl 这个类中已经固定要存到数据库中的哪个表，我们只需要指定数据源即可</span></span><br><span class="line"><span class="comment">     * initDao() 这个方法有在数据库中创建需要的表，我还没尝试过，我的表是自己手动创建的</span></span><br><span class="line"><span class="comment">     * 设置记住我存储到的数据源是哪个</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> PersistentTokenRepository <span class="title function_">tokenRepository</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="type">JdbcTokenRepositoryImpl</span> <span class="variable">jdbcTokenRepository</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JdbcTokenRepositoryImpl</span>();</span><br><span class="line">        jdbcTokenRepository.setDataSource(dataSource);</span><br><span class="line">        <span class="keyword">return</span> jdbcTokenRepository;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>SPEL表达式：</p>
<p><img src="https://s2.loli.net/2022/03/21/nBC3wzYPX4Gocq9.png" alt="image-20220317231517131"></p>
<h2 id="退出登录："><a href="#退出登录：" class="headerlink" title="退出登录："></a>退出登录：</h2><h5 id="最简单的实现"><a href="#最简单的实现" class="headerlink" title="最简单的实现"></a><strong>最简单的实现</strong></h5><p>后端配置：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.logout()//开启退出登录</span><br></pre></td></tr></table></figure>



<p>前端代码：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;a href=&quot;/logout&quot;&gt;退出登录&lt;/a&gt;</span><br></pre></td></tr></table></figure>





<h5 id="Logout的默认行为"><a href="#Logout的默认行为" class="headerlink" title="Logout的默认行为"></a>Logout的默认行为</h5><p>1，当前session失效，即: logout的核心需求，session失效就是访问权限的回收</p>
<p>2，删除当前用户的remember-me“记住我”功能信息，数据库中的也会删除</p>
<p>3，clear清除当前的SecurityContext ，可以看做清除了也会的主体信息等</p>
<p>4，重定向到登录页面，loginPage配置项指定的页面</p>
<h5 id="个性化配置-1"><a href="#个性化配置-1" class="headerlink" title="个性化配置"></a>个性化配置</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">.logoutSuccessUrl(<span class="string">&quot;/&quot;</span>) <span class="comment">//退出后跳转的页面  默认退出到login页面</span></span><br><span class="line">.deleteCookies(<span class="string">&quot;JSESSIONID&quot;</span>) <span class="comment">//退出后要删除的cookie 参数是cookie名称</span></span><br><span class="line">.logoutUrl(<span class="string">&quot;/logout&quot;</span>)  <span class="comment">//退出请求路径，也就是页面上退出登录的路径，别忘了前端页面也要改  默认logout</span></span><br></pre></td></tr></table></figure>





<h5 id="LogoutSuccessHandler-实现个性化规程功能"><a href="#LogoutSuccessHandler-实现个性化规程功能" class="headerlink" title="LogoutSuccessHandler:实现个性化规程功能"></a>LogoutSuccessHandler:实现个性化规程功能</h5><p>注意，不要与logoutSuccessUrl以前使用，否则会失效</p>
<p><strong>自定义类：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 自定义退出后需要进行的操作</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyLogoutSuccessHandler</span> <span class="keyword">implements</span> <span class="title class_">LogoutSuccessHandler</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 进行重新方法失效个性化退出</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> request  请求</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> response  响应</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> authentication  主体信息</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> IOException</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> ServletException</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onLogoutSuccess</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Authentication authentication)</span> <span class="keyword">throws</span> IOException, ServletException &#123;</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;附加逻辑代码..........&quot;</span>);</span><br><span class="line"></span><br><span class="line">        response.sendRedirect(<span class="string">&quot;/&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p><strong>Security配置类:</strong>	</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">//退出登录自定义策略</span><br><span class="line">@Autowired</span><br><span class="line">private MyLogoutSuccessHandler myLogoutSuccessHandler;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">        //开启formLogin登录认证</span><br><span class="line">        http.</span><br><span class="line">                logout()//开启退出登录</span><br><span class="line">//                .logoutSuccessUrl(&quot;/&quot;) //退出后跳转的页面  默认退出到login页面</span><br><span class="line">                .deleteCookies(&quot;JSESSIONID&quot;) //指定退出后要删除的cookie</span><br><span class="line">                .logoutUrl(&quot;/logout&quot;)  //退出请求路径，也就是页面上退出登录访问的地址  默认logout</span><br><span class="line">                .logoutSuccessHandler(myLogoutSuccessHandler) //使用自定义退出策略 ，不能与logoutSuccessUrl共存，否则失效</span><br></pre></td></tr></table></figure>



<p><strong>完整Security配置类：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SecurityConfig</span> <span class="keyword">extends</span> <span class="title class_">WebSecurityConfigurerAdapter</span> &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//将我们自定义的这两个类使用IOC容器装配</span></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> MyAuthenticationSuccessHandler myAuthenticationSuccessHandler;  <span class="comment">//登录成功处理</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> MyAuthenticationFailureHandler myAuthenticationFailureHandler;  <span class="comment">//登录失败处理</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//导入自定义动态授权</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> MyUserDetailsService myUserDetailsService;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> DataSource dataSource;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//退出登录自定义策略</span></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> MyLogoutSuccessHandler myLogoutSuccessHandler;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 登录认证方法</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> http</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">//开启httpBasic认证</span></span><br><span class="line"><span class="comment">//        http.httpBasic()</span></span><br><span class="line"><span class="comment">//                .and()</span></span><br><span class="line"><span class="comment">//                //所有的请求</span></span><br><span class="line"><span class="comment">//                .authorizeHttpRequests()</span></span><br><span class="line"><span class="comment">//                //匹配规则</span></span><br><span class="line"><span class="comment">//                .anyRequest()</span></span><br><span class="line"><span class="comment">//                //所有请求都需要登录认证才可以访问</span></span><br><span class="line"><span class="comment">//                .authenticated();</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//_______________________________________________________________________________________________________-</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//开启formLogin登录认证</span></span><br><span class="line">        http.</span><br><span class="line">                logout()<span class="comment">//开启退出登录</span></span><br><span class="line"><span class="comment">//                .logoutSuccessUrl(&quot;/&quot;) //退出后跳转的页面  默认退出到login页面</span></span><br><span class="line">                .deleteCookies(<span class="string">&quot;JSESSIONID&quot;</span>) <span class="comment">//指定退出后要删除的cookie</span></span><br><span class="line">                .logoutUrl(<span class="string">&quot;/logout&quot;</span>)  <span class="comment">//退出请求路径，也就是页面上退出登录访问的地址  默认logout</span></span><br><span class="line">                .logoutSuccessHandler(myLogoutSuccessHandler) <span class="comment">//使用自定义退出策略 ，不能与logoutSuccessUrl共存，否则失效</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">                .and()</span><br><span class="line"></span><br><span class="line">                .rememberMe()<span class="comment">//开启记住我功能  ，前端也需要有记住我字段</span></span><br><span class="line">                .rememberMeCookieName(<span class="string">&quot;rememberMe-Cookie&quot;</span>)  <span class="comment">//存在浏览器中cookie的名称</span></span><br><span class="line">                .rememberMeParameter(<span class="string">&quot;remember-me&quot;</span>)  <span class="comment">//表单中 自动登录 勾选框的参数名</span></span><br><span class="line">                .tokenValiditySeconds(<span class="number">2</span>*<span class="number">24</span>*<span class="number">60</span>*<span class="number">60</span>) <span class="comment">//保存Cookie的有效期，默认2周</span></span><br><span class="line">                .tokenRepository(tokenRepository())  <span class="comment">//指定rememberMe存储到数据库规则方法</span></span><br><span class="line"></span><br><span class="line">                .and()</span><br><span class="line"></span><br><span class="line">                .csrf().disable()  <span class="comment">//关闭防御csrf攻击</span></span><br><span class="line">                .formLogin()<span class="comment">//开启formLogin登录认证</span></span><br><span class="line">                .loginPage(<span class="string">&quot;/logins&quot;</span>)    <span class="comment">//用于选择登录页面，没认证时跳转的页面</span></span><br><span class="line">                .loginProcessingUrl(<span class="string">&quot;/login&quot;</span>)   <span class="comment">//选择需要认证的请求，也就是登录表单的提交地址</span></span><br><span class="line">                .usernameParameter(<span class="string">&quot;user&quot;</span>)   <span class="comment">//选择登录请求的哪个参数是用户名</span></span><br><span class="line">                .passwordParameter(<span class="string">&quot;password&quot;</span>)   <span class="comment">//选择登录请求的哪个参数是密码</span></span><br><span class="line">                <span class="comment">//使用自定义的登录失败成功处理方法</span></span><br><span class="line">                .successHandler(myAuthenticationSuccessHandler)  <span class="comment">//登录成功</span></span><br><span class="line">                .failureHandler(myAuthenticationFailureHandler)  <span class="comment">//登录失败</span></span><br><span class="line"></span><br><span class="line">                <span class="comment">//这两会与我们自定义的冲突想要使用自定义的就不能使用这个</span></span><br><span class="line"><span class="comment">//                .defaultSuccessUrl(&quot;/&quot;)   //登录成功跳转的路径</span></span><br><span class="line"><span class="comment">//                .failureForwardUrl(&quot;/logins&quot;)  //登录失败跳转的路径</span></span><br><span class="line">             .and()</span><br><span class="line">                .authorizeRequests() <span class="comment">//自定义过滤拦截请求</span></span><br><span class="line">                .antMatchers(<span class="string">&quot;/logins&quot;</span>,<span class="string">&quot;/login&quot;</span>,<span class="string">&quot;/&quot;</span>) <span class="comment">//资源路径</span></span><br><span class="line">                .permitAll()  <span class="comment">//当前资源路径不需要认证就可以访问</span></span><br><span class="line">                <span class="comment">//____________________静态鉴权____________________________________</span></span><br><span class="line"><span class="comment">//                .antMatchers(&quot;/business1&quot;,&quot;/business2&quot;)//资源路径</span></span><br><span class="line"><span class="comment">//                .hasAnyAuthority(&quot;ROLE_user&quot;,&quot;ROLE_admin&quot;)//设置可以访问的角色,user角色和admin角色都可以访问</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//                    //访问角色控制方式1  与授权方法1一起使用</span></span><br><span class="line"><span class="comment">//                .antMatchers(&quot;/log&quot;,&quot;/user&quot;)//资源路径</span></span><br><span class="line"><span class="comment">//                .hasRole(&quot;admin&quot;)//设置可以访问的角色，和hasAnyAuthority作用相同，但hasAnyAuthority可以设置多个，并且需要加前缀ROLE_</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//                    //访问角色控制方式2  与授权方法2一起使用  这里由于它不是admin角色了，所有访问业务1业务2访问不了但可以修改一下</span></span><br><span class="line"><span class="comment">////                .antMatchers(&quot;/user&quot;).hasAnyAuthority(&quot;sys:user&quot;)  // /user资源路径 必须拥有sys:user角色才可访问</span></span><br><span class="line"><span class="comment">////                .antMatchers(&quot;/log&quot;).hasAnyAuthority(&quot;sys:log&quot;) // /log资源路径 必须拥有sys:log角色才可访问</span></span><br><span class="line"><span class="comment">//                //选择的匹配规则</span></span><br><span class="line"><span class="comment">//                .anyRequest()</span></span><br><span class="line"><span class="comment">//                //所有请求都需要登录认证才可以访问</span></span><br><span class="line"><span class="comment">//                .authenticated()</span></span><br><span class="line"></span><br><span class="line">                <span class="comment">//______________________________动态图鉴权_____________________________________________</span></span><br><span class="line">                    <span class="comment">//所有的请求都有经过MyRBACService的hasPermission方法进行鉴权 返回true可以访问，返回false不允许访问</span></span><br><span class="line">                .anyRequest().access(<span class="string">&quot;@MyRBACService.hasPermission(request,authentication)&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">                .and()</span><br><span class="line">                .sessionManagement()<span class="comment">//启用session管理</span></span><br><span class="line">                .maximumSessions(<span class="number">1</span>)<span class="comment">//允许一个账号你个人同时登录，也就是一个session可以几个人同时使用</span></span><br><span class="line">                .maxSessionsPreventsLogin(<span class="literal">false</span>)<span class="comment">//false：当登录时，其它登录的登录的地方会被踢下线;true ：当有用户在登录时不允许登录</span></span><br><span class="line">                .expiredSessionStrategy(<span class="keyword">new</span> <span class="title class_">CustomExpiredSessionStrategy</span>());  <span class="comment">//session超时，被踢下线的自定义操作</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">//.authorizeHttpRequests()   这样方法表示选中的请求</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 授权方法</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> auth</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(AuthenticationManagerBuilder auth)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//____________________静态授权________________________</span></span><br><span class="line"><span class="comment">//                auth  //授权</span></span><br><span class="line"><span class="comment">//                .inMemoryAuthentication()  //将这种用户添加到内存中登录认证，   还有其他类型的授权登录认证方法，比如数据库的登录认证</span></span><br><span class="line"><span class="comment">//                .withUser(&quot;user&quot;)  //用户名</span></span><br><span class="line"><span class="comment">//                .password(passwordEncoder().encode(&quot;123456&quot;))  //密码</span></span><br><span class="line"><span class="comment">//                .roles(&quot;user&quot;)  //设置使用该用户名登录赋予的角色，</span></span><br><span class="line"><span class="comment">//            .and()</span></span><br><span class="line"><span class="comment">//                 .withUser(&quot;admin&quot;) //用户名</span></span><br><span class="line"><span class="comment">//                 .password(passwordEncoder().encode(&quot;123456&quot;))</span></span><br><span class="line"><span class="comment">//                   //第一种授权方式</span></span><br><span class="line"><span class="comment">//                 .roles(&quot;admin&quot;)  //设置使用该账号登录赋予的角色</span></span><br><span class="line"><span class="comment">//                   //第二种授权方式</span></span><br><span class="line"><span class="comment">//                 //.authorities(&quot;sys:log&quot;,&quot;sys:user&quot;) //</span></span><br><span class="line"><span class="comment">//                    .and().passwordEncoder(passwordEncoder()); //配置BCrypt加密，这个会自动调用matches（）这个方法来为我们输入的密码进行对比</span></span><br><span class="line">        <span class="comment">//________________ 动态授权，需要实现UserDetailsService____________________________</span></span><br><span class="line">            auth.userDetailsService(myUserDetailsService)</span><br><span class="line">                  .passwordEncoder(passwordEncoder());  <span class="comment">//配置BCrypt加密，这个会自动调用matches（）这个方法来为我们输入的密码进行对比</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> PasswordEncoder <span class="title function_">passwordEncoder</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">BCryptPasswordEncoder</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 静态资源路径开放</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> web</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(WebSecurity web)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">//将项目中的静态资源路径开放出来，在这开放是不需要经过过滤器拦截的</span></span><br><span class="line">        web.ignoring().antMatchers(<span class="string">&quot;/css/**&quot;</span>,<span class="string">&quot;/fonts/**&quot;</span>,<span class="string">&quot;/img/**&quot;</span>,<span class="string">&quot;/js/**&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * JdbcTokenRepositoryImpl 这个类中已经固定要存到数据库中的哪个表，我们只需要指定数据源即可</span></span><br><span class="line"><span class="comment">     * initDao() 这个方法有在数据库中创建需要的表，我还没尝试过，我的表是自己手动创建的</span></span><br><span class="line"><span class="comment">     * 设置记住我存储到的数据源是哪个</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> PersistentTokenRepository <span class="title function_">tokenRepository</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="type">JdbcTokenRepositoryImpl</span> <span class="variable">jdbcTokenRepository</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JdbcTokenRepositoryImpl</span>();</span><br><span class="line">        jdbcTokenRepository.setDataSource(dataSource);</span><br><span class="line">        <span class="keyword">return</span> jdbcTokenRepository;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>









<h2 id="Session方式实现图片验证码"><a href="#Session方式实现图片验证码" class="headerlink" title="Session方式实现图片验证码:"></a>Session方式实现图片验证码:</h2><h3 id="配置："><a href="#配置：" class="headerlink" title="配置："></a>配置：</h3><p>我们需要先导入工具类库</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--   验证码工具类库  这是Google提供的一个类库   --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.github.penggle<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>kaptcha<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.3.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">exclusions</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>javax.servlet-api<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>javax.servlet<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">exclusions</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>



<p><img src="https://s2.loli.net/2022/03/21/UtEnrpe3u1wLfqc.png" alt="image-20220312105200767"></p>
<p>如何我们需要这个类库配置一下参数，</p>
<p>有两种方式，第一种是使用application.properties 这种方式直接配置，第二种就是自己直接手动配置</p>
<h5 id="第一种方式："><a href="#第一种方式：" class="headerlink" title="第一种方式："></a><strong>第一种方式：</strong></h5><p>直接将配置文件写入</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">kaptcha.border</span>=<span class="string">no</span></span><br><span class="line"><span class="attr">kaptcha.border.color</span>=<span class="string">105,179,90</span></span><br><span class="line"><span class="attr">kaptcha.image.width</span>=<span class="string">100</span></span><br><span class="line"><span class="attr">kaptcha.image.height</span>=<span class="string">45</span></span><br><span class="line"><span class="attr">kaptcha.session.key</span>=<span class="string">code</span></span><br><span class="line"><span class="attr">kaptcha.textproducer.font.color</span>=<span class="string">blue</span></span><br><span class="line"><span class="attr">kaptcha.textproducer.font.size</span>=<span class="string">35</span></span><br><span class="line"><span class="attr">kaptcha.textproducer.font.names</span>=<span class="string">宋体,楷体,微软雅黑</span></span><br><span class="line"><span class="attr">kaptcha.textproducer.char.length</span>=<span class="string">4</span></span><br></pre></td></tr></table></figure>



<h5 id="第二种方式："><a href="#第二种方式：" class="headerlink" title="第二种方式："></a><strong>第二种方式：</strong></h5><p>先创建一个properties的普通文件再将这些导入：</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">kaptcha.border</span>=<span class="string">no</span></span><br><span class="line"><span class="attr">kaptcha.border.color</span>=<span class="string">105,179,90</span></span><br><span class="line"><span class="attr">kaptcha.image.width</span>=<span class="string">100</span></span><br><span class="line"><span class="attr">kaptcha.image.height</span>=<span class="string">45</span></span><br><span class="line"><span class="attr">kaptcha.session.key</span>=<span class="string">code</span></span><br><span class="line"><span class="attr">kaptcha.textproducer.font.color</span>=<span class="string">blue</span></span><br><span class="line"><span class="attr">kaptcha.textproducer.font.size</span>=<span class="string">35</span></span><br><span class="line"><span class="attr">kaptcha.textproducer.font.names</span>=<span class="string">宋体,楷体,微软雅黑</span></span><br><span class="line"><span class="attr">kaptcha.textproducer.char.length</span>=<span class="string">4</span></span><br></pre></td></tr></table></figure>



<h5 id="再创建一个配置类："><a href="#再创建一个配置类：" class="headerlink" title="再创建一个配置类："></a><strong>再创建一个配置类：</strong></h5><p>这个是使用的第二种方式，所以我们这个需要使用@PropertySource()去导入一下我们的properties文件，如何使用2Value注入下 </p>
<p>其实两种方式都一样，只是一个需要使用@PropertySource() 去导入，一个可以直接使用@Value注入</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@PropertySource(value = &#123;&quot;classpath:kaptcha.properties&quot;&#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">KaptChaConf</span> &#123;</span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;kaptcha.border&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String border;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;kaptcha.border.color&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String borderColor;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;kaptcha.textproducer.font.color&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String fontColor;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;kaptcha.image.width&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String imageWidth;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;kaptcha.image.height&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String imageHeight;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;kaptcha.session.key&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String sessionKey;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;kaptcha.textproducer.char.length&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String charLength;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;kaptcha.textproducer.font.names&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String fontNames;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;kaptcha.textproducer.font.size&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String fontSize;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean(&quot;captchaProducer&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> DefaultKaptcha <span class="title function_">getKaptCha</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="comment">//拥有创建谜底和谜面的方法, createImage(String text)创建谜面图片，createText()创建谜底文字</span></span><br><span class="line">        <span class="type">DefaultKaptcha</span> <span class="variable">defaultKaptcha</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DefaultKaptcha</span>();</span><br><span class="line"></span><br><span class="line">        <span class="type">Properties</span> <span class="variable">properties</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Properties</span>();</span><br><span class="line">        properties.setProperty(<span class="string">&quot;kaptcha.border&quot;</span>,border);</span><br><span class="line">        properties.setProperty(<span class="string">&quot;kaptcha.border.color&quot;</span>,borderColor);</span><br><span class="line">        properties.setProperty(<span class="string">&quot;kaptcha.image.width&quot;</span>,imageWidth);</span><br><span class="line">        properties.setProperty(<span class="string">&quot;kaptcha.image.height&quot;</span>,imageHeight);</span><br><span class="line">        properties.setProperty(<span class="string">&quot;kaptcha.session.key&quot;</span>,sessionKey);</span><br><span class="line">        properties.setProperty(<span class="string">&quot;kaptcha.textproducer.font.color&quot;</span>,fontColor);</span><br><span class="line">        properties.setProperty(<span class="string">&quot;kaptcha.textproducer.font.size&quot;</span>,fontSize);</span><br><span class="line">        properties.setProperty(<span class="string">&quot;kaptcha.textproducer.font.names&quot;</span>,fontNames);</span><br><span class="line">        properties.setProperty(<span class="string">&quot;kaptcha.textproducer.char.length&quot;</span>,charLength);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//设置Kaptcha的配置 ,</span></span><br><span class="line">        defaultKaptcha.setConfig(<span class="keyword">new</span> <span class="title class_">Config</span>(properties));</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> defaultKaptcha;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<h3 id="实现图片验证码加载："><a href="#实现图片验证码加载：" class="headerlink" title="实现图片验证码加载："></a>实现图片验证码加载：</h3><h5 id="存储谜底与验证码过期时间类"><a href="#存储谜底与验证码过期时间类" class="headerlink" title="存储谜底与验证码过期时间类"></a>存储谜底与验证码过期时间类</h5><p>由于图片验证码有过期时间，我们需要先创建一个类了存储我们图片验证码的谜底与过期数据</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 存储谜底与验证码过期时间</span></span><br><span class="line"><span class="comment"> * 用于实现验证码过期，所有创建此类</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CaptchaImageVo</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String captchaCode; <span class="comment">//验证码谜底</span></span><br><span class="line">    <span class="keyword">private</span> LocalDateTime expireTime;  <span class="comment">//验证码过期时间</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 用于初始化</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> captchaCode  谜底</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> expireAfterSeconds  过期秒数</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">CaptchaImageVo</span><span class="params">(String captchaCode,<span class="type">int</span> expireAfterSeconds)</span>&#123;</span><br><span class="line">        <span class="built_in">this</span>.captchaCode=captchaCode;</span><br><span class="line">        <span class="comment">//当前时间加上指定的秒数</span></span><br><span class="line">        <span class="built_in">this</span>.expireTime = LocalDateTime.now().plusSeconds(expireAfterSeconds);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 判断验证码是否过期</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isExpired</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="comment">//判断当前时间是否大于过期时间，大于则失效</span></span><br><span class="line">        <span class="keyword">return</span> LocalDateTime.now().isAfter(expireTime);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取captchaCode</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getCoed</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> captchaCode;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h5 id="验证码图片Controller："><a href="#验证码图片Controller：" class="headerlink" title="验证码图片Controller："></a>验证码图片Controller：</h5><p>我们需要将验证码图片输出到页面，所以我们需要一个controller用来输出，图片我们需要使用流来输出：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CaptchaController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> DefaultKaptcha defaultKaptcha;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/kaptcha&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">kaptcha</span><span class="params">(HttpSession session, HttpServletResponse response)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line"></span><br><span class="line">        response.setDateHeader(<span class="string">&quot;Expires&quot;</span>,<span class="number">0</span>);</span><br><span class="line">        response.setHeader(<span class="string">&quot;Cache-Control&quot;</span>,<span class="string">&quot;no-store, no-cache, must-revalidate&quot;</span>);</span><br><span class="line">        response.addHeader(<span class="string">&quot;Cache-Control&quot;</span>,<span class="string">&quot;post-check=0, pre-check=0&quot;</span>);</span><br><span class="line">        response.setHeader(<span class="string">&quot;Pragma&quot;</span>,<span class="string">&quot;no-cache&quot;</span>);</span><br><span class="line">        response.setContentType(<span class="string">&quot;image/jpeg&quot;</span>);</span><br><span class="line">        <span class="comment">//获取谜底</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">text</span> <span class="operator">=</span> defaultKaptcha.createText();</span><br><span class="line">        <span class="comment">//将谜底与过期时间放到session中</span></span><br><span class="line">        session.setAttribute(<span class="string">&quot;captcha_key&quot;</span>,<span class="keyword">new</span> <span class="title class_">CaptchaImageVo</span>(text,<span class="number">2</span>*<span class="number">60</span>));</span><br><span class="line"></span><br><span class="line">        <span class="comment">//这个方式使用我们不用自己去关闭流，它自动关闭，这是jdk7的语法</span></span><br><span class="line">        <span class="keyword">try</span>(ServletOutputStream out=response.getOutputStream())&#123;</span><br><span class="line">            <span class="type">BufferedImage</span> <span class="variable">image</span> <span class="operator">=</span> defaultKaptcha.createImage(text);</span><br><span class="line">            <span class="comment">//将图片以Io输出， 参数： 图片的字节 ， 图片格式 ，输入流</span></span><br><span class="line">            ImageIO.write(image,<span class="string">&quot;jpg&quot;</span>,out);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//每当缓冲区数据进入满载状态时，会对数据进行一次写出。</span></span><br><span class="line">            <span class="comment">// 假如最后一次的数据量没有达到让缓冲区进入满载状态，这时候不主动调用flush()方法缓冲区数据将会丢失</span></span><br><span class="line">            out.flush();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<h5 id="前端接收："><a href="#前端接收：" class="headerlink" title="前端接收："></a>前端接收：</h5><p>千万记着鉴权那开放访问权限</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;https://code.jquery.com/jquery-3.0.0.min.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">h1</span>&gt;</span>登录<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">&quot;/login&quot;</span> <span class="attr">method</span>=<span class="string">&quot;post&quot;</span>&gt;</span></span><br><span class="line">    账号：<span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">id</span>=<span class="string">&quot;username&quot;</span> <span class="attr">name</span>=<span class="string">&quot;user&quot;</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">    密码：<span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;password&quot;</span> <span class="attr">id</span>=<span class="string">&quot;password&quot;</span> <span class="attr">name</span>=<span class="string">&quot;password&quot;</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">    验证码:<span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">id</span>=<span class="string">&quot;captchaCoed&quot;</span> <span class="attr">name</span>=<span class="string">&quot;captchaCoed&quot;</span>&gt;</span><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">&quot;/kaptcha&quot;</span> <span class="attr">id</span>=<span class="string">&quot;kaptcha&quot;</span> <span class="attr">width</span>=<span class="string">&quot;110px&quot;</span> <span class="attr">height</span>=<span class="string">&quot;40px&quot;</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;button&quot;</span> <span class="attr">onclick</span>=<span class="string">&quot;login()&quot;</span> <span class="attr">value</span>=<span class="string">&quot;登录&quot;</span>&gt;</span></span><br><span class="line">     记住我<span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;checkbox&quot;</span> <span class="attr">name</span>=<span class="string">&quot;remember-me&quot;</span> <span class="attr">id</span>=<span class="string">&quot;remember-me&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    $(<span class="keyword">function</span> (<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">        <span class="comment">//用于点击刷新验证码图片</span></span></span><br><span class="line"><span class="language-javascript">        $(<span class="string">&quot;#kaptcha&quot;</span>).<span class="title function_">click</span>(<span class="keyword">function</span> (<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">            $(<span class="string">&quot;#kaptcha&quot;</span>).<span class="title function_">attr</span>(<span class="string">&quot;src&quot;</span>,<span class="string">&quot;/kaptcha?&quot;</span>+<span class="title class_">Math</span>.<span class="title function_">floor</span>(<span class="title class_">Math</span>.<span class="title function_">random</span>()*<span class="number">100</span>))</span></span><br><span class="line"><span class="language-javascript">        &#125;)</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    &#125;)</span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">function</span> <span class="title function_">login</span>(<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">let</span> username=$(<span class="string">&quot;#username&quot;</span>).<span class="title function_">val</span>();</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">let</span> password=$(<span class="string">&quot;#password&quot;</span>).<span class="title function_">val</span>();</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">let</span> remember=$(<span class="string">&quot;#remember-me&quot;</span>).<span class="title function_">prop</span>(<span class="string">&quot;checked&quot;</span>);</span></span><br><span class="line"><span class="language-javascript">        <span class="title function_">alert</span>(remember)</span></span><br><span class="line"><span class="language-javascript">        $.<span class="title function_">ajax</span>(&#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="attr">type</span>: <span class="string">&quot;POST&quot;</span>,</span></span><br><span class="line"><span class="language-javascript">            <span class="attr">url</span>: <span class="string">&quot;/login&quot;</span>,</span></span><br><span class="line"><span class="language-javascript">            <span class="attr">data</span>: &#123;</span></span><br><span class="line"><span class="language-javascript">                <span class="string">&quot;user&quot;</span>: username,</span></span><br><span class="line"><span class="language-javascript">                <span class="string">&quot;password&quot;</span>: password,</span></span><br><span class="line"><span class="language-javascript">                <span class="string">&quot;remember-me&quot;</span>:remember</span></span><br><span class="line"><span class="language-javascript">            &#125;,</span></span><br><span class="line"><span class="language-javascript">            <span class="attr">success</span>: <span class="keyword">function</span> (<span class="params">json</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">              <span class="keyword">if</span> (json.<span class="property">state</span> == <span class="number">200</span>)&#123;</span></span><br><span class="line"><span class="language-javascript">                  <span class="variable language_">console</span>.<span class="title function_">log</span>(json)</span></span><br><span class="line"><span class="language-javascript">                  location.<span class="property">href</span>=<span class="string">&quot;/&quot;</span>;</span></span><br><span class="line"><span class="language-javascript">              &#125;<span class="keyword">else</span> &#123;</span></span><br><span class="line"><span class="language-javascript">                  <span class="title function_">alert</span>(json.<span class="property">message</span>)</span></span><br><span class="line"><span class="language-javascript">                  <span class="variable language_">console</span>.<span class="title function_">log</span>(json)</span></span><br><span class="line"><span class="language-javascript">                  location.<span class="property">href</span>=<span class="string">&quot;/logins&quot;</span>;</span></span><br><span class="line"><span class="language-javascript">              &#125;</span></span><br><span class="line"><span class="language-javascript">            &#125;,</span></span><br><span class="line"><span class="language-javascript">            <span class="attr">error</span>: <span class="keyword">function</span> (<span class="params">e</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">                </span></span><br><span class="line"><span class="language-javascript">            &#125;</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">        &#125;)</span></span><br><span class="line"><span class="language-javascript">    &#125;</span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br></pre></td></tr></table></figure>





<h3 id="图片验证码验证："><a href="#图片验证码验证：" class="headerlink" title="图片验证码验证："></a>图片验证码验证：</h3><p><img src="https://s2.loli.net/2022/03/21/v839L1PAlIVgajO.png" alt="image-20220313101138743"></p>
<p>如图所示，我们需要创建一个验证码过滤器，并且在usernamepasswordAuthentionFilter之前执行</p>
<h5 id="在这其中要我们需要修改下原来的登录错误处理类："><a href="#在这其中要我们需要修改下原来的登录错误处理类：" class="headerlink" title="在这其中要我们需要修改下原来的登录错误处理类："></a><strong>在这其中要我们需要修改下原来的登录错误处理类：</strong></h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * 登录失败后进行的操作</span><br><span class="line"> */</span><br><span class="line">@Component</span><br><span class="line">public class MyAuthenticationFailureHandler</span><br><span class="line">    extends SimpleUrlAuthenticationFailureHandler &#123;</span><br><span class="line"></span><br><span class="line">    //注意这个一定要使用el表达式，否则这个方法都不会进</span><br><span class="line">    @Value(&quot;$&#123;spring.security.loginType&#125;&quot;)</span><br><span class="line">    private String loginType;</span><br><span class="line"></span><br><span class="line">    //用于将对象转换为json格式</span><br><span class="line">    private static ObjectMapper objectMapper = new ObjectMapper();</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 登录失败后进行操作</span><br><span class="line">     * @param request 请求</span><br><span class="line">     * @param response 响应</span><br><span class="line">     * @param exception  异常</span><br><span class="line">     * @throws IOException</span><br><span class="line">     * @throws ServletException</span><br><span class="line">     */</span><br><span class="line">    @Override</span><br><span class="line">    public void onAuthenticationFailure(HttpServletRequest request, HttpServletResponse response, AuthenticationException exception) throws IOException, ServletException &#123;</span><br><span class="line"></span><br><span class="line">        //错误信息</span><br><span class="line">        String errorMsg=&quot;登录失败,用户名或密码错误&quot;;</span><br><span class="line"></span><br><span class="line">        //判断异常是否是SessionAuthenticationException类型，这个类型是验证码校验那抛出的异常</span><br><span class="line">        if (exception instanceof SessionAuthenticationException)&#123;</span><br><span class="line">            //将错误信息赋给错误信息返回出去</span><br><span class="line">            errorMsg=exception.getMessage();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        //判断要返回的类型</span><br><span class="line">        if (loginType.equalsIgnoreCase(&quot;JSON&quot;))&#123;</span><br><span class="line">            //告诉浏览器，以json返回</span><br><span class="line">            response.setContentType(&quot;application/json;charset=UTF-8&quot;);</span><br><span class="line">            //要返回的数据</span><br><span class="line">            response.getWriter().write(objectMapper.writeValueAsString(new JsonResult&lt;&gt;().InputError(errorMsg)));</span><br><span class="line">        &#125;else &#123;</span><br><span class="line">            //登录失败后进行的页面跳转，父类已经为我们实现了</span><br><span class="line">            response.setContentType(&quot;application/html;charset=UTF-8&quot;);</span><br><span class="line">            super.onAuthenticationFailure(request, response, exception);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h5 id="并且我们定义一个常量类，为了跟方便记住重复参数信息："><a href="#并且我们定义一个常量类，为了跟方便记住重复参数信息：" class="headerlink" title="并且我们定义一个常量类，为了跟方便记住重复参数信息："></a><strong>并且我们定义一个常量类，为了跟方便记住重复参数信息：</strong></h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">public class CaptchaConstant &#123;</span><br><span class="line">    public static final String CAPTCHA_SESSION_KEY=&quot;captcha_key&quot;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h5 id="创建过滤器："><a href="#创建过滤器：" class="headerlink" title="创建过滤器："></a>创建过滤器：</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * 自定义过滤器 ，在登录身份校验前先进行检查，验证码是否正确</span><br><span class="line"> * 也可以使用Filter</span><br><span class="line"> * OncePerRequestFilter是Filter的实现类</span><br><span class="line"> * OncePerRequestFilter 每次登录都拦截一次，</span><br><span class="line"> */</span><br><span class="line">@Component</span><br><span class="line">public class CaptchaCodeFilter extends OncePerRequestFilter &#123;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 这是我们自定义登录失败的处理方式</span><br><span class="line">     */</span><br><span class="line">    @Autowired</span><br><span class="line">    private MyAuthenticationFailureHandler myAuthenticationFailureHandler;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    protected void doFilterInternal(HttpServletRequest request,</span><br><span class="line">                                    HttpServletResponse response,</span><br><span class="line">                                    FilterChain filterChain)</span><br><span class="line">            throws ServletException, IOException &#123;</span><br><span class="line"></span><br><span class="line">        //判断当前请求是否是向/login发送请求，并且是以post请求提交的</span><br><span class="line">        if (&quot;/login&quot;.equals(request.getRequestURI())</span><br><span class="line">                &amp;&amp; &quot;post&quot;.equalsIgnoreCase(request.getMethod()))&#123;</span><br><span class="line"></span><br><span class="line">            try &#123;</span><br><span class="line">                //验证码校验操作</span><br><span class="line">                captchaVerify(request);</span><br><span class="line">            &#125;catch (AuthenticationException e)&#123;</span><br><span class="line">                //SessionAuthenticationException这个异常是继承了AuthenticationException的</span><br><span class="line">                //我们自定义异常时同样也需继承AuthenticationException</span><br><span class="line">                //我们将错误处理交给登录实现处理类进行操作</span><br><span class="line">                myAuthenticationFailureHandler.onAuthenticationFailure(request,response,e);</span><br><span class="line">                //由于这里已经是发生了异常的，我们就不能让程序再进行往下走了</span><br><span class="line">                return;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        //如果验证成功后不是登录操作就进行放行</span><br><span class="line">        filterChain.doFilter(request,response);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 验证码验证操作</span><br><span class="line">     * 里面的异常是可以自定义的，不一定就要用系统提供的</span><br><span class="line">     */</span><br><span class="line">    private void captchaVerify(HttpServletRequest request)&#123;</span><br><span class="line"></span><br><span class="line">        //获取session，session中有用户的谜底与验证码过期时间</span><br><span class="line">        HttpSession session = request.getSession();</span><br><span class="line"></span><br><span class="line">        //获取用户输入的验证码</span><br><span class="line">        String captchaCoed = request.getParameter(&quot;captchaCoed&quot;);</span><br><span class="line">        System.out.println(captchaCoed);</span><br><span class="line"></span><br><span class="line">        //判断用户输入的验证码是否为空</span><br><span class="line">        if (captchaCoed.trim().isEmpty())&#123;</span><br><span class="line">            throw new SessionAuthenticationException(&quot;验证码不能为空&quot;);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        //获取我们存入session中的CaptchaImageVo，也就是谜底与过期时间类</span><br><span class="line">        CaptchaImageVo captchaImageVo = (CaptchaImageVo)session.getAttribute(CaptchaConstant.CAPTCHA_SESSION_KEY);</span><br><span class="line">        System.out.println(captchaImageVo.getCoed());</span><br><span class="line">        //判断session中使用有谜底</span><br><span class="line">        if (Objects.isNull(captchaImageVo))&#123;</span><br><span class="line">            throw new SessionAuthenticationException(&quot;验证码不存在&quot;);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        //判断验证码是否过期</span><br><span class="line">        if (captchaImageVo.isExpired())&#123;</span><br><span class="line">            //移出以前的CaptchaImageVo</span><br><span class="line">            session.removeAttribute(CaptchaConstant.CAPTCHA_SESSION_KEY);</span><br><span class="line">            throw new SessionAuthenticationException(&quot;验证码已过期&quot;);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        //判断用户输入的验证码是否与谜底一致，getCoed()这个方法就是单纯的获取captchaImageVo中的coed</span><br><span class="line">        if (!captchaCoed.trim().equalsIgnoreCase(captchaImageVo.getCoed()))&#123;</span><br><span class="line">            throw new SessionAuthenticationException(&quot;验证码不匹配&quot;);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h5 id="Security配置类：-1"><a href="#Security配置类：-1" class="headerlink" title="Security配置类："></a>Security配置类：</h5><p>在配置中配置在UsernamePasswordAuthenticationFilter之前插入我们创建的过滤器</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br></pre></td><td class="code"><pre><span class="line">@Configuration</span><br><span class="line">public class SecurityConfig extends WebSecurityConfigurerAdapter &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    //将我们自定义的这两个类使用IOC容器装配</span><br><span class="line">    @Autowired</span><br><span class="line">    private MyAuthenticationSuccessHandler myAuthenticationSuccessHandler;  //登录成功处理</span><br><span class="line"></span><br><span class="line">    @Autowired</span><br><span class="line">    private MyAuthenticationFailureHandler myAuthenticationFailureHandler;  //登录失败处理</span><br><span class="line"></span><br><span class="line">    //导入自定义动态授权</span><br><span class="line"></span><br><span class="line">    @Autowired</span><br><span class="line">    private MyUserDetailsService myUserDetailsService;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    @Autowired</span><br><span class="line">    private DataSource dataSource;</span><br><span class="line"></span><br><span class="line">    //退出登录自定义策略</span><br><span class="line">    @Autowired</span><br><span class="line">    private MyLogoutSuccessHandler myLogoutSuccessHandler;</span><br><span class="line"></span><br><span class="line">    //验证码过滤器</span><br><span class="line">    @Autowired</span><br><span class="line">    private CaptchaCodeFilter captchaCodeFilter;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 登录认证方法</span><br><span class="line">     * @param http</span><br><span class="line">     * @throws Exception</span><br><span class="line">     */</span><br><span class="line">    @Override</span><br><span class="line">    protected void configure(HttpSecurity http) throws Exception &#123;</span><br><span class="line"></span><br><span class="line">        //开启formLogin登录认证</span><br><span class="line">        http.</span><br><span class="line">                //将验证码过滤器放置在UsernamePasswordAuthenticationFilter过滤器之前执行，AOP思想</span><br><span class="line">                addFilterBefore(captchaCodeFilter, UsernamePasswordAuthenticationFilter.class)</span><br><span class="line">                .logout()//开启退出登录</span><br><span class="line">//                .logoutSuccessUrl(&quot;/&quot;) //退出后跳转的页面  默认退出到login页面</span><br><span class="line">                .deleteCookies(&quot;JSESSIONID&quot;) //指定退出后要删除的cookie</span><br><span class="line">                .logoutUrl(&quot;/logout&quot;)  //退出请求路径，也就是页面上退出登录访问的地址  默认logout</span><br><span class="line">                .logoutSuccessHandler(myLogoutSuccessHandler) //使用自定义退出策略 ，不能与logoutSuccessUrl共存，否则失效</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">                .and()</span><br><span class="line"></span><br><span class="line">                .rememberMe()//开启记住我功能  ，前端也需要有记住我字段</span><br><span class="line">                .rememberMeCookieName(&quot;rememberMe-Cookie&quot;)  //存在浏览器中cookie的名称</span><br><span class="line">                .rememberMeParameter(&quot;remember-me&quot;)  //表单中 自动登录 勾选框的参数名</span><br><span class="line">                .tokenValiditySeconds(2*24*60*60) //保存Cookie的有效期，默认2周</span><br><span class="line">                .tokenRepository(tokenRepository())  //指定rememberMe存储到数据库规则方法</span><br><span class="line"></span><br><span class="line">                .and()</span><br><span class="line"></span><br><span class="line">                .csrf().disable()  //关闭防御csrf攻击</span><br><span class="line">                .formLogin()//开启formLogin登录认证</span><br><span class="line">                .loginPage(&quot;/logins&quot;)    //用于选择登录页面，没认证时跳转的页面</span><br><span class="line">                .loginProcessingUrl(&quot;/login&quot;)   //选择需要认证的请求，也就是登录表单的提交地址</span><br><span class="line">                .usernameParameter(&quot;user&quot;)   //选择登录请求的哪个参数是用户名</span><br><span class="line">                .passwordParameter(&quot;password&quot;)   //选择登录请求的哪个参数是密码</span><br><span class="line">                //使用自定义的登录失败成功处理方法</span><br><span class="line">                .successHandler(myAuthenticationSuccessHandler)  //登录成功</span><br><span class="line">                .failureHandler(myAuthenticationFailureHandler)  //登录失败</span><br><span class="line"></span><br><span class="line">                //这两会与我们自定义的冲突想要使用自定义的就不能使用这个</span><br><span class="line">//                .defaultSuccessUrl(&quot;/&quot;)   //登录成功跳转的路径</span><br><span class="line">//                .failureForwardUrl(&quot;/logins&quot;)  //登录失败跳转的路径</span><br><span class="line">             .and()</span><br><span class="line">                .authorizeRequests() //自定义过滤拦截请求</span><br><span class="line">                .antMatchers(&quot;/logins&quot;,&quot;/login&quot;,&quot;/&quot;,&quot;/kaptcha&quot;) //资源路径</span><br><span class="line">                .permitAll()  //当前资源路径不需要认证就可以访问</span><br><span class="line"></span><br><span class="line">                //______________________________动态图鉴权_____________________________________________</span><br><span class="line">                    //所有的请求都有经过MyRBACService的hasPermission方法进行鉴权 返回true可以访问，返回false不允许访问</span><br><span class="line">                .anyRequest().access(&quot;@MyRBACService.hasPermission(request,authentication)&quot;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">                .and()</span><br><span class="line">                .sessionManagement()//启用session管理</span><br><span class="line">                .maximumSessions(1)//允许一个账号你个人同时登录，也就是一个session可以几个人同时使用</span><br><span class="line">                .maxSessionsPreventsLogin(false)//false：当登录时，其它登录的登录的地方会被踢下线;true ：当有用户在登录时不允许登录</span><br><span class="line">                .expiredSessionStrategy(new CustomExpiredSessionStrategy());  //session超时，被踢下线的自定义操作</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        //.authorizeHttpRequests()   这样方法表示选中的请求</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 授权方法</span><br><span class="line">     * @param auth</span><br><span class="line">     * @throws Exception</span><br><span class="line">     */</span><br><span class="line">    @Override</span><br><span class="line">    protected void configure(AuthenticationManagerBuilder auth) throws Exception &#123;</span><br><span class="line"></span><br><span class="line">        //________________ 动态授权，需要实现UserDetailsService____________________________</span><br><span class="line">            auth.userDetailsService(myUserDetailsService)</span><br><span class="line">                  .passwordEncoder(passwordEncoder());  //配置BCrypt加密，这个会自动调用matches（）这个方法来为我们输入的密码进行对比</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Bean</span><br><span class="line">    public PasswordEncoder passwordEncoder()&#123;</span><br><span class="line">        return new BCryptPasswordEncoder();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 静态资源路径开放</span><br><span class="line">     * @param web</span><br><span class="line">     * @throws Exception</span><br><span class="line">     */</span><br><span class="line">    @Override</span><br><span class="line">    public void configure(WebSecurity web) throws Exception &#123;</span><br><span class="line">        //将项目中的静态资源路径开放出来，在这开放是不需要经过过滤器拦截的</span><br><span class="line">        web.ignoring().antMatchers(&quot;/css/**&quot;,&quot;/fonts/**&quot;,&quot;/img/**&quot;,&quot;/js/**&quot;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * JdbcTokenRepositoryImpl 这个类中已经固定要存到数据库中的哪个表，我们只需要指定数据源即可</span><br><span class="line">     * initDao() 这个方法有在数据库中创建需要的表，我还没尝试过，我的表是自己手动创建的</span><br><span class="line">     * 设置记住我存储到的数据源是哪个</span><br><span class="line">     * @return</span><br><span class="line">     */</span><br><span class="line">    @Bean</span><br><span class="line">    public PersistentTokenRepository tokenRepository()&#123;</span><br><span class="line">        JdbcTokenRepositoryImpl jdbcTokenRepository = new JdbcTokenRepositoryImpl();</span><br><span class="line">        jdbcTokenRepository.setDataSource(dataSource);</span><br><span class="line">        return jdbcTokenRepository;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>









<h2 id="手机号验证码登录："><a href="#手机号验证码登录：" class="headerlink" title="手机号验证码登录："></a>手机号验证码登录：</h2><h3 id="分析："><a href="#分析：" class="headerlink" title="分析："></a>分析：</h3><p><img src="https://s2.loli.net/2022/03/21/7jINUlQWAoY1edS.png" alt="image-20220316233213777"></p>
<p><strong>使用到的常量：</strong>public static final String PHONE_SESSION_KEY &#x3D; “phoneCaptcha”;</p>
<p>这是我们实现短信验证码登录需要实现发：SMS 在我这用Phone代替</p>
<p>我们需要先创建一个为我们提供发送的验证码的Controller，这个很好理解吧，点击获取验证码，如何发送短信验证码至手机号短信</p>
<h3 id="controller："><a href="#controller：" class="headerlink" title="controller："></a>controller：</h3><p>创建验证码并发送给用户手机号，还有放入session以便登录验证</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">@Slf4j</span><br><span class="line">@RestController</span><br><span class="line">public class phoneController &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    @Autowired</span><br><span class="line">    private MyUserDetailsService myUserDetailsService;</span><br><span class="line"></span><br><span class="line">    //创建手机验证码</span><br><span class="line">    @GetMapping(&quot;/smscode&quot;)</span><br><span class="line">    public JsonResult sms(String phone , HttpSession session)&#123;</span><br><span class="line"></span><br><span class="line">        //判断当前号码用户是否存在</span><br><span class="line">        try &#123;</span><br><span class="line">            UserDetails userDetails = myUserDetailsService.loadUserByUsername(phone);</span><br><span class="line">        &#125;catch (Exception e)&#123;</span><br><span class="line">            return new JsonResult().InputError(&quot;当前号码还未注册&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">        //创建一个验证码信息类，存放验证码（验证码使用随机生成），过期时间，电话号码，</span><br><span class="line">        int captcha = new Random().nextInt(9999);  //随机生成验证码</span><br><span class="line">        PhoneCaptchaVo phoneCaptchaVo = new PhoneCaptchaVo(String.valueOf(captcha),60,phone);</span><br><span class="line"></span><br><span class="line">        ///TODO 调用短信服务提供商的接口发送短信</span><br><span class="line">        log.info(phoneCaptchaVo.getCode()+&quot;  &gt;&gt; 验证码已发送至 &quot;  +phone );</span><br><span class="line"></span><br><span class="line">        session.setAttribute(&quot;phoneCaptcha&quot;,phoneCaptchaVo);</span><br><span class="line"></span><br><span class="line">        return new JsonResult().success(&quot;验证码已发送&quot;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>这里我们可以看到有给PhoneCaptchaVo 其实就和图片验证码一样，需要的类封装我们的验证基本信息，再放入session</p>
<h3 id="PhoneCaptchaVo"><a href="#PhoneCaptchaVo" class="headerlink" title="PhoneCaptchaVo :"></a>PhoneCaptchaVo :</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">public class PhoneCaptchaVo &#123;</span><br><span class="line"></span><br><span class="line">    private String captchaCode; //验证码谜底</span><br><span class="line">    private LocalDateTime expireTime;  //验证码过期时间</span><br><span class="line">    private String phone;  //电话号码</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 用于初始化</span><br><span class="line">     * @param captchaCode  谜底</span><br><span class="line">     * @param expireAfterSeconds  过期秒数</span><br><span class="line">     */</span><br><span class="line">    public PhoneCaptchaVo(String captchaCode,int expireAfterSeconds,String phone)&#123;</span><br><span class="line">        this.captchaCode=captchaCode;</span><br><span class="line">        //当前时间加上指定的秒数</span><br><span class="line">        this.expireTime = LocalDateTime.now().plusSeconds(expireAfterSeconds);</span><br><span class="line">        this.phone=phone;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 判断验证码是否过期</span><br><span class="line">     * @return</span><br><span class="line">     */</span><br><span class="line">    public boolean isExpired()&#123;</span><br><span class="line">        //判断当前时间是否大于过期时间，大于则失效</span><br><span class="line">        return LocalDateTime.now().isAfter(expireTime);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 获取captchaCode</span><br><span class="line">     * @return</span><br><span class="line">     */</span><br><span class="line">    public String getCode()&#123;</span><br><span class="line">        return captchaCode;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    //返回电话号码</span><br><span class="line">    public String getPhone()&#123;</span><br><span class="line">        return phone;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<p>这样我们的第一步就完成了，以创建并发送验证码，</p>
<h3 id="使用过滤器进行谜底验证："><a href="#使用过滤器进行谜底验证：" class="headerlink" title="使用过滤器进行谜底验证："></a>使用过滤器进行谜底验证：</h3><p>当我们登录时我们需要进行登录信息的确认，还有谜底对比</p>
<p>这样我们就完成了基本的验证，但这样我们是无法使用的，因为的短信登录请求&#x2F;PhoneLogin是无法向&#x2F;login一样被识别的</p>
<p>我们还需要创建PhoneAuthenticationFilter ，就像UsernamePasswordAuthenticationFilter一样，如果给login请求就进行登录的一系列操作</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * 短信验证码登录验证的过滤器，与我们图片验证码的过滤器可以说是一模一样</span><br><span class="line"> */</span><br><span class="line">@Component</span><br><span class="line">public class PhoneCodeValidateFilter  extends OncePerRequestFilter &#123;</span><br><span class="line">    /**</span><br><span class="line">     * 这是我们自定义登录失败的处理方式</span><br><span class="line">     */</span><br><span class="line">    @Autowired</span><br><span class="line">    private MyAuthenticationFailureHandler myAuthenticationFailureHandler;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    protected void doFilterInternal(HttpServletRequest request,</span><br><span class="line">                                    HttpServletResponse response,</span><br><span class="line">                                    FilterChain filterChain)</span><br><span class="line">            throws ServletException, IOException &#123;</span><br><span class="line"></span><br><span class="line">        //判断当前请求是否是向/login发送请求，并且是以post请求提交的</span><br><span class="line">        if (&quot;/PhoneLogin&quot;.equals(request.getRequestURI())</span><br><span class="line">                &amp;&amp; &quot;post&quot;.equalsIgnoreCase(request.getMethod()))&#123;</span><br><span class="line"></span><br><span class="line">            try &#123;</span><br><span class="line">                //验证码校验操作</span><br><span class="line">                captchaVerify(request);</span><br><span class="line">            &#125;catch (AuthenticationException e)&#123;</span><br><span class="line">                //SessionAuthenticationException这个异常是继承了AuthenticationException的</span><br><span class="line">                //我们自定义异常时同样也需继承AuthenticationException</span><br><span class="line">                //我们将错误处理交给登录实现处理类进行操作</span><br><span class="line">                myAuthenticationFailureHandler.onAuthenticationFailure(request,response,e);</span><br><span class="line">                //由于这里已经是发生了异常的，我们就不能让程序再进行往下走了</span><br><span class="line">                return;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        //如果验证成功后不是登录操作就进行放行</span><br><span class="line">        filterChain.doFilter(request,response);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 验证码验证操作</span><br><span class="line">     * 里面的异常是可以自定义的，不一定就要用系统提供的</span><br><span class="line">     */</span><br><span class="line">    private void captchaVerify(HttpServletRequest request)&#123;</span><br><span class="line"></span><br><span class="line">        //获取session，session中有用户的谜底与验证码过期时间</span><br><span class="line">        HttpSession session = request.getSession();</span><br><span class="line"></span><br><span class="line">        //获取用户输入的验证码</span><br><span class="line">            String phone = request.getParameter(&quot;phone&quot;); //输入的手机号码</span><br><span class="line">            String phoneCode = request.getParameter(&quot;phoneCode&quot;); //输入的验证码</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        //判断用户输入的手机号是否为空</span><br><span class="line">        if (phone.trim().isEmpty())&#123;</span><br><span class="line">            throw new SessionAuthenticationException(&quot;手机号不能为空&quot;);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        //判断用户输入的验证码是否为空</span><br><span class="line">        if (phoneCode.trim().isEmpty())&#123;</span><br><span class="line">            throw new SessionAuthenticationException(&quot;验证码不能为空&quot;);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        //获取我们存入session中的CaptchaImageVo，也就是谜底与过期时间类</span><br><span class="line">        PhoneCaptchaVo phoneCaptchaVo = (PhoneCaptchaVo) session.getAttribute(CaptchaConstant.PHONE_SESSION_KEY);</span><br><span class="line"></span><br><span class="line">        //判断session中使用有谜底</span><br><span class="line">        if (Objects.isNull(phoneCaptchaVo))&#123;</span><br><span class="line">            throw new SessionAuthenticationException(&quot;验证码不存在&quot;);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        //判断验证码是否过期</span><br><span class="line">        if (phoneCaptchaVo.isExpired())&#123;</span><br><span class="line">            //移出以前的CaptchaImageVo</span><br><span class="line">            session.removeAttribute(CaptchaConstant.PHONE_SESSION_KEY);</span><br><span class="line">            throw new SessionAuthenticationException(&quot;验证码已过期&quot;);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        //判断用户输入的验证码是否与谜底一致</span><br><span class="line">        if (!phoneCode.trim().equalsIgnoreCase(phoneCaptchaVo.getCode()))&#123;</span><br><span class="line">            throw new SessionAuthenticationException(&quot;验证码不匹配&quot;);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        //判断用户输入的验证码是否与谜底一致</span><br><span class="line">        if (!phone.trim().equalsIgnoreCase(phoneCaptchaVo.getPhone()))&#123;</span><br><span class="line">            throw new SessionAuthenticationException(&quot;手机号不匹配&quot;);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        //验证完后删除验证码，不管成功还是失败</span><br><span class="line">        session.removeAttribute(CaptchaConstant.PHONE_SESSION_KEY);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<h3 id="短信鉴定登录过滤器："><a href="#短信鉴定登录过滤器：" class="headerlink" title="短信鉴定登录过滤器："></a>短信鉴定登录过滤器：</h3><p><img src="https://s2.loli.net/2022/03/21/XhP7JmLgucOi5sI.png" alt="image-20220316234227700"></p>
<p>如果所示，我们需要自定义我们的短信登录日志过滤器，当我们短信登录进来时绕过用户名密码登录过滤器。而是走我们自定义的过滤器</p>
<h4 id="实现图中第一个步骤"><a href="#实现图中第一个步骤" class="headerlink" title="实现图中第一个步骤:"></a>实现图中第一个步骤:</h4><p>创建自定义鉴定过滤器</p>
<h5 id="PhoneAuthenticationFilter："><a href="#PhoneAuthenticationFilter：" class="headerlink" title="PhoneAuthenticationFilter："></a>PhoneAuthenticationFilter：</h5><p>这个类就是图中的SmsCodeAuthenticationFilter</p>
<p>这个我们可以模仿UsernamePasswordAuthenticationFilter</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * 由于我们需要为手机号登录，</span><br><span class="line"> * 我们可以仿照UsernamePasswordAuthenticationFilter用户名密码登录创建一个手机号登录过滤器交给Security</span><br><span class="line"> *</span><br><span class="line"> *</span><br><span class="line"> */</span><br><span class="line">public class PhoneAuthenticationFilter extends AbstractAuthenticationProcessingFilter &#123;</span><br><span class="line"></span><br><span class="line">    public static final String SPRING_SECURITY_FORM_PHONE_KEY = &quot;phone&quot;;</span><br><span class="line">    private static final AntPathRequestMatcher DEFAULT_ANT_PATH_REQUEST_MATCHER = new AntPathRequestMatcher(&quot;/PhoneLogin&quot;, &quot;POST&quot;);</span><br><span class="line">    private String phoneParameter = &quot;phone&quot;;</span><br><span class="line">    private boolean postOnly = true;</span><br><span class="line"></span><br><span class="line">    public PhoneAuthenticationFilter() &#123;</span><br><span class="line">        super(DEFAULT_ANT_PATH_REQUEST_MATCHER);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public PhoneAuthenticationFilter(AuthenticationManager authenticationManager) &#123;</span><br><span class="line">        super(DEFAULT_ANT_PATH_REQUEST_MATCHER, authenticationManager);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public Authentication attemptAuthentication(HttpServletRequest request, HttpServletResponse response) throws AuthenticationException &#123;</span><br><span class="line">        if (this.postOnly &amp;&amp; !request.getMethod().equals(&quot;POST&quot;)) &#123;</span><br><span class="line">            throw new AuthenticationServiceException(&quot;Authentication method not supported: &quot; + request.getMethod());</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            String phone = this.obtainPhone(request);</span><br><span class="line">            phone = phone != null ? phone : &quot;&quot;;</span><br><span class="line"></span><br><span class="line">            //我们需要自己创建一个PhoneAuthenticationToken，可以模仿UserNameAuthenticationToken</span><br><span class="line">            PhoneAuthenticationToken authRequest = new PhoneAuthenticationToken(phone);</span><br><span class="line">            this.setDetails(request, authRequest);</span><br><span class="line">            return this.getAuthenticationManager().authenticate(authRequest);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Nullable</span><br><span class="line">    protected String obtainPhone(HttpServletRequest request) &#123;</span><br><span class="line">        return request.getParameter(this.phoneParameter);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    protected void setDetails(HttpServletRequest request, PhoneAuthenticationToken authRequest) &#123;</span><br><span class="line">        authRequest.setDetails(this.authenticationDetailsSource.buildDetails(request));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void setPhoneParameter(String usernameParameter) &#123;</span><br><span class="line">        Assert.hasText(usernameParameter, &quot;Phone parameter must not be empty or null&quot;);</span><br><span class="line">        this.phoneParameter = usernameParameter;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void setPostOnly(boolean postOnly) &#123;</span><br><span class="line">        this.postOnly = postOnly;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public final String getUsernameParameter() &#123;</span><br><span class="line">        return this.phoneParameter;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<p>再改写这个PhoneAuthenticationFilter类时我们发现UsernamePasswordAuthenticationToken令牌不是我们需要的，所以我们同样要改写，去自定义一个</p>
<p><strong>解下UsernamePasswordAuthenticationToken：</strong></p>
<p>通过类名可以的看出来，用户名密码方式进行认证。就是我们见的最多的认证方式通过用户名密码进行登录。咱们话不多说看看具体实现：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UsernamePasswordAuthenticationToken</span> <span class="keyword">extends</span> <span class="title class_">AbstractAuthenticationToken</span> &#123;</span><br><span class="line">    <span class="comment">// 序列化id</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">serialVersionUID</span> <span class="operator">=</span> <span class="number">530L</span>;</span><br><span class="line">    <span class="comment">// 一般指的是用户名</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Object principal;</span><br><span class="line">    <span class="comment">// 一般指的是密码</span></span><br><span class="line">    <span class="keyword">private</span> Object credentials;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 构造器</span></span><br><span class="line">    <span class="comment">// principal  一般指的是用户名</span></span><br><span class="line">    <span class="comment">// credentials  一般指的是密码</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">UsernamePasswordAuthenticationToken</span><span class="params">(Object principal, Object credentials)</span> &#123;</span><br><span class="line">        <span class="comment">// 初始化父类构造 权限集合为空</span></span><br><span class="line">        <span class="built_in">super</span>((Collection)<span class="literal">null</span>);</span><br><span class="line">        <span class="built_in">this</span>.principal = principal;</span><br><span class="line">        <span class="built_in">this</span>.credentials = credentials;</span><br><span class="line">        <span class="comment">// 设置是否已认证 默认为false</span></span><br><span class="line">        <span class="built_in">this</span>.setAuthenticated(<span class="literal">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 构造器</span></span><br><span class="line">     <span class="comment">// principal  一般指的是用户名</span></span><br><span class="line">    <span class="comment">// credentials  一般指的是密码</span></span><br><span class="line">    <span class="comment">// authorities 权限</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">UsernamePasswordAuthenticationToken</span><span class="params">(Object principal, Object credentials, Collection&lt;? extends GrantedAuthority&gt; authorities)</span> &#123;</span><br><span class="line">       <span class="comment">// // 初始化父类构造 权限集合</span></span><br><span class="line">        <span class="built_in">super</span>(authorities);</span><br><span class="line">        <span class="built_in">this</span>.principal = principal;</span><br><span class="line">        <span class="built_in">this</span>.credentials = credentials;</span><br><span class="line">        <span class="comment">// 设置父类方法表示已经认证</span></span><br><span class="line">        <span class="built_in">super</span>.setAuthenticated(<span class="literal">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取密码</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">getCredentials</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.credentials;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 获取用户名</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">getPrincipal</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.principal;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 设置是否已认证 默认为false</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setAuthenticated</span><span class="params">(<span class="type">boolean</span> isAuthenticated)</span> <span class="keyword">throws</span> IllegalArgumentException &#123;</span><br><span class="line">        <span class="comment">// 如果为true</span></span><br><span class="line">        <span class="comment">// 抛出非法参数异常</span></span><br><span class="line">        <span class="keyword">if</span> (isAuthenticated) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(<span class="string">&quot;Cannot set this token to trusted - use constructor which takes a GrantedAuthority list instead&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 设置父类是否已认证</span></span><br><span class="line">            <span class="built_in">super</span>.setAuthenticated(<span class="literal">false</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 擦除凭证</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">eraseCredentials</span><span class="params">()</span> &#123;  </span><br><span class="line">        <span class="comment">// 调用父类方法</span></span><br><span class="line">        <span class="built_in">super</span>.eraseCredentials();</span><br><span class="line">        <span class="comment">// 将密码设置为空</span></span><br><span class="line">        <span class="built_in">this</span>.credentials = <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h5 id="PhoneAuthenticationToken："><a href="#PhoneAuthenticationToken：" class="headerlink" title="PhoneAuthenticationToken："></a>PhoneAuthenticationToken：</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">public class PhoneAuthenticationToken  extends AbstractAuthenticationToken &#123;</span><br><span class="line"></span><br><span class="line">    private static final long serialVersionUID = 560L;</span><br><span class="line">    //存放认证信息，认证之前放的是手机号码，认证之后存放UserDetails</span><br><span class="line">    private final Object principal;</span><br><span class="line"></span><br><span class="line">    public PhoneAuthenticationToken(Object principal) &#123;</span><br><span class="line">        super((Collection)null);</span><br><span class="line">        this.principal = principal;</span><br><span class="line">        this.setAuthenticated(false);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public PhoneAuthenticationToken(Object principal, Collection&lt;? extends GrantedAuthority&gt; authorities) &#123;</span><br><span class="line">        super(authorities);</span><br><span class="line">        this.principal = principal;</span><br><span class="line">        super.setAuthenticated(true);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    //由于我们手机号登录不需要密码，这个是获取密码的，我们没有密码就返回null，</span><br><span class="line">    //接口中要求实现</span><br><span class="line">    public Object getCredentials() &#123;</span><br><span class="line">        return null;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public Object getPrincipal() &#123;</span><br><span class="line">        return this.principal;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void setAuthenticated(boolean isAuthenticated) throws IllegalArgumentException &#123;</span><br><span class="line">        Assert.isTrue(!isAuthenticated, &quot;Cannot set this token to trusted - use constructor which takes a GrantedAuthority list instead&quot;);</span><br><span class="line">        super.setAuthenticated(false);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void eraseCredentials() &#123;</span><br><span class="line">        super.eraseCredentials();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="然后再实现图中第二个步骤："><a href="#然后再实现图中第二个步骤：" class="headerlink" title="然后再实现图中第二个步骤："></a>然后再实现图中第二个步骤：</h4><h5 id="实现鉴定提供者"><a href="#实现鉴定提供者" class="headerlink" title="实现鉴定提供者"></a>实现鉴定提供者</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> *创建一个电话号码的鉴定提供者，</span><br><span class="line"> */</span><br><span class="line">public class PhoneAuthenticationProvider implements AuthenticationProvider &#123;</span><br><span class="line"></span><br><span class="line">//这个其实我认为是多余的可以去掉，因为这个我们再使用过滤器进行谜底验证时就已经验证过电话号码的正确性</span><br><span class="line">    private UserDetailsService userDetailsService;</span><br><span class="line"></span><br><span class="line">    public void setUserDetailsService(UserDetailsService userDetailsService)&#123;</span><br><span class="line">        this.userDetailsService = userDetailsService;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    protected  UserDetailsService getUserDetailsService()&#123;</span><br><span class="line">        return userDetailsService;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // 具体认证流程</span><br><span class="line">    @Override</span><br><span class="line">    public Authentication authenticate(Authentication authentication) throws AuthenticationException &#123;</span><br><span class="line">        //获取存放的Token</span><br><span class="line">        PhoneAuthenticationToken phoneAuthenticationToken = (PhoneAuthenticationToken) authentication;</span><br><span class="line">        //phoneAuthenticationToken中的Principal，初始存储的电话号码</span><br><span class="line">        UserDetails userDetails = userDetailsService.loadUserByUsername((String) phoneAuthenticationToken.getPrincipal());</span><br><span class="line"></span><br><span class="line">        //判断使用当前号码是否能获取到用户信息，一般都不会出问题，以为我们在获取验证码时就验证了</span><br><span class="line">        // 也就是PhoneCodeValidateFilter过滤器中验证码了</span><br><span class="line">        if (userDetails == null)&#123;</span><br><span class="line">            throw new InternalAuthenticationServiceException(&quot;无法根据手机号获取用户信息&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">        //我们在这创建一个Token这次他的Principal就变成了userDetails,</span><br><span class="line">        PhoneAuthenticationToken authenticationToken = new PhoneAuthenticationToken(userDetails,userDetails.getAuthorities());</span><br><span class="line">        //由于我们直接创建的details是没有值的，所以我们要将原来的details赋为我们的details</span><br><span class="line">        authenticationToken.setDetails(phoneAuthenticationToken.getDetails());</span><br><span class="line">        return authenticationToken;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     *    supports函数用来指明该Provider是否适用于该类型的认证，如果不合适，则寻找另一个Provider进行验证处理。</span><br><span class="line">     *    就好比，判断当前Provider是否适用于电话号码的认证，不适合，则寻找另一个Provider进行验证处理。</span><br><span class="line">     */</span><br><span class="line">    @Override</span><br><span class="line">    public boolean supports(Class&lt;?&gt; authentication) &#123;</span><br><span class="line">        //判断当前Provider是否适用于authentication认证</span><br><span class="line">        return PhoneAuthenticationToken.class.isAssignableFrom(authentication);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<p>把这个都完成后，再把他们配置到Security配置类中，但是，这个如果配置的话会显得很多，所以我们可以先创建一个电话号码验证单独的配置类，然后再将它放入到核心Security配置类中，</p>
<h5 id="单独配置类"><a href="#单独配置类" class="headerlink" title="单独配置类"></a>单独配置类</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * 由于要配置电话号码登录配置的话，需要配置很多，</span><br><span class="line"> * 所以我们交配置整合好后在去Security配置类中配置</span><br><span class="line"> */</span><br><span class="line">@Component</span><br><span class="line">public class PhoneSecurityConfig extends SecurityConfigurerAdapter&lt;DefaultSecurityFilterChain, HttpSecurity&gt; &#123;</span><br><span class="line"></span><br><span class="line">    @Autowired</span><br><span class="line">    private MyAuthenticationFailureHandler myAuthenticationFailureHandler;</span><br><span class="line"></span><br><span class="line">    @Autowired</span><br><span class="line">    private MyAuthenticationSuccessHandler myAuthenticationSuccessHandler;</span><br><span class="line"></span><br><span class="line">    @Autowired</span><br><span class="line">    private MyUserDetailsService myUserDetailsService;</span><br><span class="line"></span><br><span class="line">    //登录信息校验过滤器，也就是过滤登录信息是否正常</span><br><span class="line">    @Autowired</span><br><span class="line">    private PhoneCodeValidateFilter phoneCodeValidateFilter;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public void configure(HttpSecurity http) throws Exception &#123;</span><br><span class="line">        //创建一个电话号码登录过滤器，也就是如UsernamePasswordAuthenticationFilter一样的</span><br><span class="line">        PhoneAuthenticationFilter phoneAuthenticationFilter = new PhoneAuthenticationFilter();</span><br><span class="line"></span><br><span class="line">        phoneAuthenticationFilter.setAuthenticationManager(http.getSharedObject(AuthenticationManager.class));</span><br><span class="line">        phoneAuthenticationFilter.setAuthenticationSuccessHandler(myAuthenticationSuccessHandler);//登录成功处理方式</span><br><span class="line">        phoneAuthenticationFilter.setAuthenticationFailureHandler(myAuthenticationFailureHandler);//登录失败处理方式</span><br><span class="line"></span><br><span class="line">        //创建一个我们自定义鉴定提供者，他会自己去匹配当前信息能使用鉴定提供者</span><br><span class="line">        PhoneAuthenticationProvider phoneAuthenticationProvider = new PhoneAuthenticationProvider();</span><br><span class="line">        //其实这个都可以不用，如果不要也就删除PhoneAuthenticationProvider中他对应的操作</span><br><span class="line">        phoneAuthenticationProvider.setUserDetailsService(myUserDetailsService);</span><br><span class="line"></span><br><span class="line">        http.addFilterBefore(phoneCodeValidateFilter, UsernamePasswordAuthenticationFilter.class);</span><br><span class="line">        http.authenticationProvider(phoneAuthenticationProvider)</span><br><span class="line">                .addFilterAfter(phoneAuthenticationFilter,UsernamePasswordAuthenticationFilter.class);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h5 id="Securty配置类："><a href="#Securty配置类：" class="headerlink" title="Securty配置类："></a>Securty配置类：</h5><p>在配置类中加入.apply(phoneSecurityConfig)&#x2F;&#x2F;添加我们的手机号码登录配置类</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br></pre></td><td class="code"><pre><span class="line">@Configuration</span><br><span class="line">public class SecurityConfig extends WebSecurityConfigurerAdapter &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    //将我们自定义的这两个类使用IOC容器装配</span><br><span class="line">    @Autowired</span><br><span class="line">    private MyAuthenticationSuccessHandler myAuthenticationSuccessHandler;  //登录成功处理</span><br><span class="line"></span><br><span class="line">    @Autowired</span><br><span class="line">    private MyAuthenticationFailureHandler myAuthenticationFailureHandler;  //登录失败处理</span><br><span class="line"></span><br><span class="line">    //导入自定义动态授权</span><br><span class="line"></span><br><span class="line">    @Autowired</span><br><span class="line">    private MyUserDetailsService myUserDetailsService;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    @Autowired</span><br><span class="line">    private DataSource dataSource;</span><br><span class="line"></span><br><span class="line">    //退出登录自定义策略</span><br><span class="line">    @Autowired</span><br><span class="line">    private MyLogoutSuccessHandler myLogoutSuccessHandler;</span><br><span class="line"></span><br><span class="line">    //验证码过滤器</span><br><span class="line">    @Autowired</span><br><span class="line">    private CaptchaCodeFilter captchaCodeFilter;</span><br><span class="line"></span><br><span class="line">    @Autowired</span><br><span class="line">    private PhoneSecurityConfig phoneSecurityConfig;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 登录认证方法</span><br><span class="line">     * @param http</span><br><span class="line">     * @throws Exception</span><br><span class="line">     */</span><br><span class="line">    @Override</span><br><span class="line">    protected void configure(HttpSecurity http) throws Exception &#123;</span><br><span class="line"></span><br><span class="line">        //开启formLogin登录认证</span><br><span class="line">        http</span><br><span class="line">                //将验证码过滤器放置在UsernamePasswordAuthenticationFilter过滤器之前执行，AOP思想</span><br><span class="line">                .addFilterBefore(captchaCodeFilter, UsernamePasswordAuthenticationFilter.class)</span><br><span class="line">                .logout()//开启退出登录</span><br><span class="line">//                .logoutSuccessUrl(&quot;/&quot;) //退出后跳转的页面  默认退出到login页面</span><br><span class="line">                .deleteCookies(&quot;JSESSIONID&quot;) //指定退出后要删除的cookie</span><br><span class="line">                .logoutUrl(&quot;/logout&quot;)  //退出请求路径，也就是页面上退出登录访问的地址  默认logout</span><br><span class="line">                .logoutSuccessHandler(myLogoutSuccessHandler) //使用自定义退出策略 ，不能与logoutSuccessUrl共存，否则失效</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">                .and()</span><br><span class="line"></span><br><span class="line">                .rememberMe()//开启记住我功能  ，前端也需要有记住我字段</span><br><span class="line">                .rememberMeCookieName(&quot;rememberMe-Cookie&quot;)  //存在浏览器中cookie的名称</span><br><span class="line">                .rememberMeParameter(&quot;remember-me&quot;)  //表单中 自动登录 勾选框的参数名</span><br><span class="line">                .tokenValiditySeconds(2*24*60*60) //保存Cookie的有效期，默认2周</span><br><span class="line">                .tokenRepository(tokenRepository())  //指定rememberMe存储到数据库规则方法</span><br><span class="line"></span><br><span class="line">                .and()</span><br><span class="line"></span><br><span class="line">                .csrf().disable()  //关闭防御csrf攻击</span><br><span class="line">                .formLogin()//开启formLogin登录认证</span><br><span class="line">                .loginPage(&quot;/logins&quot;)    //用于选择登录页面，没认证时跳转的页面</span><br><span class="line">                .loginProcessingUrl(&quot;/login&quot;)   //选择需要认证的请求，也就是登录表单的提交地址</span><br><span class="line">                .usernameParameter(&quot;user&quot;)   //选择登录请求的哪个参数是用户名</span><br><span class="line">                .passwordParameter(&quot;password&quot;)   //选择登录请求的哪个参数是密码</span><br><span class="line">                //使用自定义的登录失败成功处理方法</span><br><span class="line">                .successHandler(myAuthenticationSuccessHandler)  //登录成功</span><br><span class="line">                .failureHandler(myAuthenticationFailureHandler)  //登录失败</span><br><span class="line"></span><br><span class="line">                //这两会与我们自定义的冲突想要使用自定义的就不能使用这个</span><br><span class="line">//                .defaultSuccessUrl(&quot;/&quot;)   //登录成功跳转的路径</span><br><span class="line">//                .failureForwardUrl(&quot;/logins&quot;)  //登录失败跳转的路径</span><br><span class="line">             .and()</span><br><span class="line">                .apply(phoneSecurityConfig)//添加我们的手机号码登录配置类</span><br><span class="line">                .and()</span><br><span class="line">                .authorizeRequests() //自定义过滤拦截请求</span><br><span class="line">                .antMatchers(&quot;/logins&quot;,&quot;/login&quot;,&quot;/&quot;,&quot;/kaptcha&quot;,&quot;/smscode&quot;,&quot;/PhoneLogin&quot;) //资源路径</span><br><span class="line">                .permitAll()  //当前资源路径不需要认证就可以访问</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">                //______________________________动态图鉴权_____________________________________________</span><br><span class="line">                    //所有的请求都有经过MyRBACService的hasPermission方法进行鉴权 返回true可以访问，返回false不允许访问，</span><br><span class="line">                    // 也就是验证用户能访问哪些页面</span><br><span class="line">                .anyRequest().access(&quot;@MyRBACService.hasPermission(request,authentication)&quot;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">                .and()</span><br><span class="line">                .sessionManagement()//启用session管理</span><br><span class="line">                .maximumSessions(1)//允许一个账号你个人同时登录，也就是一个session可以几个人同时使用</span><br><span class="line">                .maxSessionsPreventsLogin(false)//false：当登录时，其它登录的登录的地方会被踢下线;true ：当有用户在登录时不允许登录</span><br><span class="line">                .expiredSessionStrategy(new CustomExpiredSessionStrategy());  //session超时，被踢下线的自定义操作</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        //.authorizeHttpRequests()   这样方法表示选中的请求</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 授权方法</span><br><span class="line">     * @param auth</span><br><span class="line">     * @throws Exception</span><br><span class="line">     */</span><br><span class="line">    @Override</span><br><span class="line">    protected void configure(AuthenticationManagerBuilder auth) throws Exception &#123;</span><br><span class="line"></span><br><span class="line">        //________________ 动态授权，需要实现UserDetailsService____________________________</span><br><span class="line">            //这里才是验证登录信息的</span><br><span class="line">            auth.userDetailsService(myUserDetailsService)</span><br><span class="line">                  .passwordEncoder(passwordEncoder());  //配置BCrypt加密，这个会自动调用matches（）这个方法来为我们输入的密码进行对比</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Bean</span><br><span class="line">    public PasswordEncoder passwordEncoder()&#123;</span><br><span class="line">        return new BCryptPasswordEncoder();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 静态资源路径开放</span><br><span class="line">     * @param web</span><br><span class="line">     * @throws Exception</span><br><span class="line">     */</span><br><span class="line">    @Override</span><br><span class="line">    public void configure(WebSecurity web) throws Exception &#123;</span><br><span class="line">        //将项目中的静态资源路径开放出来，在这开放是不需要经过过滤器拦截的</span><br><span class="line">        web.ignoring().antMatchers(&quot;/css/**&quot;,&quot;/fonts/**&quot;,&quot;/img/**&quot;,&quot;/js/**&quot;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 向数据库操作关于记住我的验证信息</span><br><span class="line">     * JdbcTokenRepositoryImpl 这个类中已经固定要存到数据库中的哪个表，我们只需要指定数据源即可</span><br><span class="line">     * initDao() 这个方法有在数据库中创建需要的表，我还没尝试过，我的表是自己手动创建的</span><br><span class="line">     * 设置记住我存储到的数据源是哪个</span><br><span class="line">     * @return</span><br><span class="line">     */</span><br><span class="line">    @Bean</span><br><span class="line">    public PersistentTokenRepository tokenRepository()&#123;</span><br><span class="line">        JdbcTokenRepositoryImpl jdbcTokenRepository = new JdbcTokenRepositoryImpl();</span><br><span class="line">        jdbcTokenRepository.setDataSource(dataSource);</span><br><span class="line">        return jdbcTokenRepository;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>









<p><img src="https://s2.loli.net/2022/03/21/4zJVputoWcDh5P3.png" alt="image-20220317000050986"></p>
<h3 id="前端代码"><a href="#前端代码" class="headerlink" title="前端代码"></a>前端代码</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br></pre></td><td class="code"><pre><span class="line">&lt;body&gt;</span><br><span class="line">&lt;script src=&quot;https://code.jquery.com/jquery-3.0.0.min.js&quot;&gt;&lt;/script&gt;</span><br><span class="line">&lt;h1&gt;登录&lt;/h1&gt;</span><br><span class="line">&lt;form action=&quot;/login&quot; method=&quot;post&quot;&gt;</span><br><span class="line">    账号：&lt;input type=&quot;text&quot; id=&quot;username&quot; name=&quot;user&quot;&gt;&lt;br&gt;</span><br><span class="line">    密码：&lt;input type=&quot;password&quot; id=&quot;password&quot; name=&quot;password&quot;&gt;&lt;br&gt;</span><br><span class="line">    验证码:&lt;input type=&quot;text&quot; id=&quot;captchaCoed&quot; name=&quot;captchaCoed&quot;&gt;&lt;img src=&quot;/kaptcha&quot; id=&quot;kaptcha&quot; width=&quot;110px&quot; height=&quot;40px&quot;&gt;&lt;br&gt;</span><br><span class="line">    &lt;input type=&quot;button&quot; onclick=&quot;login()&quot; value=&quot;登录&quot;&gt;</span><br><span class="line">     记住我&lt;input type=&quot;checkbox&quot; name=&quot;remember-me&quot; id=&quot;remember-me&quot;&gt;</span><br><span class="line">&lt;/form&gt;</span><br><span class="line"></span><br><span class="line">&lt;h1&gt;手机验证码&lt;/h1&gt;</span><br><span class="line">&lt;form action=&quot;/&quot; method=&quot;post&quot;&gt;</span><br><span class="line">    手机号：&lt;input type=&quot;text&quot; id=&quot;phone&quot; name=&quot;phone&quot;&gt;&lt;br&gt;</span><br><span class="line">    验证码:&lt;input type=&quot;text&quot; id=&quot;phoneCode&quot; name=&quot;phoneCode&quot;&gt;&lt;input type=&quot;button&quot; id=&quot;submitPhone&quot;  onclick=&quot;getPhone()&quot; value=&quot;获取验证码&quot;  &gt;&lt;br&gt;</span><br><span class="line">    &lt;input type=&quot;button&quot; onclick=&quot;PhoneLogin()&quot; value=&quot;登录&quot;&gt;</span><br><span class="line">&lt;/form&gt;</span><br><span class="line"></span><br><span class="line">&lt;script&gt;</span><br><span class="line">    $(function () &#123;</span><br><span class="line">        //用于点击刷新验证码图片</span><br><span class="line">        $(&quot;#kaptcha&quot;).click(function () &#123;</span><br><span class="line">            $(&quot;#kaptcha&quot;).attr(&quot;src&quot;,&quot;/kaptcha?&quot;+Math.floor(Math.random()*100))</span><br><span class="line">        &#125;)</span><br><span class="line"></span><br><span class="line">    &#125;)</span><br><span class="line">    function login() &#123;</span><br><span class="line">        let username=$(&quot;#username&quot;).val();</span><br><span class="line">        let password=$(&quot;#password&quot;).val();</span><br><span class="line">        let remember=$(&quot;#remember-me&quot;).prop(&quot;checked&quot;);</span><br><span class="line">        let captchaCoed=$(&quot;#captchaCoed&quot;).val();</span><br><span class="line">        $.ajax(&#123;</span><br><span class="line">            type: &quot;POST&quot;,</span><br><span class="line">            url: &quot;/login&quot;,</span><br><span class="line">            data: &#123;</span><br><span class="line">                &quot;user&quot;: username,</span><br><span class="line">                &quot;password&quot;: password,</span><br><span class="line">                &quot;remember-me&quot;:remember,</span><br><span class="line">                &quot;captchaCoed&quot;:captchaCoed</span><br><span class="line">            &#125;,</span><br><span class="line">            success: function (json) &#123;</span><br><span class="line">              if (json.state == 200)&#123;</span><br><span class="line">                  console.log(json)</span><br><span class="line">                  location.href=&quot;/&quot;;</span><br><span class="line">              &#125;else &#123;</span><br><span class="line">                  alert(json.message)</span><br><span class="line">                  console.log(json)</span><br><span class="line">                  location.href=&quot;/logins&quot;;</span><br><span class="line">              &#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            error: function (e) &#123;</span><br><span class="line">                </span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    function getPhone() &#123;</span><br><span class="line">        let phone = $(&quot;#phone&quot;).val();</span><br><span class="line">        $.ajax(&#123;</span><br><span class="line">            type: &quot;GET&quot;,</span><br><span class="line">            url: &quot;/smscode&quot;,</span><br><span class="line">            data: &#123;</span><br><span class="line">                &quot;phone&quot;: phone,</span><br><span class="line">            &#125;,</span><br><span class="line">            success: function (json) &#123;</span><br><span class="line">                if (json.state == 200) &#123;</span><br><span class="line">                    console.log(json)</span><br><span class="line">                    alert(&quot;验证码已发送&quot;)</span><br><span class="line"></span><br><span class="line">                &#125; else &#123;</span><br><span class="line">                    alert(json.message)</span><br><span class="line">                    console.log(json)</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            error: function (e) &#123;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">    function PhoneLogin() &#123;</span><br><span class="line">        let phone = $(&quot;#phone&quot;).val();</span><br><span class="line">        let phoneCode = $(&quot;#phoneCode&quot;).val();</span><br><span class="line">        $.ajax(&#123;</span><br><span class="line">            type: &quot;POST&quot;,</span><br><span class="line">            url: &quot;/PhoneLogin&quot;,</span><br><span class="line">            data: &#123;</span><br><span class="line">                &quot;phone&quot;: phone,</span><br><span class="line">                &quot;phoneCode&quot;:phoneCode</span><br><span class="line">            &#125;,</span><br><span class="line">            success: function (json) &#123;</span><br><span class="line">                if (json.state == 200) &#123;</span><br><span class="line">                    console.log(json)</span><br><span class="line">                    location.href=&quot;/&quot;;</span><br><span class="line"></span><br><span class="line">                &#125; else &#123;</span><br><span class="line">                    alert(json.message)</span><br><span class="line">                    console.log(json)</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            error: function (e) &#123;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">&lt;/script&gt;</span><br><span class="line">&lt;/body&gt;</span><br></pre></td></tr></table></figure>





<h2 id="JWT"><a href="#JWT" class="headerlink" title="JWT"></a>JWT</h2><h3 id="jwt介绍："><a href="#jwt介绍：" class="headerlink" title="jwt介绍："></a>jwt介绍：</h3><p><img src="https://s2.loli.net/2022/03/21/kKPDMLRAVIpHrvX.png" alt="image-20220317231621407"></p>
<p><img src="https://s2.loli.net/2022/03/21/W1stHFYOvjKd6Uk.png" alt="image-20220317231629433"></p>
<p><img src="https://s2.loli.net/2022/03/21/P2Ik1z493SyCuFO.png" alt="image-20220317231635981"></p>
<p><img src="https://s2.loli.net/2022/03/21/X3od2kYmL4vnl7B.png" alt="image-20220317231642172"></p>
<h3 id="创建JWT工具类："><a href="#创建JWT工具类：" class="headerlink" title="创建JWT工具类："></a>创建JWT工具类：</h3><p>我需要先创建一jwt工具类，这样可以在我们需要给地方使用更方便</p>
<p>注意：获取用户名之类的方法都会去判断jwt令牌是否过期，过期后是获取不到用户名的</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * JWT的工具类</span><br><span class="line"> * 三个属性需要在配置文件中定义</span><br><span class="line"> */</span><br><span class="line">@Data</span><br><span class="line">@ConfigurationProperties(prefix = &quot;jwt&quot;) //设置application中配置的开头节点</span><br><span class="line">@Component</span><br><span class="line">public class JwtTokenUtil &#123;</span><br><span class="line"></span><br><span class="line">//  这三个属性需要在application配置文件中定义</span><br><span class="line">    //JWT的密钥</span><br><span class="line">    @Value(&quot;$&#123;jwt.secret&#125;&quot;)</span><br><span class="line">    private String secret;</span><br><span class="line">    //JWT的过期时间</span><br><span class="line">    @Value(&quot;$&#123;jwt.expiration&#125;&quot;)</span><br><span class="line">    private Long expiration;</span><br><span class="line">    //在http对象头中携带jwt的key的名称</span><br><span class="line">    @Value(&quot;$&#123;jwt.header&#125;&quot;)</span><br><span class="line">    private String header;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 生成JWT token令牌</span><br><span class="line">     *</span><br><span class="line">     * @param userDetails 用户信息</span><br><span class="line">     * @return JWT token令牌</span><br><span class="line">     */</span><br><span class="line">    public String generateToken(UserDetails userDetails)&#123;</span><br><span class="line">        //存放用户不敏感信息，等要放入jwt令牌中</span><br><span class="line">        Map&lt;String,Object&gt; claims = new HashMap&lt;&gt;(2);</span><br><span class="line">        claims.put(&quot;sub&quot;,userDetails.getUsername()); //将用户名放入claims</span><br><span class="line">        claims.put(&quot;created&quot;,new Date()); //将令牌创建时间放入claims</span><br><span class="line"></span><br><span class="line">        return generateToken(claims);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 从claims中获取用户不敏感信息生成令牌</span><br><span class="line">     *</span><br><span class="line">     * @param claims 用户不敏感信息</span><br><span class="line">     * @return 令牌</span><br><span class="line">     */</span><br><span class="line">    public String generateToken(Map&lt;String,Object&gt; claims)&#123;</span><br><span class="line">           Date expirationDate = new Date(System.currentTimeMillis() + expiration); //获取当前数据，加上过期是长，生成过期时间</span><br><span class="line">        //返回生成的jwt令牌</span><br><span class="line">        return Jwts.builder()//</span><br><span class="line">                .setClaims(claims)  //加入用户名，与用户创建时间</span><br><span class="line">                .setExpiration(System.currentTimeMillis()+expirationDate*1000)//令牌过期时间</span><br><span class="line">                //进行jwt令牌的签约 参数1：设置使用声明方式签名（加密方式）,参数2：使用的密钥（等解签也需要这个密钥）</span><br><span class="line">                .signWith(SignatureAlgorithm.HS512,secret)</span><br><span class="line">                .compact();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 从令牌中获取用户名</span><br><span class="line">     * @param token 令牌</span><br><span class="line">     * @return 该令牌用户名</span><br><span class="line">     */</span><br><span class="line">    public String getUsernameFromToken(String token)&#123;</span><br><span class="line">        String username;</span><br><span class="line">        try &#123;</span><br><span class="line">            //Claims jwt信息类（数据声明），获取jwt信息类</span><br><span class="line">            Claims claims = getClaimsFromToken(token);</span><br><span class="line">            username = claims.getSubject(); //在jwt信息类中获取用户名，这个方法是获取用户名的</span><br><span class="line">        &#125;catch (Exception e)&#123;</span><br><span class="line">            username = null;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        return username;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 从令牌中获取jwt令牌信息</span><br><span class="line">     * @param token 令牌</span><br><span class="line">     * @return jwt令牌信息类（数据声明）</span><br><span class="line">     */</span><br><span class="line">    public Claims getClaimsFromToken(String token)&#123;</span><br><span class="line">        //jwt令牌信息类</span><br><span class="line">        Claims claims;</span><br><span class="line">        try &#123;</span><br><span class="line">            //将jwt进行解析，获取jwt信息类</span><br><span class="line">            claims = Jwts.parser()</span><br><span class="line">                    .setSigningKey(secret)//解签的密钥</span><br><span class="line">                    .parseClaimsJws(token)//解签的令牌</span><br><span class="line">                    .getBody();</span><br><span class="line">        &#125;catch (Exception e)&#123;</span><br><span class="line">            claims = null;</span><br><span class="line">        &#125;</span><br><span class="line">        return claims;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 判断令牌是否过期</span><br><span class="line">     * @param token 令牌</span><br><span class="line">     * @return 是否过期</span><br><span class="line">     */</span><br><span class="line">    public Boolean isTokenExpired(String token)&#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            Claims claims = getClaimsFromToken(token);</span><br><span class="line">            //获取jwt令牌过期时间，过期使用使用这个方法获取</span><br><span class="line">            Date expiration = claims.getExpiration();</span><br><span class="line">            //判断当前时间是否在过期时间之前，也就是判断是否过期</span><br><span class="line">            return expiration.before(new Date());</span><br><span class="line">        &#125;catch (Exception e)&#123;</span><br><span class="line">            return false;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 刷新令牌（令牌过期就表示登录过期，为了保证用户体验，在用户使用中要刷新令牌）</span><br><span class="line">     * @param token 原令牌</span><br><span class="line">     * @return 新令牌</span><br><span class="line">     */</span><br><span class="line">    public String refreshToken(String token)&#123;</span><br><span class="line">        String refreshToken;</span><br><span class="line">        try &#123;</span><br><span class="line">            //获取jwt信息类</span><br><span class="line">            Claims claims = getClaimsFromToken(token);</span><br><span class="line">            //修改jwt中的新的创建时间</span><br><span class="line">            claims.put(&quot;created&quot;,new Date());</span><br><span class="line">            //生成一个新的令牌，更新它的过期时间</span><br><span class="line">            refreshToken = generateToken(claims);</span><br><span class="line">        &#125;catch (Exception e)&#123;</span><br><span class="line">            refreshToken = null;</span><br><span class="line">        &#125;</span><br><span class="line">        return refreshToken;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 验证令牌</span><br><span class="line">     * @param token 令牌</span><br><span class="line">     * @param userDetails 用户详细信息</span><br><span class="line">     * @return 是否有效</span><br><span class="line">     */</span><br><span class="line">    public Boolean validateToken(String token,UserDetails userDetails)&#123;</span><br><span class="line">        //获取用户名</span><br><span class="line">        String username = getUsernameFromToken(token);</span><br><span class="line">        //判断当前jwt令牌用户名是否与登录用户的用户名相同，并且jwt令牌是否过期</span><br><span class="line">        return (username.equals(userDetails.getUsername()) &amp;&amp; !isTokenExpired(token));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>yml配置：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">jwt:</span><br><span class="line">  secret: ahjkvhajkhkss2ajdfaj #密钥，签名（加密），解签（解密）都需要该密钥</span><br><span class="line">  expiration: 3600000  #过期时长 </span><br><span class="line">  header: JWTHeaderName  #jwt在http头部信息中的key</span><br></pre></td></tr></table></figure>



<h3 id="JWT实现登录："><a href="#JWT实现登录：" class="headerlink" title="JWT实现登录："></a>JWT实现登录：</h3><p>我们需要配置Controller实现请求，与Service业务层</p>
<p>这些做完我们就可以获取基本的jwt令牌了</p>
<h4 id="Controller："><a href="#Controller：" class="headerlink" title="Controller："></a>Controller：</h4><p>两个请求，一个获取令牌：也就是登录我们需要创建一个jwt令牌返回给客户端，一个刷新：刷新我们的jwt令牌返回回去</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">@RestController</span><br><span class="line">public class JwtAuthController &#123;</span><br><span class="line"></span><br><span class="line">    @Autowired</span><br><span class="line">    private JwtAuthService jwtAuthService;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 创建jwt令牌</span><br><span class="line">     * 记得在SecurityConfig中开放访问权限</span><br><span class="line">     * @param map</span><br><span class="line">     * @return</span><br><span class="line">     */</span><br><span class="line">    @RequestMapping(&quot;/authentication&quot;)</span><br><span class="line">    public JsonResult login(@RequestBody Map&lt;String,String&gt; map)&#123;</span><br><span class="line"></span><br><span class="line">        //获取用户名和密码</span><br><span class="line">        String username = map.get(&quot;username&quot;);</span><br><span class="line">        String password = map.get(&quot;password&quot;);</span><br><span class="line"></span><br><span class="line">        //判断用户名与密码是否为空</span><br><span class="line">        if (username.isEmpty() || password.isEmpty())&#123;</span><br><span class="line">            return  new JsonResult().InputError(&quot;用户名或密码不能为空&quot;);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        try &#123;</span><br><span class="line">            //返回获取到的jwt令牌</span><br><span class="line">            return new JsonResult().success(jwtAuthService.login(username,password));</span><br><span class="line">        &#125;catch (UsernameNotFoundException e)&#123;</span><br><span class="line">            //如果没有获取到jwt令牌，返回错误信息</span><br><span class="line">            return new JsonResult().InputError(e.getMessage());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 刷新jwt令牌</span><br><span class="line">     * @param token  获取http对象头中的jwt令牌，我们以及设置jwt令牌的key为jwt.header</span><br><span class="line">     * @return</span><br><span class="line">     */</span><br><span class="line">    @RequestMapping(&quot;/refreshToken&quot;)</span><br><span class="line">    public JsonResult refresh(@RequestHeader(&quot;$&#123;jwt.header&#125;&quot;) String token)&#123;</span><br><span class="line">        return new JsonResult().success(jwtAuthService.refreshToken(token));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="Service："><a href="#Service：" class="headerlink" title="Service："></a>Service：</h4><p>业务操作，实际上还是业务层实现真实的操作，访问层只是做一些校验</p>
<p>注意：AuthenticationManager  这个bean在Security配置类中配置了，可以去看看，下面有完整的Security配置类</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">@Service</span><br><span class="line">public class JwtAuthService &#123;</span><br><span class="line"></span><br><span class="line">    //鉴定管理员 </span><br><span class="line">    @Autowired</span><br><span class="line">    private AuthenticationManager authenticationManager;</span><br><span class="line"></span><br><span class="line">    @Autowired</span><br><span class="line">    private MyUserDetailsService userDetailsService;</span><br><span class="line"></span><br><span class="line">    @Autowired</span><br><span class="line">    private JwtTokenUtil jwtTokenUtil;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 登录认证换取JWT令牌</span><br><span class="line">     * @param username</span><br><span class="line">     * @param password</span><br><span class="line">     * @return</span><br><span class="line">     */</span><br><span class="line">    public String login(String username,String password)&#123;</span><br><span class="line"></span><br><span class="line">        try&#123;</span><br><span class="line">            //创建一个用户名密码鉴定令牌</span><br><span class="line">            UsernamePasswordAuthenticationToken authenticationToken = new 				UsernamePasswordAuthenticationToken(username,password);</span><br><span class="line">            //进行认证，如果认证成功返回一个认证信息，如果没有成功就会抛出AuthenticationException异常</span><br><span class="line">            //这个方法中会去数据库中查询认证信息，具体还得网查询</span><br><span class="line">            Authentication authenticate = authenticationManager.authenticate(authenticationToken);</span><br><span class="line">            //将认证信息给Security</span><br><span class="line">            SecurityContextHolder.getContext().setAuthentication(authenticationToken);</span><br><span class="line">        &#125;catch (AuthenticationException e)&#123;</span><br><span class="line">            throw new UsernameNotFoundException(&quot;用户名或密码不正确&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">        //进行用户查询</span><br><span class="line">        UserDetails userDetails = userDetailsService.loadUserByUsername(username);</span><br><span class="line">        //创建jwt令牌并返回</span><br><span class="line">        return jwtTokenUtil.generateToken(userDetails);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 刷新jwt令牌</span><br><span class="line">     * @param oldToken 旧令牌</span><br><span class="line">     * @return</span><br><span class="line">     */</span><br><span class="line">    public String refreshToken(String oldToken)&#123;</span><br><span class="line">        //判断当前令牌是否过期</span><br><span class="line">        if (!jwtTokenUtil.isTokenExpired(oldToken))&#123;</span><br><span class="line">            return jwtTokenUtil.refreshToken(oldToken);</span><br><span class="line">        &#125;</span><br><span class="line">        return null;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>注意，要把当前两个请求路径开放，并将session关闭</strong></p>
<h4 id="实现效果："><a href="#实现效果：" class="headerlink" title="实现效果："></a>实现效果：</h4><p>获取到的令牌是可以使用Base64解码的，但密钥是解码不了的</p>
<p><strong>获取令牌：</strong></p>
<p><img src="https://s2.loli.net/2022/03/21/kWeJDHTntcVMBfh.png" alt="image-20220320190553251"></p>
<p><strong>刷新令牌：</strong></p>
<p><img src="https://s2.loli.net/2022/03/21/etnRIfD1aZVPjTy.png" alt="image-20220320190242450"></p>
<p><strong>解码演示</strong>：</p>
<p>这个图就和介绍中jwt结构分析一样</p>
<p><img src="https://s2.loli.net/2022/03/21/lbj2MnBNmJ87Qoc.png" alt="image-20220320190758729"></p>
<h3 id="jwt用户授权"><a href="#jwt用户授权" class="headerlink" title="jwt用户授权"></a>jwt用户授权</h3><p>我们单纯的只有jwt令牌也没有用，我们需要为当前用户进行授权，那么我们就需要自己去创建一个过滤器放置在UsernamePasswordAuthenticationFilter之前进行授权</p>
<p>介绍下， UsernamePasswordAuthenticationToken authenticationToken<br>        &#x3D; new UsernamePasswordAuthenticationToken(userDetails,null,userDetails.getAuthorities());</p>
<p>这是个特殊的令牌，这个令牌是Security是可以获取到用户认证信息的，而这个令牌里的认证信息是我们放入的，然后将认证信息交给</p>
<p>SecurityContextHolder.getContext().setAuthentication(authenticationToken); </p>
<p>这个方法是将我们有角色认证信息的令牌交给Security这样就完成了角色的认证，就可以判断用户拥有哪些权限了，但每次访问时都会去重写查询（下面代码里可以看到）所以我们可以使用缓存将它存起来，这样就可以提高效率</p>
<h4 id="jwt身份授权鉴权过滤器"><a href="#jwt身份授权鉴权过滤器" class="headerlink" title="jwt身份授权鉴权过滤器"></a><strong>jwt身份授权鉴权过滤器</strong></h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * 添加jwt过滤器，用于身份授权鉴权</span><br><span class="line"> */</span><br><span class="line">@Component</span><br><span class="line">public class JwtAuthenticationTokenFilter extends OncePerRequestFilter &#123;</span><br><span class="line"></span><br><span class="line">    @Autowired</span><br><span class="line">    private JwtTokenUtil jwtTokenUtil;</span><br><span class="line"></span><br><span class="line">    @Autowired</span><br><span class="line">    private MyUserDetailsService myUserDetailsService;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    protected void doFilterInternal(HttpServletRequest request, HttpServletResponse response, FilterChain filterChain) throws ServletException, IOException &#123;</span><br><span class="line"></span><br><span class="line">        //获取http头部信息中的jwtToken</span><br><span class="line">        String jwtToken = request.getHeader(jwtTokenUtil.getHeader());</span><br><span class="line">        //判断是否有jwtToken</span><br><span class="line">        if (!StringUtils.isEmpty(jwtToken))&#123;</span><br><span class="line">            //获取jwt中的用户名,这里已经是判断jwt令牌的有效性，如果无效就获取不到username</span><br><span class="line">            String username = jwtTokenUtil.getUsernameFromToken(jwtToken);</span><br><span class="line"></span><br><span class="line">            //判断jwtToken中用户名不为空并且Security中还没有认证信息</span><br><span class="line">            if (!username.isEmpty()</span><br><span class="line">                    &amp;&amp; SecurityContextHolder.getContext().getAuthentication() == null)&#123;</span><br><span class="line">                UserDetails userDetails = myUserDetailsService.loadUserByUsername(username);</span><br><span class="line">                //验证令牌正确性，</span><br><span class="line">                if (jwtTokenUtil.validateToken(jwtToken,userDetails))&#123;</span><br><span class="line">                    // 将jwt令牌转换为Security认识的令牌 参数1：用户信息 参数2：密码 参数3：用户的权限信息</span><br><span class="line">                    UsernamePasswordAuthenticationToken authenticationToken</span><br><span class="line">                            = new UsernamePasswordAuthenticationToken(userDetails,null,userDetails.getAuthorities());</span><br><span class="line">                    //把认证权限信息交给Security，如当UsernamePasswordAuthenticationFilter拦截时，发现已经认证过了就不会再次认证</span><br><span class="line">                    SecurityContextHolder.getContext().setAuthentication(authenticationToken);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        filterChain.doFilter(request,response);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>使用aop的思想将它放在UsernamePasswordAuthenticationFilter之前，所以我们需要去配置</p>
<h4 id="Security配置类-1"><a href="#Security配置类-1" class="headerlink" title="Security配置类"></a>Security配置类</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br></pre></td><td class="code"><pre><span class="line">@Configuration</span><br><span class="line">public class SecurityConfig extends WebSecurityConfigurerAdapter &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    //导入自定义动态授权</span><br><span class="line">    @Autowired</span><br><span class="line">    private MyUserDetailsService myUserDetailsService;</span><br><span class="line"></span><br><span class="line">    @Autowired</span><br><span class="line">    private DataSource dataSource;</span><br><span class="line"></span><br><span class="line">    //退出登录自定义策略</span><br><span class="line">    @Autowired</span><br><span class="line">    private MyLogoutSuccessHandler myLogoutSuccessHandler;</span><br><span class="line"></span><br><span class="line">    @Autowired</span><br><span class="line">    private JwtAuthenticationTokenFilter jwtAuthenticationTokenFilter;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 登录认证方法</span><br><span class="line">     * @param http</span><br><span class="line">     * @throws Exception</span><br><span class="line">     */</span><br><span class="line">    @Override</span><br><span class="line">    protected void configure(HttpSecurity http) throws Exception &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        http    //将jwtAuthenticationTokenFilter放置在UsernamePasswordAuthenticationFilter之前</span><br><span class="line">                .addFilterBefore(jwtAuthenticationTokenFilter, UsernamePasswordAuthenticationFilter.class)</span><br><span class="line">                .logout()//开启退出登录</span><br><span class="line">//                .logoutSuccessUrl(&quot;/&quot;) //退出后跳转的页面  默认退出到login页面</span><br><span class="line">                .deleteCookies(&quot;JSESSIONID&quot;) //指定退出后要删除的cookie</span><br><span class="line">                .logoutUrl(&quot;/logout&quot;)  //退出请求路径，也就是页面上退出登录访问的地址  默认logout</span><br><span class="line">                .logoutSuccessHandler(myLogoutSuccessHandler) //使用自定义退出策略 ，不能与logoutSuccessUrl共存，否则失效</span><br><span class="line"></span><br><span class="line">                .and()</span><br><span class="line"></span><br><span class="line">                .rememberMe()//开启记住我功能  ，前端也需要有记住我字段</span><br><span class="line">                .rememberMeCookieName(&quot;rememberMe-Cookie&quot;)  //存在浏览器中cookie的名称</span><br><span class="line">                .rememberMeParameter(&quot;remember-me&quot;)  //表单中 自动登录 勾选框的参数名</span><br><span class="line">                .tokenValiditySeconds(2*24*60*60) //保存Cookie的有效期，默认2周</span><br><span class="line">                .tokenRepository(tokenRepository())  //令牌仓库默认是在内存中,我们指定rememberMe存储到数据库规则方法</span><br><span class="line"></span><br><span class="line">                .and()</span><br><span class="line"></span><br><span class="line">                .csrf().disable()  //关闭防御csrf攻击</span><br><span class="line">                .authorizeRequests() //自定义过滤拦截请求</span><br><span class="line">                .antMatchers(&quot;/login&quot;,&quot;/authentication&quot;,&quot;/refreshToken&quot;) //资源路径</span><br><span class="line">                .permitAll()  //当前资源路径不需要认证就可以访问</span><br><span class="line"></span><br><span class="line">                .anyRequest().access(&quot;@MyRBACService.hasPermission(request,authentication)&quot;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">                .and()</span><br><span class="line">                .sessionManagement()//启用session管理</span><br><span class="line">                .sessionCreationPolicy(SessionCreationPolicy.STATELESS);//不使用session，关闭session</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        //.authorizeHttpRequests()   这样方法表示选中的请求</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 授权方法</span><br><span class="line">     * @param auth</span><br><span class="line">     * @throws Exception</span><br><span class="line">     */</span><br><span class="line">    @Override</span><br><span class="line">    protected void configure(AuthenticationManagerBuilder auth) throws Exception &#123;</span><br><span class="line"></span><br><span class="line">            //这里才是验证登录信息的</span><br><span class="line">            auth.userDetailsService(myUserDetailsService)</span><br><span class="line">                  .passwordEncoder(passwordEncoder());  //配置BCrypt加密，这个会自动调用matches（）这个方法来为我们输入的密码进行对比</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Bean</span><br><span class="line">    public PasswordEncoder passwordEncoder()&#123;</span><br><span class="line">        return new BCryptPasswordEncoder();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 静态资源路径开放</span><br><span class="line">     * @param web</span><br><span class="line">     * @throws Exception</span><br><span class="line">     */</span><br><span class="line">    @Override</span><br><span class="line">    public void configure(WebSecurity web) throws Exception &#123;</span><br><span class="line">        //将项目中的静态资源路径开放出来，在这开放是不需要经过过滤器拦截的</span><br><span class="line">        web.ignoring().antMatchers(&quot;/css/**&quot;,&quot;/fonts/**&quot;,&quot;/img/**&quot;,&quot;/js/**&quot;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 向数据库操作关于记住我的验证信息</span><br><span class="line">     * JdbcTokenRepositoryImpl 这个类中已经固定要存到数据库中的哪个表，我们只需要指定数据源即可</span><br><span class="line">     * initDao() 这个方法有在数据库中创建需要的表，我还没尝试过，我的表是自己手动创建的</span><br><span class="line">     * 设置记住我存储到的数据源是哪个</span><br><span class="line">     * @return</span><br><span class="line">     */</span><br><span class="line">    @Bean</span><br><span class="line">    public PersistentTokenRepository tokenRepository()&#123;</span><br><span class="line">        JdbcTokenRepositoryImpl jdbcTokenRepository = new JdbcTokenRepositoryImpl();</span><br><span class="line">        jdbcTokenRepository.setDataSource(dataSource);</span><br><span class="line">        return jdbcTokenRepository;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    @Bean(name = BeanIds.AUTHENTICATION_MANAGER)</span><br><span class="line">    @Override</span><br><span class="line">    public AuthenticationManager authenticationManagerBean() throws Exception&#123;</span><br><span class="line">        return super.authenticationManagerBean();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>由于我们要使用到别的页面查询是否成功授权鉴权，我们需要一个额外的请求资源</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">@RestController</span><br><span class="line">public class HelloController &#123;</span><br><span class="line"></span><br><span class="line">    @RequestMapping(&quot;/hello&quot;)</span><br><span class="line">    public String hello()&#123;</span><br><span class="line"></span><br><span class="line">        return &quot;world&quot;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>注意我们数据库中记得给当前角色这个资源路径的访问资格</p>
<p><strong>现在开始测试：</strong></p>
<p><strong>这是有权限清空访问</strong></p>
<p><img src="https://s2.loli.net/2022/03/21/vzRBIdb9X6WGD5m.png" alt="image-20220320193906937"></p>
<p><img src="https://s2.loli.net/2022/03/21/mjcJ6BY5k3OQ2Rn.png" alt="image-20220320193505218"></p>
<p><strong>无权限清空下访问：</strong></p>
<p><img src="https://s2.loli.net/2022/03/21/RBq4fEZdC6J9FIl.png" alt="image-20220320193746967"></p>
<p><img src="https://s2.loli.net/2022/03/21/uVZkJzhapcOG6rF.png" alt="image-20220320193640084"></p>
<h2 id="跨域访问："><a href="#跨域访问：" class="headerlink" title="跨域访问："></a>跨域访问：</h2><h3 id="介绍："><a href="#介绍：" class="headerlink" title="介绍："></a>介绍：</h3><p>为什么要跨域访问？跨域访问是什么？</p>
<p>跨域访问也就是A网站直接去访问B网站资源路径，这样的行为是不允许的</p>
<p><strong>如图：</strong></p>
<p><img src="https://s2.loli.net/2022/03/21/4arOfdijuIq8bQv.png" alt="image-20220321151443656"></p>
<h3 id="解决方法："><a href="#解决方法：" class="headerlink" title="解决方法："></a><strong>解决方法：</strong></h3><p><img src="https://s2.loli.net/2022/03/21/XlDL1EcG8rdZ5eb.png" alt="image-20220321152423979"></p>
<h4 id="其他解决方法："><a href="#其他解决方法：" class="headerlink" title="其他解决方法："></a>其他解决方法：</h4><p><img src="https://s2.loli.net/2022/03/21/KRpjq6LcIYf8ZGB.png" alt="image-20220321151622759"></p>
<p><img src="https://s2.loli.net/2022/03/21/aQwmgfGkiMPAVl7.png" alt="image-20220321151629992"></p>
<p><img src="https://s2.loli.net/2022/03/21/fWt3wZsPr1Tupka.png" alt="image-20220321151636299"></p>
<h4 id="SpringBoot解决方法："><a href="#SpringBoot解决方法：" class="headerlink" title="SpringBoot解决方法："></a>SpringBoot解决方法：</h4><p><img src="https://s2.loli.net/2022/03/21/Bnjf38uIDyarETp.png" alt="image-20220321151734457"></p>
<p><img src="https://s2.loli.net/2022/03/21/i6q8xQsg7tDBlIm.png" alt="image-20220321151753953"></p>
<p><img src="https://s2.loli.net/2022/03/21/hMqaYJnE4xoyX7Q.png" alt="image-20220321151800818"></p>
<p><img src="https://s2.loli.net/2022/03/21/GtvJUDmACzo1lrn.png" alt="image-20220321151806595"></p>
<h4 id="SpringBoot-Security解决方法："><a href="#SpringBoot-Security解决方法：" class="headerlink" title="SpringBoot-Security解决方法："></a>SpringBoot-Security解决方法：</h4><p>以上四种其实都可以使用在Security中解决，但是Security有它推荐的方法</p>
<p><strong>其实很简单：</strong></p>
<p>A网站中配置跨域访问权限：http .cors()&#x2F;&#x2F;开启跨域访问</p>
<p>实现bean：</p>
<p>​	注意是这个包下的import org.springframework.web.cors.CorsConfigurationSource;</p>
<pre><code>/**
 * 配置跨域请求CORS源
 * @return
 */
@Bean
public CorsConfigurationSource corsConfigurationSource()&#123;
    CorsConfiguration corsConfiguration = new CorsConfiguration();
    //允许哪些域访问
    corsConfiguration.setAllowedOrigins(Arrays.asList(&quot;http://loaclhost:8080&quot;));
    //访问方式
    corsConfiguration.setAllowedMethods(Arrays.asList(&quot;GET&quot;,&quot;POST&quot;));
    //设置默认参数
    corsConfiguration.applyPermitDefaultValues();

    UrlBasedCorsConfigurationSource source = new UrlBasedCorsConfigurationSource();
    //允许跨域访问哪些资源
    source.registerCorsConfiguration(&quot;/**&quot;,corsConfiguration);
    return source;
&#125;
</code></pre>
<p><strong>配置实例：</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br></pre></td><td class="code"><pre><span class="line">    /**</span><br><span class="line">     * 登录认证方法</span><br><span class="line">     * @param http</span><br><span class="line">     * @throws Exception</span><br><span class="line">     */</span><br><span class="line">    @Override</span><br><span class="line">    protected void configure(HttpSecurity http) throws Exception &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        http .cors()//开启跨域访问</span><br><span class="line">                .and()</span><br><span class="line">                //将jwtAuthenticationTokenFilter放置在UsernamePasswordAuthenticationFilter之前</span><br><span class="line">                .addFilterBefore(jwtAuthenticationTokenFilter, UsernamePasswordAuthenticationFilter.class)</span><br><span class="line">                .logout()//开启退出登录</span><br><span class="line">//                .logoutSuccessUrl(&quot;/&quot;) //退出后跳转的页面  默认退出到login页面</span><br><span class="line">                .deleteCookies(&quot;JSESSIONID&quot;) //指定退出后要删除的cookie</span><br><span class="line">                .logoutUrl(&quot;/logout&quot;)  //退出请求路径，也就是页面上退出登录访问的地址  默认logout</span><br><span class="line">                .logoutSuccessHandler(myLogoutSuccessHandler) //使用自定义退出策略 ，不能与logoutSuccessUrl共存，否则失效</span><br><span class="line"></span><br><span class="line">                .and()</span><br><span class="line"></span><br><span class="line">                .rememberMe()//开启记住我功能  ，前端也需要有记住我字段</span><br><span class="line">                .rememberMeCookieName(&quot;rememberMe-Cookie&quot;)  //存在浏览器中cookie的名称</span><br><span class="line">                .rememberMeParameter(&quot;remember-me&quot;)  //表单中 自动登录 勾选框的参数名</span><br><span class="line">                .tokenValiditySeconds(2*24*60*60) //保存Cookie的有效期，默认2周</span><br><span class="line">                .tokenRepository(tokenRepository())  //令牌仓库默认是在内存中,我们指定rememberMe存储到数据库规则方法</span><br><span class="line"></span><br><span class="line">                .and()</span><br><span class="line"></span><br><span class="line">                .csrf().disable()  //关闭防御csrf攻击</span><br><span class="line">                .authorizeRequests() //自定义过滤拦截请求</span><br><span class="line">                .antMatchers(&quot;/login&quot;,&quot;/authentication&quot;,&quot;/refreshToken&quot;) //资源路径</span><br><span class="line">                .permitAll()  //当前资源路径不需要认证就可以访问</span><br><span class="line"></span><br><span class="line">                .anyRequest().access(&quot;@MyRBACService.hasPermission(request,authentication)&quot;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">                .and()</span><br><span class="line">                .sessionManagement()//启用session管理</span><br><span class="line">                .sessionCreationPolicy(SessionCreationPolicy.STATELESS);//不使用session，关闭session</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        //.authorizeHttpRequests()   这样方法表示选中的请求</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 授权方法</span><br><span class="line">     * @param auth</span><br><span class="line">     * @throws Exception</span><br><span class="line">     */</span><br><span class="line">    @Override</span><br><span class="line">    protected void configure(AuthenticationManagerBuilder auth) throws Exception &#123;</span><br><span class="line"></span><br><span class="line">            //这里才是验证登录信息的</span><br><span class="line">            auth.userDetailsService(myUserDetailsService)</span><br><span class="line">                  .passwordEncoder(passwordEncoder());  //配置BCrypt加密，这个会自动调用matches（）这个方法来为我们输入的密码进行对比</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Bean</span><br><span class="line">    public PasswordEncoder passwordEncoder()&#123;</span><br><span class="line">        return new BCryptPasswordEncoder();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 静态资源路径开放</span><br><span class="line">     * @param web</span><br><span class="line">     * @throws Exception</span><br><span class="line">     */</span><br><span class="line">    @Override</span><br><span class="line">    public void configure(WebSecurity web) throws Exception &#123;</span><br><span class="line">        //将项目中的静态资源路径开放出来，在这开放是不需要经过过滤器拦截的</span><br><span class="line">        web.ignoring().antMatchers(&quot;/css/**&quot;,&quot;/fonts/**&quot;,&quot;/img/**&quot;,&quot;/js/**&quot;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 向数据库操作关于记住我的验证信息</span><br><span class="line">     * JdbcTokenRepositoryImpl 这个类中已经固定要存到数据库中的哪个表，我们只需要指定数据源即可</span><br><span class="line">     * initDao() 这个方法有在数据库中创建需要的表，我还没尝试过，我的表是自己手动创建的</span><br><span class="line">     * 设置记住我存储到的数据源是哪个</span><br><span class="line">     * @return</span><br><span class="line">     */</span><br><span class="line">    @Bean</span><br><span class="line">    public PersistentTokenRepository tokenRepository()&#123;</span><br><span class="line">        JdbcTokenRepositoryImpl jdbcTokenRepository = new JdbcTokenRepositoryImpl();</span><br><span class="line">        jdbcTokenRepository.setDataSource(dataSource);</span><br><span class="line">        return jdbcTokenRepository;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 识别jwt令牌需要的</span><br><span class="line">     * @return</span><br><span class="line">     * @throws Exception</span><br><span class="line">     */</span><br><span class="line">    @Bean(name = BeanIds.AUTHENTICATION_MANAGER)</span><br><span class="line">    @Override</span><br><span class="line">    public AuthenticationManager authenticationManagerBean() throws Exception&#123;</span><br><span class="line">        return super.authenticationManagerBean();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 配置跨域请求CORS源</span><br><span class="line">     * @return</span><br><span class="line">     */</span><br><span class="line">    @Bean</span><br><span class="line">    public CorsConfigurationSource corsConfigurationSource()&#123;</span><br><span class="line">        CorsConfiguration corsConfiguration = new CorsConfiguration();</span><br><span class="line">        //允许哪些域访问  一定要注意最后以/结尾 不让B网站访问就没有用</span><br><span class="line">        corsConfiguration.setAllowedOrigins(Arrays.asList(&quot;http://loaclhost:8080/&quot;));</span><br><span class="line">        //访问方式</span><br><span class="line">        corsConfiguration.setAllowedMethods(Arrays.asList(&quot;GET&quot;,&quot;POST&quot;));</span><br><span class="line">        //设置默认参数</span><br><span class="line">        corsConfiguration.applyPermitDefaultValues();</span><br><span class="line"></span><br><span class="line">        UrlBasedCorsConfigurationSource source = new UrlBasedCorsConfigurationSource();</span><br><span class="line">        //允许跨域访问哪些资源</span><br><span class="line">        source.registerCorsConfiguration(&quot;/**&quot;,corsConfiguration);</span><br><span class="line">        return source;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<h4 id="测试："><a href="#测试：" class="headerlink" title="测试："></a>测试：</h4><p>这里是使用的Security推荐解决方法</p>
<p><strong>B网站向A网站跨域访问前端代码：</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">$.ajax(&#123;</span><br><span class="line">    type: &quot;POST&quot;,</span><br><span class="line">    url: &quot;http://localhost:8081/hello&quot;,</span><br><span class="line">    headers: &#123;</span><br><span class="line">        &#x27;JWTHeaderName&#x27;:&#x27;eyJhbGciOiJIUzUxMiJ9.eyJleHAiOjE2NDc4NTMzNTEsInN1YiI6InVzZXIiLCJjcmVhdGVkIjoxNjQ3ODQ5NzUxODY3fQ.5EC4IhutkrR0er-TkLLHSLXaAZQ1gR48tTi3YOyjJzV-eE9Y0wziMoCRfUb0I4S9eeOr4mG3JloT7HQUTlwF_w&#x27;</span><br><span class="line">    &#125;,</span><br><span class="line">    success: function (json) &#123;</span><br><span class="line">        alert(&quot;跨域请求配置成功&quot;+json);</span><br><span class="line">    &#125;,</span><br><span class="line">    error: function (e) &#123;</span><br><span class="line">        alert(&quot;跨域请求配置失败&quot;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>



<p><strong>A网站未配置B网站跨域访问权限下访问结果：</strong></p>
<p><img src="https://s2.loli.net/2022/03/21/TD8ZIjuQ7gvC94s.png" alt="image-20220321161337254"></p>
<p><strong>A网站配置B网站跨域访问权限下访问结果：</strong></p>
<p>​	配置了后就没有那个提示了</p>
<p><img src="https://s2.loli.net/2022/03/21/B15f4qExDU2nNFo.png" alt="image-20220321161205428"></p>
<h2 id="开启CSRF防御："><a href="#开启CSRF防御：" class="headerlink" title="开启CSRF防御："></a>开启CSRF防御：</h2><h3 id="介绍：-1"><a href="#介绍：-1" class="headerlink" title="介绍："></a>介绍：</h3><p>什么是CSRF防御，那我们先得了解下CSRF攻击</p>
<p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/114750961">什么是CSRF攻击？如何防御CRSF攻击？ - 知乎 (zhihu.com)</a></p>
<h3 id="在Security中配置："><a href="#在Security中配置：" class="headerlink" title="在Security中配置："></a><strong>在Security中配置：</strong></h3><p>配置后访问资源http请求头中需要携带CSRF令牌才能访问，（GET请求除外，GET请求不需要携带CSRF就可以访问）</p>
<p>没访问资源一次就会发生一次新的CSRF令牌，一个令牌只能使用一次</p>
<p><img src="https://s2.loli.net/2022/03/21/kZmP971nS8AXgTJ.png" alt="image-20220321174052920"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">http</span><br><span class="line">        .csrf()//开启CSRF防御（GET请求是不会被防御的）</span><br><span class="line">        //使用cookie存储CSRF令牌（每次防御页面都需要携带该令牌），里面的参数表示这个cookie是可以被js脚本获取到的，</span><br><span class="line">        .csrfTokenRepository(CookieCsrfTokenRepository.withHttpOnlyFalse()) //</span><br><span class="line">        .ignoringAntMatchers(&quot;/authentication&quot;) //排除哪些请求不需要携带CSRF令牌就可以进行访问</span><br></pre></td></tr></table></figure>

<p><strong>完整配置：</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br></pre></td><td class="code"><pre><span class="line">@Configuration</span><br><span class="line">public class SecurityConfig extends WebSecurityConfigurerAdapter &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    //导入自定义动态授权</span><br><span class="line">    @Autowired</span><br><span class="line">    private MyUserDetailsService myUserDetailsService;</span><br><span class="line"></span><br><span class="line">    @Autowired</span><br><span class="line">    private DataSource dataSource;</span><br><span class="line"></span><br><span class="line">    //退出登录自定义策略</span><br><span class="line">    @Autowired</span><br><span class="line">    private MyLogoutSuccessHandler myLogoutSuccessHandler;</span><br><span class="line"></span><br><span class="line">    @Autowired</span><br><span class="line">    private JwtAuthenticationTokenFilter jwtAuthenticationTokenFilter;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 登录认证方法</span><br><span class="line">     * @param http</span><br><span class="line">     * @throws Exception</span><br><span class="line">     */</span><br><span class="line">    @Override</span><br><span class="line">    protected void configure(HttpSecurity http) throws Exception &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        http</span><br><span class="line">                .csrf()//开启CSRF防御（GET请求是不会被防御的）</span><br><span class="line">                //使用cookie存储CSRF令牌（每次防御页面都需要携带该令牌），里面的参数表示这个cookie是可以被js脚本获取到的，</span><br><span class="line">                .csrfTokenRepository(CookieCsrfTokenRepository.withHttpOnlyFalse()) //</span><br><span class="line">                .ignoringAntMatchers(&quot;/authentication&quot;) //排除哪些请求不需要携带CSRF令牌就可以进行访问</span><br><span class="line"></span><br><span class="line">                .and()</span><br><span class="line"></span><br><span class="line">                .cors()//开启跨域访问</span><br><span class="line">                .and()</span><br><span class="line">                //将jwtAuthenticationTokenFilter放置在UsernamePasswordAuthenticationFilter之前</span><br><span class="line">                .addFilterBefore(jwtAuthenticationTokenFilter, UsernamePasswordAuthenticationFilter.class)</span><br><span class="line">                .logout()//开启退出登录</span><br><span class="line">//                .logoutSuccessUrl(&quot;/&quot;) //退出后跳转的页面  默认退出到login页面</span><br><span class="line">                .deleteCookies(&quot;JSESSIONID&quot;) //指定退出后要删除的cookie</span><br><span class="line">                .logoutUrl(&quot;/logout&quot;)  //退出请求路径，也就是页面上退出登录访问的地址  默认logout</span><br><span class="line">                .logoutSuccessHandler(myLogoutSuccessHandler) //使用自定义退出策略 ，不能与logoutSuccessUrl共存，否则失效</span><br><span class="line"></span><br><span class="line">                .and()</span><br><span class="line"></span><br><span class="line">                .rememberMe()//开启记住我功能  ，前端也需要有记住我字段</span><br><span class="line">                .rememberMeCookieName(&quot;rememberMe-Cookie&quot;)  //存在浏览器中cookie的名称</span><br><span class="line">                .rememberMeParameter(&quot;remember-me&quot;)  //表单中 自动登录 勾选框的参数名</span><br><span class="line">                .tokenValiditySeconds(2*24*60*60) //保存Cookie的有效期，默认2周</span><br><span class="line">                .tokenRepository(tokenRepository())  //令牌仓库默认是在内存中,我们指定rememberMe存储到数据库规则方法</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">                .and()</span><br><span class="line">                .authorizeRequests() //自定义过滤拦截请求</span><br><span class="line">                .antMatchers(&quot;/login&quot;,&quot;/authentication&quot;,&quot;/refreshToken&quot;) //资源路径</span><br><span class="line">                .permitAll()  //当前资源路径不需要认证就可以访问</span><br><span class="line"></span><br><span class="line">                .anyRequest().access(&quot;@MyRBACService.hasPermission(request,authentication)&quot;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">                .and()</span><br><span class="line">                .sessionManagement()//启用session管理</span><br><span class="line">                .sessionCreationPolicy(SessionCreationPolicy.STATELESS);//不使用session，关闭session</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        //.authorizeHttpRequests()   这样方法表示选中的请求</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 授权方法</span><br><span class="line">     * @param auth</span><br><span class="line">     * @throws Exception</span><br><span class="line">     */</span><br><span class="line">    @Override</span><br><span class="line">    protected void configure(AuthenticationManagerBuilder auth) throws Exception &#123;</span><br><span class="line"></span><br><span class="line">            //这里才是验证登录信息的</span><br><span class="line">            auth.userDetailsService(myUserDetailsService)</span><br><span class="line">                  .passwordEncoder(passwordEncoder());  //配置BCrypt加密，这个会自动调用matches（）这个方法来为我们输入的密码进行对比</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Bean</span><br><span class="line">    public PasswordEncoder passwordEncoder()&#123;</span><br><span class="line">        return new BCryptPasswordEncoder();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 静态资源路径开放</span><br><span class="line">     * @param web</span><br><span class="line">     * @throws Exception</span><br><span class="line">     */</span><br><span class="line">    @Override</span><br><span class="line">    public void configure(WebSecurity web) throws Exception &#123;</span><br><span class="line">        //将项目中的静态资源路径开放出来，在这开放是不需要经过过滤器拦截的</span><br><span class="line">        web.ignoring().antMatchers(&quot;/css/**&quot;,&quot;/fonts/**&quot;,&quot;/img/**&quot;,&quot;/js/**&quot;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 向数据库操作关于记住我的验证信息</span><br><span class="line">     * JdbcTokenRepositoryImpl 这个类中已经固定要存到数据库中的哪个表，我们只需要指定数据源即可</span><br><span class="line">     * initDao() 这个方法有在数据库中创建需要的表，我还没尝试过，我的表是自己手动创建的</span><br><span class="line">     * 设置记住我存储到的数据源是哪个</span><br><span class="line">     * @return</span><br><span class="line">     */</span><br><span class="line">    @Bean</span><br><span class="line">    public PersistentTokenRepository tokenRepository()&#123;</span><br><span class="line">        JdbcTokenRepositoryImpl jdbcTokenRepository = new JdbcTokenRepositoryImpl();</span><br><span class="line">        jdbcTokenRepository.setDataSource(dataSource);</span><br><span class="line">        return jdbcTokenRepository;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 识别jwt令牌需要的</span><br><span class="line">     * @return</span><br><span class="line">     * @throws Exception</span><br><span class="line">     */</span><br><span class="line">    @Bean(name = BeanIds.AUTHENTICATION_MANAGER)</span><br><span class="line">    @Override</span><br><span class="line">    public AuthenticationManager authenticationManagerBean() throws Exception&#123;</span><br><span class="line">        return super.authenticationManagerBean();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 配置跨域请求CORS源</span><br><span class="line">     * @return</span><br><span class="line">     */</span><br><span class="line">    @Bean</span><br><span class="line">    public CorsConfigurationSource corsConfigurationSource()&#123;</span><br><span class="line">        CorsConfiguration corsConfiguration = new CorsConfiguration();</span><br><span class="line">        //允许哪些域访问</span><br><span class="line">        corsConfiguration.setAllowedOrigins(Arrays.asList(&quot;http://localhost:8080&quot;));</span><br><span class="line">        //访问方式</span><br><span class="line">        corsConfiguration.setAllowedMethods(Arrays.asList(&quot;GET&quot;,&quot;POST&quot;));</span><br><span class="line">        //设置默认参数</span><br><span class="line">        corsConfiguration.applyPermitDefaultValues();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        UrlBasedCorsConfigurationSource source = new UrlBasedCorsConfigurationSource();</span><br><span class="line">        //允许跨域访问哪些资源</span><br><span class="line">        source.registerCorsConfiguration(&quot;/**&quot;,corsConfiguration);</span><br><span class="line">        return source;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://s2.loli.net/2022/03/21/2QsiSmgb1pR6c8k.png" alt="image-20220321172831555"></p>
<h3 id="使用测试"><a href="#使用测试" class="headerlink" title="使用测试"></a>使用测试</h3><p><strong>先使用我们登录的请求获取jwt令牌与CSRF令牌</strong></p>
<p><img src="https://s2.loli.net/2022/03/21/zJYNqRbAeBVXd7G.png" alt="image-20220321171847532"></p>
<p><strong>进行访问&#x2F;hello：</strong></p>
<p>不携带CSRF令牌进行访问：</p>
<p><img src="https://s2.loli.net/2022/03/21/FqsVLNpkCJTfZd7.png" alt="image-20220321171956312"></p>
<p>携带CSRF令牌进行访问：</p>
<p><img src="https://s2.loli.net/2022/03/21/AFh2SfxW9YQv3gH.png" alt="image-20220321172017322"></p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="https://apathy99977.github.io">Gods</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://apathy99977.github.io/2022/05/02/SpringBootSecurity/">https://apathy99977.github.io/2022/05/02/SpringBootSecurity/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://apathy99977.github.io" target="_blank">Gods Blog</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/%E5%AE%89%E5%85%A8%E6%A1%86%E6%9E%B6/">安全框架</a></div><div class="post_share"><div class="social-share" data-image="https://s1.ax1x.com/2022/06/27/jVPNPs.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/gh/overtrue/share.js@master/dist/js/social-share.min.js" defer></script></div></div><div class="post-reward"><div class="reward-button"><i class="fas fa-qrcode"></i> 打赏</div><div class="reward-main"><ul class="reward-all"><li class="reward-item"><a href="/./img/weixin.png" target="_blank"><img class="post-qr-code-img" src="/./img/weixin.png" alt="微信"/></a><div class="post-qr-code-desc">微信</div></li><li class="reward-item"><a href="/./img/zhifubao.png" target="_blank"><img class="post-qr-code-img" src="/./img/zhifubao.png" alt="支付宝"/></a><div class="post-qr-code-desc">支付宝</div></li></ul></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-full"><a href="/2022/05/14/%E5%8D%9A%E5%AE%A2%E6%8A%80%E6%9C%AF%E6%80%BB%E7%BB%93/"><img class="prev-cover" src="https://s1.ax1x.com/2022/06/23/jCEVbj.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">博客技术总结</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/2022/06/18/SpringSecurity_JWT%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8/" title="SpringSecurity_JWT快速入门"><img class="cover" src="https://s1.ax1x.com/2022/06/27/jVP0MV.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-06-18</div><div class="title">SpringSecurity_JWT快速入门</div></div></a></div></div></div><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div id="waline-wrap"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="https://s1.ax1x.com/2022/06/23/j9vtUg.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">Gods</div><div class="author-info__description">人来人往，勿失勿忘。</div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">18</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">30</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">28</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/Apathy99977"><i class="fab fa-github"></i><span>Github</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/Apathy99977/Apathy99977.github.io" target="_blank" title="Github"><i class="fab fa-github"></i></a><a class="social-icon" href="tencent://AddContact/?fromId=45&amp;fromSubId=1&amp;subcmd=all&amp;uin=2523941358&amp;website=www.qtxml.cn" target="_blank" title="QQ"><i class="fa-brands fa-qq"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">我们登上并非我们所选择的舞台，演出并非我们所选择的剧本。人这一生中，我们能自己决定的事情其实非常少。如果这次你能自己决定的话，那我觉得...那就勇敢点嘛！</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#SpringBoot%E5%AE%89%E5%85%A8%E6%A1%86%E6%9E%B6%EF%BC%9A"><span class="toc-number">1.</span> <span class="toc-text">SpringBoot安全框架：</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#HttpBasic%E8%AE%A4%E8%AF%81%E6%A8%A1%E5%BC%8F%EF%BC%9A"><span class="toc-number">1.1.</span> <span class="toc-text">HttpBasic认证模式：</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#passwrodEncoder%E5%8A%A0%E5%AF%86"><span class="toc-number">1.2.</span> <span class="toc-text">passwrodEncoder加密</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#formLogin%E7%99%BB%E5%BD%95%E8%AE%A4%E8%AF%81"><span class="toc-number">1.3.</span> <span class="toc-text">formLogin登录认证</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%90%8C%E6%A0%B7%E5%85%88%E7%BC%96%E5%86%99%E9%85%8D%E7%BD%AE%E7%B1%BB%EF%BC%9A"><span class="toc-number">1.3.1.</span> <span class="toc-text">同样先编写配置类：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#controller%E7%B1%BB%EF%BC%9A"><span class="toc-number">1.3.2.</span> <span class="toc-text">controller类：</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E7%99%BB%E5%BD%95%E9%AA%8C%E8%AF%81%E5%A4%84%E7%90%86%EF%BC%9A"><span class="toc-number">1.4.</span> <span class="toc-text">自定义登录验证处理：</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#session%E4%BC%9A%E8%AF%9D%E7%9A%84%E5%AE%89%E5%85%A8%E7%AE%A1%E7%90%86%EF%BC%9A"><span class="toc-number">1.5.</span> <span class="toc-text">session会话的安全管理：</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%90%8C%E8%B4%A6%E5%8F%B7%E5%A4%9A%E7%99%BB%E5%BD%95%E8%B8%A2%E4%B8%8B%E7%BA%BF%EF%BC%9A"><span class="toc-number">1.6.</span> <span class="toc-text">同账号多登录踢下线：</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#RBAC%E6%9D%83%E9%99%90%E7%AE%A1%E7%90%86%E6%8E%A7%E5%88%B6%E6%A8%A1%E5%9E%8B"><span class="toc-number">1.7.</span> <span class="toc-text">RBAC权限管理控制模型</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8A%A8%E6%80%81%E5%8A%A0%E8%BD%BD%E7%94%A8%E6%88%B7%E8%A7%92%E8%89%B2%E6%9D%83%E9%99%90%E6%95%B0%E6%8D%AE%EF%BC%9A"><span class="toc-number">1.8.</span> <span class="toc-text">动态加载用户角色权限数据：</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#UserDetails%EF%BC%9A"><span class="toc-number">1.8.1.</span> <span class="toc-text">UserDetails：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#UserDetailsService%EF%BC%9A"><span class="toc-number">1.8.2.</span> <span class="toc-text">UserDetailsService：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9Security%E9%85%8D%E7%BD%AE%E7%B1%BB%EF%BC%9A"><span class="toc-number">1.8.3.</span> <span class="toc-text">修改Security配置类：</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8A%A8%E6%80%81%E9%89%B4%E6%9D%83%E8%A7%84%E5%88%99%EF%BC%9A"><span class="toc-number">1.9.</span> <span class="toc-text">动态鉴权规则：</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E9%89%B4%E6%9D%83%E8%A7%84%E5%88%99%EF%BC%9A"><span class="toc-number">1.9.0.0.1.</span> <span class="toc-text">自定义鉴权规则：</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Security%E9%85%8D%E7%BD%AE%E7%B1%BB%EF%BC%9A"><span class="toc-number">1.9.0.0.2.</span> <span class="toc-text">Security配置类：</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%96%B9%E6%B3%95%E5%A2%9E%E5%BC%BA%E6%B3%A8%E8%A7%A3%EF%BC%9A"><span class="toc-number">1.9.0.0.3.</span> <span class="toc-text">方法增强注解：</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%AE%B0%E4%BD%8F%E6%88%91%E5%8A%9F%E8%83%BD%EF%BC%9A"><span class="toc-number">1.10.</span> <span class="toc-text">记住我功能：</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#Security%E9%85%8D%E7%BD%AE%E7%B1%BB"><span class="toc-number">1.10.0.0.1.</span> <span class="toc-text">Security配置类:</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%89%8D%E7%AB%AF%EF%BC%9A"><span class="toc-number">1.10.0.0.2.</span> <span class="toc-text">前端：</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%B8%AA%E6%80%A7%E5%8C%96%E9%85%8D%E7%BD%AE"><span class="toc-number">1.10.0.0.3.</span> <span class="toc-text">个性化配置</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%AE%B0%E4%BD%8F%E6%88%91%E5%8A%9F%E8%83%BD%E5%B0%86%E9%AA%8C%E8%AF%81%E6%95%B0%E6%8D%AE%E4%BF%9D%E5%AD%98%E5%88%B0%E6%95%B0%E6%8D%AE%E5%BA%93%EF%BC%9A"><span class="toc-number">1.11.</span> <span class="toc-text">记住我功能将验证数据保存到数据库：</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%80%80%E5%87%BA%E7%99%BB%E5%BD%95%EF%BC%9A"><span class="toc-number">1.12.</span> <span class="toc-text">退出登录：</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%9C%80%E7%AE%80%E5%8D%95%E7%9A%84%E5%AE%9E%E7%8E%B0"><span class="toc-number">1.12.0.0.1.</span> <span class="toc-text">最简单的实现</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Logout%E7%9A%84%E9%BB%98%E8%AE%A4%E8%A1%8C%E4%B8%BA"><span class="toc-number">1.12.0.0.2.</span> <span class="toc-text">Logout的默认行为</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%B8%AA%E6%80%A7%E5%8C%96%E9%85%8D%E7%BD%AE-1"><span class="toc-number">1.12.0.0.3.</span> <span class="toc-text">个性化配置</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#LogoutSuccessHandler-%E5%AE%9E%E7%8E%B0%E4%B8%AA%E6%80%A7%E5%8C%96%E8%A7%84%E7%A8%8B%E5%8A%9F%E8%83%BD"><span class="toc-number">1.12.0.0.4.</span> <span class="toc-text">LogoutSuccessHandler:实现个性化规程功能</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Session%E6%96%B9%E5%BC%8F%E5%AE%9E%E7%8E%B0%E5%9B%BE%E7%89%87%E9%AA%8C%E8%AF%81%E7%A0%81"><span class="toc-number">1.13.</span> <span class="toc-text">Session方式实现图片验证码:</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%EF%BC%9A"><span class="toc-number">1.13.1.</span> <span class="toc-text">配置：</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%AC%AC%E4%B8%80%E7%A7%8D%E6%96%B9%E5%BC%8F%EF%BC%9A"><span class="toc-number">1.13.1.0.1.</span> <span class="toc-text">第一种方式：</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%AC%AC%E4%BA%8C%E7%A7%8D%E6%96%B9%E5%BC%8F%EF%BC%9A"><span class="toc-number">1.13.1.0.2.</span> <span class="toc-text">第二种方式：</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%86%8D%E5%88%9B%E5%BB%BA%E4%B8%80%E4%B8%AA%E9%85%8D%E7%BD%AE%E7%B1%BB%EF%BC%9A"><span class="toc-number">1.13.1.0.3.</span> <span class="toc-text">再创建一个配置类：</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E5%9B%BE%E7%89%87%E9%AA%8C%E8%AF%81%E7%A0%81%E5%8A%A0%E8%BD%BD%EF%BC%9A"><span class="toc-number">1.13.2.</span> <span class="toc-text">实现图片验证码加载：</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%AD%98%E5%82%A8%E8%B0%9C%E5%BA%95%E4%B8%8E%E9%AA%8C%E8%AF%81%E7%A0%81%E8%BF%87%E6%9C%9F%E6%97%B6%E9%97%B4%E7%B1%BB"><span class="toc-number">1.13.2.0.1.</span> <span class="toc-text">存储谜底与验证码过期时间类</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%AA%8C%E8%AF%81%E7%A0%81%E5%9B%BE%E7%89%87Controller%EF%BC%9A"><span class="toc-number">1.13.2.0.2.</span> <span class="toc-text">验证码图片Controller：</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%89%8D%E7%AB%AF%E6%8E%A5%E6%94%B6%EF%BC%9A"><span class="toc-number">1.13.2.0.3.</span> <span class="toc-text">前端接收：</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9B%BE%E7%89%87%E9%AA%8C%E8%AF%81%E7%A0%81%E9%AA%8C%E8%AF%81%EF%BC%9A"><span class="toc-number">1.13.3.</span> <span class="toc-text">图片验证码验证：</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%9C%A8%E8%BF%99%E5%85%B6%E4%B8%AD%E8%A6%81%E6%88%91%E4%BB%AC%E9%9C%80%E8%A6%81%E4%BF%AE%E6%94%B9%E4%B8%8B%E5%8E%9F%E6%9D%A5%E7%9A%84%E7%99%BB%E5%BD%95%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%86%E7%B1%BB%EF%BC%9A"><span class="toc-number">1.13.3.0.1.</span> <span class="toc-text">在这其中要我们需要修改下原来的登录错误处理类：</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%B9%B6%E4%B8%94%E6%88%91%E4%BB%AC%E5%AE%9A%E4%B9%89%E4%B8%80%E4%B8%AA%E5%B8%B8%E9%87%8F%E7%B1%BB%EF%BC%8C%E4%B8%BA%E4%BA%86%E8%B7%9F%E6%96%B9%E4%BE%BF%E8%AE%B0%E4%BD%8F%E9%87%8D%E5%A4%8D%E5%8F%82%E6%95%B0%E4%BF%A1%E6%81%AF%EF%BC%9A"><span class="toc-number">1.13.3.0.2.</span> <span class="toc-text">并且我们定义一个常量类，为了跟方便记住重复参数信息：</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E8%BF%87%E6%BB%A4%E5%99%A8%EF%BC%9A"><span class="toc-number">1.13.3.0.3.</span> <span class="toc-text">创建过滤器：</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Security%E9%85%8D%E7%BD%AE%E7%B1%BB%EF%BC%9A-1"><span class="toc-number">1.13.3.0.4.</span> <span class="toc-text">Security配置类：</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%89%8B%E6%9C%BA%E5%8F%B7%E9%AA%8C%E8%AF%81%E7%A0%81%E7%99%BB%E5%BD%95%EF%BC%9A"><span class="toc-number">1.14.</span> <span class="toc-text">手机号验证码登录：</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%86%E6%9E%90%EF%BC%9A"><span class="toc-number">1.14.1.</span> <span class="toc-text">分析：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#controller%EF%BC%9A"><span class="toc-number">1.14.2.</span> <span class="toc-text">controller：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#PhoneCaptchaVo"><span class="toc-number">1.14.3.</span> <span class="toc-text">PhoneCaptchaVo :</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E8%BF%87%E6%BB%A4%E5%99%A8%E8%BF%9B%E8%A1%8C%E8%B0%9C%E5%BA%95%E9%AA%8C%E8%AF%81%EF%BC%9A"><span class="toc-number">1.14.4.</span> <span class="toc-text">使用过滤器进行谜底验证：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%9F%AD%E4%BF%A1%E9%89%B4%E5%AE%9A%E7%99%BB%E5%BD%95%E8%BF%87%E6%BB%A4%E5%99%A8%EF%BC%9A"><span class="toc-number">1.14.5.</span> <span class="toc-text">短信鉴定登录过滤器：</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E5%9B%BE%E4%B8%AD%E7%AC%AC%E4%B8%80%E4%B8%AA%E6%AD%A5%E9%AA%A4"><span class="toc-number">1.14.5.1.</span> <span class="toc-text">实现图中第一个步骤:</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#PhoneAuthenticationFilter%EF%BC%9A"><span class="toc-number">1.14.5.1.1.</span> <span class="toc-text">PhoneAuthenticationFilter：</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#PhoneAuthenticationToken%EF%BC%9A"><span class="toc-number">1.14.5.1.2.</span> <span class="toc-text">PhoneAuthenticationToken：</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%84%B6%E5%90%8E%E5%86%8D%E5%AE%9E%E7%8E%B0%E5%9B%BE%E4%B8%AD%E7%AC%AC%E4%BA%8C%E4%B8%AA%E6%AD%A5%E9%AA%A4%EF%BC%9A"><span class="toc-number">1.14.5.2.</span> <span class="toc-text">然后再实现图中第二个步骤：</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E9%89%B4%E5%AE%9A%E6%8F%90%E4%BE%9B%E8%80%85"><span class="toc-number">1.14.5.2.1.</span> <span class="toc-text">实现鉴定提供者</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%8D%95%E7%8B%AC%E9%85%8D%E7%BD%AE%E7%B1%BB"><span class="toc-number">1.14.5.2.2.</span> <span class="toc-text">单独配置类</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Securty%E9%85%8D%E7%BD%AE%E7%B1%BB%EF%BC%9A"><span class="toc-number">1.14.5.2.3.</span> <span class="toc-text">Securty配置类：</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%89%8D%E7%AB%AF%E4%BB%A3%E7%A0%81"><span class="toc-number">1.14.6.</span> <span class="toc-text">前端代码</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#JWT"><span class="toc-number">1.15.</span> <span class="toc-text">JWT</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#jwt%E4%BB%8B%E7%BB%8D%EF%BC%9A"><span class="toc-number">1.15.1.</span> <span class="toc-text">jwt介绍：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9B%E5%BB%BAJWT%E5%B7%A5%E5%85%B7%E7%B1%BB%EF%BC%9A"><span class="toc-number">1.15.2.</span> <span class="toc-text">创建JWT工具类：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#JWT%E5%AE%9E%E7%8E%B0%E7%99%BB%E5%BD%95%EF%BC%9A"><span class="toc-number">1.15.3.</span> <span class="toc-text">JWT实现登录：</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Controller%EF%BC%9A"><span class="toc-number">1.15.3.1.</span> <span class="toc-text">Controller：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Service%EF%BC%9A"><span class="toc-number">1.15.3.2.</span> <span class="toc-text">Service：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E6%95%88%E6%9E%9C%EF%BC%9A"><span class="toc-number">1.15.3.3.</span> <span class="toc-text">实现效果：</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#jwt%E7%94%A8%E6%88%B7%E6%8E%88%E6%9D%83"><span class="toc-number">1.15.4.</span> <span class="toc-text">jwt用户授权</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#jwt%E8%BA%AB%E4%BB%BD%E6%8E%88%E6%9D%83%E9%89%B4%E6%9D%83%E8%BF%87%E6%BB%A4%E5%99%A8"><span class="toc-number">1.15.4.1.</span> <span class="toc-text">jwt身份授权鉴权过滤器</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Security%E9%85%8D%E7%BD%AE%E7%B1%BB-1"><span class="toc-number">1.15.4.2.</span> <span class="toc-text">Security配置类</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%B7%A8%E5%9F%9F%E8%AE%BF%E9%97%AE%EF%BC%9A"><span class="toc-number">1.16.</span> <span class="toc-text">跨域访问：</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%8B%E7%BB%8D%EF%BC%9A"><span class="toc-number">1.16.1.</span> <span class="toc-text">介绍：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A7%A3%E5%86%B3%E6%96%B9%E6%B3%95%EF%BC%9A"><span class="toc-number">1.16.2.</span> <span class="toc-text">解决方法：</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%85%B6%E4%BB%96%E8%A7%A3%E5%86%B3%E6%96%B9%E6%B3%95%EF%BC%9A"><span class="toc-number">1.16.2.1.</span> <span class="toc-text">其他解决方法：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#SpringBoot%E8%A7%A3%E5%86%B3%E6%96%B9%E6%B3%95%EF%BC%9A"><span class="toc-number">1.16.2.2.</span> <span class="toc-text">SpringBoot解决方法：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#SpringBoot-Security%E8%A7%A3%E5%86%B3%E6%96%B9%E6%B3%95%EF%BC%9A"><span class="toc-number">1.16.2.3.</span> <span class="toc-text">SpringBoot-Security解决方法：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95%EF%BC%9A"><span class="toc-number">1.16.2.4.</span> <span class="toc-text">测试：</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%BC%80%E5%90%AFCSRF%E9%98%B2%E5%BE%A1%EF%BC%9A"><span class="toc-number">1.17.</span> <span class="toc-text">开启CSRF防御：</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%8B%E7%BB%8D%EF%BC%9A-1"><span class="toc-number">1.17.1.</span> <span class="toc-text">介绍：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9C%A8Security%E4%B8%AD%E9%85%8D%E7%BD%AE%EF%BC%9A"><span class="toc-number">1.17.2.</span> <span class="toc-text">在Security中配置：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E6%B5%8B%E8%AF%95"><span class="toc-number">1.17.3.</span> <span class="toc-text">使用测试</span></a></li></ol></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2022/08/09/React%E9%80%9A%E8%BF%87useEffect%E4%BD%BF%E7%94%A8%E5%AE%9A%E6%97%B6%E5%99%A8/" title="React通过useEffect使用定时器"><img src="https://img2.baidu.com/it/u=3441788149,21316216&amp;fm=253&amp;fmt=auto&amp;app=138&amp;f=PNG?w=1280&amp;h=428" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="React通过useEffect使用定时器"/></a><div class="content"><a class="title" href="/2022/08/09/React%E9%80%9A%E8%BF%87useEffect%E4%BD%BF%E7%94%A8%E5%AE%9A%E6%97%B6%E5%99%A8/" title="React通过useEffect使用定时器">React通过useEffect使用定时器</a><time datetime="2022-08-09T05:14:00.000Z" title="发表于 2022-08-09 13:14:00">2022-08-09</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/08/08/Redis%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8/" title="Redis快速入门"><img src="https://img2.baidu.com/it/u=3441788149,21316216&amp;fm=253&amp;fmt=auto&amp;app=138&amp;f=PNG?w=1280&amp;h=428" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Redis快速入门"/></a><div class="content"><a class="title" href="/2022/08/08/Redis%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8/" title="Redis快速入门">Redis快速入门</a><time datetime="2022-08-08T05:14:00.000Z" title="发表于 2022-08-08 13:14:00">2022-08-08</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/07/09/%E8%BF%9C%E7%A8%8B%E8%BF%87%E7%A8%8B%E8%B0%83%E7%94%A8(RPC)%E8%AF%A6%E8%A7%A3/" title="远程过程调用(RPC)详解"><img src="https://s1.ax1x.com/2022/07/10/jyJOQx.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="远程过程调用(RPC)详解"/></a><div class="content"><a class="title" href="/2022/07/09/%E8%BF%9C%E7%A8%8B%E8%BF%87%E7%A8%8B%E8%B0%83%E7%94%A8(RPC)%E8%AF%A6%E8%A7%A3/" title="远程过程调用(RPC)详解">远程过程调用(RPC)详解</a><time datetime="2022-07-09T05:14:00.000Z" title="发表于 2022-07-09 13:14:00">2022-07-09</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/07/07/React%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8/" title="React快速入门"><img src="https://img0.baidu.com/it/u=1179375633,321144652&amp;fm=253&amp;fmt=auto&amp;app=138&amp;f=PNG?w=889&amp;h=500" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="React快速入门"/></a><div class="content"><a class="title" href="/2022/07/07/React%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8/" title="React快速入门">React快速入门</a><time datetime="2022-07-07T05:14:00.000Z" title="发表于 2022-07-07 13:14:00">2022-07-07</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/07/01/HashMap%E6%BA%90%E7%A0%81%E8%AE%B2%E8%A7%A3/" title="HashMap源码讲解"><img src="https://s1.ax1x.com/2022/07/08/j0Tapq.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="HashMap源码讲解"/></a><div class="content"><a class="title" href="/2022/07/01/HashMap%E6%BA%90%E7%A0%81%E8%AE%B2%E8%A7%A3/" title="HashMap源码讲解">HashMap源码讲解</a><time datetime="2022-07-01T05:06:14.000Z" title="发表于 2022-07-01 13:06:14">2022-07-01</time></div></div></div></div></div></div></main><footer id="footer" style="background-image: url('https://s1.ax1x.com/2022/06/27/jVPNPs.jpg')"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2022 By Gods</div><div class="footer_custom_text">赣ICP备2022000114号</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div id="local-search-results"></div></div></div><div id="search-mask"></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.umd.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page@5/instantpage.min.js" type="module"></script><script>function panguFn () {
  if (typeof pangu === 'object') pangu.autoSpacingPage()
  else {
    getScript('https://cdn.jsdelivr.net/npm/pangu@4/dist/browser/pangu.min.js')
      .then(() => {
        pangu.autoSpacingPage()
      })
  }
}

function panguInit () {
  if (false){
    GLOBAL_CONFIG_SITE.isPost && panguFn()
  } else {
    panguFn()
  }
}

document.addEventListener('DOMContentLoaded', panguInit)</script><script src="/js/search/local-search.js"></script><script>var preloader = {
  endLoading: () => {
    document.body.style.overflow = 'auto';
    document.getElementById('loading-box').classList.add("loaded")
  },
  initLoading: () => {
    document.body.style.overflow = '';
    document.getElementById('loading-box').classList.remove("loaded")

  }
}
window.addEventListener('load',preloader.endLoading())</script><div class="js-pjax"><script>function loadWaline () {
  function insertCSS () {
    const link = document.createElement("link")
    link.rel = "stylesheet"
    link.href = "https://cdn.jsdelivr.net/npm/@waline/client/dist/waline.css"
    document.head.appendChild(link)
  }

  function initWaline () {
    const waline = Waline.init(Object.assign({
      el: '#waline-wrap',
      serverURL: 'https://gods-blog-mt657aa4k-apathy99977.vercel.app/',
      pageview: true,
      dark: 'html[data-theme="dark"]',
      path: window.location.pathname,
      comment: false,
    }, null))
  }

  if (typeof Waline === 'function') initWaline()
  else {
    insertCSS()
    getScript('https://cdn.jsdelivr.net/npm/@waline/client/dist/waline.js').then(initWaline)
  }
}

if ('Waline' === 'Waline' || !false) {
  if (false) btf.loadComment(document.getElementById('waline-wrap'),loadWaline)
  else setTimeout(loadWaline, 0)
} else {
  function loadOtherComment () {
    loadWaline()
  }
}</script></div><div class="aplayer no-destroy" data-id="7497337557" data-server="netease" data-type="playlist" data-fixed="true" data-autoplay="true"> </div><script defer https://npm.elemecdn.com/vue@2.6.11"></script><script async src="https://cdn.jsdelivr.net/gh/zjwo/CDN/js/pyq/pyq.min.js"></script><canvas class="fireworks" mobile="false"></canvas><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/fireworks.min.js"></script><script defer="defer" id="fluttering_ribbon" mobile="false" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/canvas-fluttering-ribbon.min.js"></script><script id="canvas_nest" defer="defer" color="0,0,255" opacity="0.7" zIndex="-1" count="99" mobile="false" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/canvas-nest.min.js"></script><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/activate-power-mode.min.js"></script><script>POWERMODE.colorful = true;
POWERMODE.shake = false;
POWERMODE.mobile = false;
document.body.addEventListener('input', POWERMODE);
</script><script>window.$crisp = [];
window.CRISP_WEBSITE_ID = "9951e60a-5ca1-432a-b106-dca4b27d6f8b";
(function () {
  d = document;
  s = d.createElement("script");
  s.src = "https://client.crisp.chat/l.js";
  s.async = 1;
  d.getElementsByTagName("head")[0].appendChild(s);
})();
$crisp.push(["safe", true])

if (false) {
  $crisp.push(["do", "chat:hide"])
  $crisp.push(["on", "chat:closed", function() {
    $crisp.push(["do", "chat:hide"])
  }])
  var chatBtnFn = () => {
    var chatBtn = document.getElementById("chat_btn")
    chatBtn.addEventListener("click", function(){
      $crisp.push(["do", "chat:show"])
      $crisp.push(["do", "chat:open"])

    });
  }
  chatBtnFn()
} else {
  if (false) {
    function chatBtnHide () {
      $crisp.push(["do", "chat:hide"])
    }
    function chatBtnShow () {
      $crisp.push(["do", "chat:show"])
    }
  }
}</script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/aplayer@1/dist/APlayer.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/aplayer@1/dist/APlayer.min.js"></script><script src="https://cdn.jsdelivr.net/gh/metowolf/MetingJS@1.2/dist/Meting.min.js"></script><script src="https://cdn.jsdelivr.net/npm/pjax/pjax.min.js"></script><script>let pjaxSelectors = ["head > title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show",".js-pjax"]

var pjax = new Pjax({
  elements: 'a:not([target="_blank"])',
  selectors: pjaxSelectors,
  cacheBust: false,
  analytics: false,
  scrollRestoration: false
})

document.addEventListener('pjax:send', function () {

  // removeEventListener scroll 
  window.tocScrollFn && window.removeEventListener('scroll', window.tocScrollFn)
  window.scrollCollect && window.removeEventListener('scroll', scrollCollect)

  typeof preloader === 'object' && preloader.initLoading()
  document.getElementById('rightside').style.cssText = "opacity: ''; transform: ''"
  
  if (window.aplayers) {
    for (let i = 0; i < window.aplayers.length; i++) {
      if (!window.aplayers[i].options.fixed) {
        window.aplayers[i].destroy()
      }
    }
  }

  typeof typed === 'object' && typed.destroy()

  //reset readmode
  const $bodyClassList = document.body.classList
  $bodyClassList.contains('read-mode') && $bodyClassList.remove('read-mode')

})

document.addEventListener('pjax:complete', function () {
  window.refreshFn()

  document.querySelectorAll('script[data-pjax]').forEach(item => {
    const newScript = document.createElement('script')
    const content = item.text || item.textContent || item.innerHTML || ""
    Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
    newScript.appendChild(document.createTextNode(content))
    item.parentNode.replaceChild(newScript, item)
  })

  GLOBAL_CONFIG.islazyload && window.lazyLoadInstance.update()

  typeof chatBtnFn === 'function' && chatBtnFn()
  typeof panguInit === 'function' && panguInit()

  // google analytics
  typeof gtag === 'function' && gtag('config', '', {'page_path': window.location.pathname});

  // baidu analytics
  typeof _hmt === 'object' && _hmt.push(['_trackPageview',window.location.pathname]);

  typeof loadMeting === 'function' && document.getElementsByClassName('aplayer').length && loadMeting()

  // prismjs
  typeof Prism === 'object' && Prism.highlightAll()

  typeof preloader === 'object' && preloader.endLoading()
})

document.addEventListener('pjax:error', (e) => {
  if (e.request.status === 404) {
    pjax.loadUrl('/404.html')
  }
})</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>